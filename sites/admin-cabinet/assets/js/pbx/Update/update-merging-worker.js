"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2021 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalTranslate, UserMessage */

/**
 * Worker object for checking file merging status.
 *
 * @module mergingCheckWorker
 */
var mergingCheckWorker = {
  /**
   * Time in milliseconds before fetching new request.
   * @type {number}
   */
  timeOut: 3000,

  /**
   * The id of the timer function for the worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * Number of errors encountered during the merging process.
   * @type {number}
   */
  errorCounts: 0,

  /**
   * jQuery object for the progress bar label.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * The ID of the file being merged.
   * @type {string|null}
   */
  fileID: null,

  /**
   * The path of the file being merged.
   * @type {string}
   */
  filePath: '',

  /**
   * Initializes the merging check worker.
   * @param {string} fileID - The ID of the file being merged.
   * @param {string} filePath - The path of the file being merged.
   */
  initialize: function initialize(fileID, filePath) {
    mergingCheckWorker.fileID = fileID;
    mergingCheckWorker.filePath = filePath;
    mergingCheckWorker.restartWorker(fileID);
  },

  /**
   * Restarts the merging check worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(mergingCheckWorker.timeoutHandle);
    mergingCheckWorker.worker();
  },

  /**
   * Worker function for checking file merging status.
   */
  worker: function worker() {
    PbxApi.FilesGetStatusUploadFile(mergingCheckWorker.fileID, mergingCheckWorker.cbAfterResponse);
    mergingCheckWorker.timeoutHandle = window.setTimeout(mergingCheckWorker.worker, mergingCheckWorker.timeOut);
  },

  /**
   * Callback function after receiving a response from the server.
   * @param {Object} response - The response object from the server.
   */
  cbAfterResponse: function cbAfterResponse(response) {
    if (mergingCheckWorker.errorCounts > 10) {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.upd_UploadError);
      UserMessage.showMultiString(globalTranslate.upd_UploadError);
      updatePBX.$submitButton.removeClass('loading');
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    }

    if (response === undefined || Object.keys(response).length === 0) {
      mergingCheckWorker.errorCounts += 1;
      return;
    }

    if (response.d_status === 'UPLOAD_COMPLETE') {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.upd_UpgradeInProgress);
      PbxApi.SystemUpgrade(mergingCheckWorker.filePath, updatePBX.cbAfterStartUpdate);
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    } else if (response.d_status !== undefined) {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.upd_UploadInProgress);
      mergingCheckWorker.errorCounts = 0;
    } else {
      mergingCheckWorker.errorCounts += 1;
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9VcGRhdGUvdXBkYXRlLW1lcmdpbmctd29ya2VyLmpzIl0sIm5hbWVzIjpbIm1lcmdpbmdDaGVja1dvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZXJyb3JDb3VudHMiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsIiQiLCJmaWxlSUQiLCJmaWxlUGF0aCIsImluaXRpYWxpemUiLCJyZXN0YXJ0V29ya2VyIiwid2luZG93IiwiY2xlYXJUaW1lb3V0IiwidGltZW91dEhhbmRsZSIsIndvcmtlciIsIlBieEFwaSIsIkZpbGVzR2V0U3RhdHVzVXBsb2FkRmlsZSIsImNiQWZ0ZXJSZXNwb25zZSIsInNldFRpbWVvdXQiLCJyZXNwb25zZSIsInRleHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJ1cGRfVXBsb2FkRXJyb3IiLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsInVwZGF0ZVBCWCIsIiRzdWJtaXRCdXR0b24iLCJyZW1vdmVDbGFzcyIsInVuZGVmaW5lZCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJkX3N0YXR1cyIsInVwZF9VcGdyYWRlSW5Qcm9ncmVzcyIsIlN5c3RlbVVwZ3JhZGUiLCJjYkFmdGVyU3RhcnRVcGRhdGUiLCJ1cGRfVXBsb2FkSW5Qcm9ncmVzcyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxrQkFBa0IsR0FBRztBQUV2QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxPQUFPLEVBQUUsSUFOYzs7QUFRdkI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFLENBWlE7O0FBY3ZCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFdBQVcsRUFBRSxDQWxCVTs7QUFvQnZCO0FB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OlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjEgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIFBieEFwaSwgZ2xvYmFsVHJhbnNsYXRlLCBVc2VyTWVzc2FnZSAqL1xuXG4vKipcbiAqIFdvcmtlciBvYmplY3QgZm9yIGNoZWNraW5nIGZpbGUgbWVyZ2luZyBzdGF0dXMuXG4gKlxuICogQG1vZHVsZSBtZXJnaW5nQ2hlY2tXb3JrZXJcbiAqL1xuY29uc3QgbWVyZ2luZ0NoZWNrV29ya2VyID0ge1xuXG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGZldGNoaW5nIG5ldyByZXF1ZXN0LlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dDogMzAwMCxcbiAgICBcbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciB0aGUgd29ya2VyLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dEhhbmRsZTogMCxcblxuICAgIC8qKlxuICAgICAqIE51bWJlciBvZiBlcnJvcnMgZW5jb3VudGVyZWQgZHVyaW5nIHRoZSBtZXJnaW5nIHByb2Nlc3MuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBlcnJvckNvdW50czogMCxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBwcm9ncmVzcyBiYXIgbGFiZWwuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXItbGFiZWwnKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBJRCBvZiB0aGUgZmlsZSBiZWluZyBtZXJnZWQuXG4gICAgICogQHR5cGUge3N0cmluZ3xudWxsfVxuICAgICAqL1xuICAgIGZpbGVJRDogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBwYXRoIG9mIHRoZSBmaWxlIGJlaW5nIG1lcmdlZC5cbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIGZpbGVQYXRoOiAnJyxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBtZXJnaW5nIGNoZWNrIHdvcmtlci5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsZUlEIC0gVGhlIElEIG9mIHRoZSBmaWxlIGJlaW5nIG1lcmdlZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGggLSBUaGUgcGF0aCBvZiB0aGUgZmlsZSBiZWluZyBtZXJnZWQuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZShmaWxlSUQsIGZpbGVQYXRoKSB7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5maWxlSUQgPSBmaWxlSUQ7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCA9IGZpbGVQYXRoO1xuICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIucmVzdGFydFdvcmtlcihmaWxlSUQpO1xuICAgIH0sXG5cblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSBtZXJnaW5nIGNoZWNrIHdvcmtlci5cbiAgICAgKi9cbiAgICByZXN0YXJ0V29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KG1lcmdpbmdDaGVja1dvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBXb3JrZXIgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGZpbGUgbWVyZ2luZyBzdGF0dXMuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICBQYnhBcGkuRmlsZXNHZXRTdGF0dXNVcGxvYWRGaWxlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlSUQsIG1lcmdpbmdDaGVja1dvcmtlci5jYkFmdGVyUmVzcG9uc2UpO1xuICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcixcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci50aW1lT3V0LFxuICAgICAgICApO1xuICAgIH0sXG5cblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlci5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0IGZyb20gdGhlIHNlcnZlci5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVzcG9uc2UocmVzcG9uc2UpIHtcbiAgICAgICAgaWYgKG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyA+IDEwKSB7XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEVycm9yKTtcbiAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEVycm9yKTtcbiAgICAgICAgICAgIHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KG1lcmdpbmdDaGVja1dvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzcG9uc2UgPT09IHVuZGVmaW5lZCB8fCBPYmplY3Qua2V5cyhyZXNwb25zZSkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgKz0gMTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzcG9uc2UuZF9zdGF0dXMgPT09ICdVUExPQURfQ09NUExFVEUnKSB7XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUudXBkX1VwZ3JhZGVJblByb2dyZXNzKTtcbiAgICAgICAgICAgIFBieEFwaS5TeXN0ZW1VcGdyYWRlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCwgdXBkYXRlUEJYLmNiQWZ0ZXJTdGFydFVwZGF0ZSk7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KG1lcmdpbmdDaGVja1dvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kX3N0YXR1cyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEluUHJvZ3Jlc3MpO1xuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmVycm9yQ291bnRzID0gMDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyArPSAxO1xuICAgICAgICB9XG4gICAgfSxcbn07Il19
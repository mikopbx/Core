"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalPBXVersion, globalTranslate,
globalWebAdminLanguage, showdown, UserMessage, upgradeStatusLoopWorker, Config */
var updatePBX = {
  $formObj: $('#upgrade-form'),
  $submitButton: $('#submitbutton'),
  $progressBar: $('#upload-progress-bar'),
  $progressBarLabel: $('#upload-progress-bar').find('.label'),
  currentVersion: globalPBXVersion,
  $restoreModalForm: $('#update-modal-form'),
  upgradeInProgress: false,
  converter: new showdown.Converter(),
  initialize: function initialize() {
    updatePBX.$restoreModalForm.modal();
    updatePBX.$submitButton.addClass('disabled');
    $('input:text, .ui.button', '.ui.action.input').on('click', function (e) {
      $('input:file', $(e.target).parents()).click();
    });
    $('input:file', '.ui.action.input').on('change', function (e) {
      if (e.target.files[0] !== undefined) {
        var filename = e.target.files[0].name;
        $('input:text', $(e.target).parent()).val(filename);
        updatePBX.$submitButton.removeClass('disabled');
      }
    });
    updatePBX.$submitButton.on('click', function (e) {
      e.preventDefault();
      if (updatePBX.$submitButton.hasClass('loading') || updatePBX.upgradeInProgress) return;
      updatePBX.$formObj.form({
        on: 'blur',
        fields: updatePBX.validateRules,
        onSuccess: function onSuccess() {
          updatePBX.$restoreModalForm.modal({
            closable: false,
            onDeny: function onDeny() {
              return true;
            },
            onApprove: function onApprove() {
              updatePBX.$submitButton.addClass('loading');
              updatePBX.upgradeInProgress = true;
              var data = $('input:file')[0].files[0];
              PbxApi.FilesUploadFile(data, updatePBX.cbResumableUploadFile);
              return true;
            }
          }).modal('show');
        }
      });
      updatePBX.$formObj.form('validate form');
    });
    var requestData = {
      PBXVER: globalPBXVersion,
      LANGUAGE: globalWebAdminLanguage
    };
    $.api({
      url: "".concat(Config.updateUrl, "checkNewFirmware"),
      on: 'now',
      method: 'POST',
      data: requestData,
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0 && response.result === 'SUCCESS';
      },
      onSuccess: function onSuccess(response) {
        var currentVerison = updatePBX.currentVersion.replace('-dev', '');
        response.firmware.forEach(function (obj) {
          var version = obj.version.replace('-dev', '');

          if (versionCompare(version, currentVerison) > 0) {
            updatePBX.addNewVersionInformation(obj);
          }
        });
        $('a.redo').on('click', function (e) {
          e.preventDefault();
          if (updatePBX.$submitButton.hasClass('loading') || updatePBX.upgradeInProgress) return;
          updatePBX.$restoreModalForm.modal({
            closable: false,
            onDeny: function onDeny() {
              return true;
            },
            onApprove: function onApprove() {
              var params = [];
              var $aLink = $(e.target).closest('a');
              params.updateLink = $aLink.attr('href');
              params.md5 = $aLink.attr('data-md5');
              params.version = $aLink.attr('data-version');
              params.size = $aLink.attr('data-size');
              $aLink.find('i').addClass('loading');
              updatePBX.upgradeInProgress = true;
              PbxApi.FilesDownloadNewFirmware(params, updatePBX.cbAfterStartDownloadFirmware);
              return true;
            }
          }).modal('show');
        });
      }
    });
  },

  /**
   * Upload file by chunks
   * @param action
   * @param params
   */
  cbResumableUploadFile: function cbResumableUploadFile(action, params) {
    switch (action) {
      case 'fileSuccess':
        updatePBX.checkStatusFileMerging(params.response);
        break;

      case 'uploadStart':
        updatePBX.$submitButton.addClass('loading');
        updatePBX.$progressBar.show();
        updatePBX.$progressBarLabel.text(globalTranslate.upd_UploadInProgress);
        break;

      case 'progress':
        updatePBX.$progressBar.progress({
          percent: parseInt(params.percent, 10)
        });
        break;

      case 'error':
        updatePBX.$progressBarLabel.text(globalTranslate.upd_UploadError);
        updatePBX.$submitButton.removeClass('loading');
        UserMessage.showMultiString(globalTranslate.upd_UploadError);
        break;

      default:
    }
  },

  /**
   * Wait for file ready to use
   *
   * @param response ответ функции /pbxcore/api/upload/status
   */
  checkStatusFileMerging: function checkStatusFileMerging(response) {
    if (response === undefined || PbxApi.tryParseJSON(response) === false) {
      UserMessage.showMultiString("".concat(globalTranslate.upd_UploadError));
      return;
    }

    var json = JSON.parse(response);

    if (json === undefined || json.data === undefined) {
      UserMessage.showMultiString("".concat(globalTranslate.upd_UploadError));
      return;
    }

    var fileID = json.data.upload_id;
    var filePath = json.data.filename; // Wait until system glued all parts of file

    mergingCheckWorker.initialize(fileID, filePath);
  },

  /**
   * Callback after start PBX upgrading
   * @param response
   */
  cbAfterStartUpdate: function cbAfterStartUpdate(response) {
    if (response.length === 0 || response === false) {
      UserMessage.showMultiString(globalTranslate.upd_UpgradeError);
      updatePBX.$submitButton.removeClass('loading');
    }
  },

  /**
   * After start online upgrade we have to wait an answer,
   * and then start status check worker
   */
  cbAfterStartDownloadFirmware: function cbAfterStartDownloadFirmware(response) {
    if (response.filename !== undefined) {
      upgradeStatusLoopWorker.initialize(response.filename);
    } else {
      updatePBX.upgradeInProgress = false;
      $('i.loading.redo').removeClass('loading');
    }
  },

  /**
   * Add new block of update information on page
   */
  addNewVersionInformation: function addNewVersionInformation(obj) {
    $('#online-updates-block').show();
    var markdownText = decodeURIComponent(obj.description);
    markdownText = markdownText.replace(/<br>/g, '\r');
    markdownText = markdownText.replace(/<br >/g, '\r');
    markdownText = markdownText.replace(/\* \*/g, '*');
    markdownText = markdownText.replace(/\*\*/g, '*');
    var html = updatePBX.converter.makeHtml(markdownText);
    var dymanicRow = "\n\t\t\t<tr class=\"update-row\">\n\t\t\t<td class=\"center aligned\">".concat(obj.version, "</td>\n\t\t\t<td>").concat(html, "</td>\n\t\t\t<td class=\"right aligned collapsing\">\n    \t\t<div class=\"ui small basic icon buttons action-buttons\">\n    \t\t\t<a href=\"").concat(obj.href, "\" class=\"ui button redo popuped\" \n    \t\t\t\tdata-content = \"").concat(globalTranslate.bt_ToolTipUpgradeOnline, "\"\n\t\t\t\t\tdata-md5 =\"").concat(obj.md5, "\" data-size =\"").concat(obj.size, "\"\n\t\t\t\t\tdata-version = \"").concat(obj.version, "\" >\n\t\t\t\t\t<i class=\"icon redo blue\"></i>\n\t\t\t\t\t<span class=\"percent\"></span>\n\t\t\t\t</a>\n\t\t\t\t<a href=\"").concat(obj.href, "\" class=\"ui button download popuped\" \n\t\t\t\t\tdata-content = \"").concat(globalTranslate.bt_ToolTipDownload, "\"\n\t\t\t\t\tdata-md5 =\"").concat(obj.md5, "\" data-size =\"").concat(obj.size, "\">\n\t\t\t\t\t<i class=\"icon download blue\"></i>\n\t\t\t\t</a>\n    \t\t</div>   \n\t</tr>");
    $('#updates-table tbody').append(dymanicRow);
    $('a.popuped').popup();
  }
};
$(document).ready(function () {
  updatePBX.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9VcGRhdGUvdXBkYXRlLWluZGV4LmpzIl0sIm5hbWVzIjpbInVwZGF0ZVBCWCIsIiRmb3JtT2JqIiwiJCIsIiRzdWJtaXRCdXR0b24iLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsImZpbmQiLCJjdXJyZW50VmVyc2lvbiIsImdsb2JhbFBCWFZlcnNpb24iLCIkcmVzdG9yZU1vZGFsRm9ybSIsInVwZ3JhZGVJblByb2dyZXNzIiwiY29udmVydGVyIiwic2hvd2Rvd24iLCJDb252ZXJ0ZXIiLCJpbml0aWFsaXplIiwibW9kYWwiLCJhZGRDbGFzcyIsIm9uIiwiZSIsInRhcmdldCIsInBhcmVudHMiLCJjbGljayIsImZpbGVzIiwidW5kZWZpbmVkIiwiZmlsZW5hbWUiLCJuYW1lIiwicGFyZW50IiwidmFsIiwicmVtb3ZlQ2xhc3MiLCJwcmV2ZW50RGVmYXVsdCIsImhhc0NsYXNzIiwiZm9ybSIsImZpZWxkcyIsInZhbGlkYXRlUnVsZXMiLCJvblN1Y2Nlc3MiLCJjbG9zYWJsZSIsIm9uRGVueSIsIm9uQXBwcm92ZSIsImRhdGEiLCJQYnhBcGkiLCJGaWxlc1VwbG9hZEZpbGUiLCJjYlJlc3VtYWJsZVVwbG9hZEZpbGUiLCJyZXF1ZXN0RGF0YSIsIlBCWFZFUiIsIkxBTkdVQUdFIiwiZ2xvYmFsV2ViQWRtaW5MYW5ndWFnZSIsImFwaSIsInVybCIsIkNvbmZpZyIsInVwZGF0ZVVybCIsIm1ldGhvZCIsInN1Y2Nlc3NUZXN0IiwicmVzcG9uc2UiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwicmVzdWx0IiwiY3VycmVudFZlcmlzb24iLCJyZXBsYWNlIiwiZmlybXdhcmUiLCJmb3JFYWNoIiwib2JqIiwidmVyc2lvbiIsInZlcnNpb25Db21wYXJlIiwiYWRkTmV3VmVyc2lvbkluZm9ybWF0aW9uIiwicGFyYW1zIiwiJGFMaW5rIiwiY2xvc2VzdCIsInVwZGF0ZUxpbmsiLCJhdHRyIiwibWQ1Iiwic2l6ZSIsIkZpbGVzRG93bmxvYWROZXdGaXJtd2FyZSIsImNiQWZ0ZXJTdGFydERvd25sb2FkRmlybXdhcmUiLCJhY3Rpb24iLCJjaGVja1N0YXR1c0ZpbGVNZXJnaW5nIiwic2hvdyIsInRleHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJ1cGRfVXBsb2FkSW5Qcm9ncmVzcyIsInByb2dyZXNzIiwicGVyY2VudCIsInBhcnNlSW50IiwidXBkX1VwbG9hZEVycm9yIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJ0cnlQYXJzZUpTT04iLCJqc29uIiwiSlNPTiIsInBhcnNlIiwiZmlsZUlEIiwidXBsb2FkX2lkIiwiZmlsZVBhdGgiLCJtZXJnaW5nQ2hlY2tXb3JrZXIiLCJjYkFmdGVyU3RhcnRVcGRhdGUiLCJ1cGRfVXBncmFkZUVycm9yIiwidXBncmFkZVN0YXR1c0xvb3BXb3JrZXIiLCJtYXJrZG93blRleHQiLCJkZWNvZGVVUklDb21wb25lbnQiLCJkZXNjcmlwdGlvbiIsImh0bWwiLCJtYWtlSHRtbCIsImR5bWFuaWNSb3ciLCJocmVmIiwiYnRfVG9vbFRpcFVwZ3JhZGVPbmxpbmUiLCJidF9Ub29sVGlwRG93bmxvYWQiLCJhcHBlbmQiLCJwb3B1cCIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBRUEsSUFBTUEsU0FBUyxHQUFHO0FBQ2pCQyxFQUFBQSxRQUFRLEVBQUVDLENBQUMsQ0FBQyxlQUFELENBRE07QUFFakJDLEVBQUFBLGFBQWEsRUFBRUQsQ0FBQyxDQUFDLGVBQUQsQ0FGQztBQUdqQkUsRUFBQUEsWUFBWSxFQUFFRixDQUFDLENBQUMsc0JBQUQsQ0FIRTtBQUlqQkcsRUFBQUEsaUJBQWlCLEVBQUVILENBQUMsQ0FBQyxzQkFBRCxDQUFELENBQTBCSSxJQUExQixDQUErQixRQUEvQixDQUpGO0FBS2pCQyxFQUFB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Q0FBMEJ3RyxNQUExQixDQUFpQ0osVUFBakM7QUFDQXBHLElBQUFBLENBQUMsQ0FBQyxXQUFELENBQUQsQ0FBZXlHLEtBQWY7QUFDQTtBQTVNZ0IsQ0FBbEI7QUFnTkF6RyxDQUFDLENBQUMwRyxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCN0csRUFBQUEsU0FBUyxDQUFDYyxVQUFWO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgUGJ4QXBpLCBnbG9iYWxQQlhWZXJzaW9uLCBnbG9iYWxUcmFuc2xhdGUsXG5nbG9iYWxXZWJBZG1pbkxhbmd1YWdlLCBzaG93ZG93biwgVXNlck1lc3NhZ2UsIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLCBDb25maWcgKi9cblxuY29uc3QgdXBkYXRlUEJYID0ge1xuXHQkZm9ybU9iajogJCgnI3VwZ3JhZGUtZm9ybScpLFxuXHQkc3VibWl0QnV0dG9uOiAkKCcjc3VibWl0YnV0dG9uJyksXG5cdCRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblx0JHByb2dyZXNzQmFyTGFiZWw6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyJykuZmluZCgnLmxhYmVsJyksXG5cdGN1cnJlbnRWZXJzaW9uOiBnbG9iYWxQQlhWZXJzaW9uLFxuXHQkcmVzdG9yZU1vZGFsRm9ybTogJCgnI3VwZGF0ZS1tb2RhbC1mb3JtJyksXG5cdHVwZ3JhZGVJblByb2dyZXNzOiBmYWxzZSxcblx0Y29udmVydGVyOiBuZXcgc2hvd2Rvd24uQ29udmVydGVyKCksXG5cdGluaXRpYWxpemUoKSB7XG5cdFx0dXBkYXRlUEJYLiRyZXN0b3JlTW9kYWxGb3JtLm1vZGFsKCk7XG5cdFx0dXBkYXRlUEJYLiRzdWJtaXRCdXR0b24uYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0JCgnaW5wdXQ6dGV4dCwgLnVpLmJ1dHRvbicsICcudWkuYWN0aW9uLmlucHV0Jykub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdCQoJ2lucHV0OmZpbGUnLCAkKGUudGFyZ2V0KS5wYXJlbnRzKCkpLmNsaWNrKCk7XG5cdFx0fSk7XG5cblx0XHQkKCdpbnB1dDpmaWxlJywgJy51aS5hY3Rpb24uaW5wdXQnKS5vbignY2hhbmdlJywgKGUpID0+IHtcblx0XHRcdGlmIChlLnRhcmdldC5maWxlc1swXSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdGNvbnN0IGZpbGVuYW1lID0gZS50YXJnZXQuZmlsZXNbMF0ubmFtZTtcblx0XHRcdFx0JCgnaW5wdXQ6dGV4dCcsICQoZS50YXJnZXQpLnBhcmVudCgpKS52YWwoZmlsZW5hbWUpO1xuXHRcdFx0XHR1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHR1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0aWYgKHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLmhhc0NsYXNzKCdsb2FkaW5nJykgfHwgdXBkYXRlUEJYLnVwZ3JhZGVJblByb2dyZXNzKSByZXR1cm47XG5cblx0XHRcdHVwZGF0ZVBCWC4kZm9ybU9ialxuXHRcdFx0XHQuZm9ybSh7XG5cdFx0XHRcdFx0b246ICdibHVyJyxcblx0XHRcdFx0XHRmaWVsZHM6IHVwZGF0ZVBCWC52YWxpZGF0ZVJ1bGVzLFxuXHRcdFx0XHRcdG9uU3VjY2VzcygpIHtcblx0XHRcdFx0XHRcdHVwZGF0ZVBCWC4kcmVzdG9yZU1vZGFsRm9ybVxuXHRcdFx0XHRcdFx0XHQubW9kYWwoe1xuXHRcdFx0XHRcdFx0XHRcdGNsb3NhYmxlOiBmYWxzZSxcblx0XHRcdFx0XHRcdFx0XHRvbkRlbnk6ICgpID0+IHRydWUsXG5cdFx0XHRcdFx0XHRcdFx0b25BcHByb3ZlOiAoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHR1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHRcdFx0XHRcdFx0dXBkYXRlUEJYLnVwZ3JhZGVJblByb2dyZXNzID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IGRhdGEgPSAkKCdpbnB1dDpmaWxlJylbMF0uZmlsZXNbMF07XG5cdFx0XHRcdFx0XHRcdFx0XHRQYnhBcGkuRmlsZXNVcGxvYWRGaWxlKGRhdGEsIHVwZGF0ZVBCWC5jYlJlc3VtYWJsZVVwbG9hZEZpbGUpO1xuXHRcdFx0XHRcdFx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRcdFx0Lm1vZGFsKCdzaG93Jyk7XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0fSk7XG5cdFx0XHR1cGRhdGVQQlguJGZvcm1PYmouZm9ybSgndmFsaWRhdGUgZm9ybScpO1xuXHRcdH0pO1xuXHRcdGNvbnN0IHJlcXVlc3REYXRhID0ge1xuXHRcdFx0UEJYVkVSOiBnbG9iYWxQQlhWZXJzaW9uLFxuXHRcdFx0TEFOR1VBR0U6IGdsb2JhbFdlYkFkbWluTGFuZ3VhZ2UsXG5cdFx0fTtcblx0XHQkLmFwaSh7XG5cdFx0XHR1cmw6IGAke0NvbmZpZy51cGRhdGVVcmx9Y2hlY2tOZXdGaXJtd2FyZWAsXG5cdFx0XHRvbjogJ25vdycsXG5cdFx0XHRtZXRob2Q6ICdQT1NUJyxcblx0XHRcdGRhdGE6IHJlcXVlc3REYXRhLFxuXHRcdFx0c3VjY2Vzc1Rlc3QocmVzcG9uc2UpIHtcblx0XHRcdFx0Ly8gdGVzdCB3aGV0aGVyIGEgSlNPTiByZXNwb25zZSBpcyB2YWxpZFxuXHRcdFx0XHRyZXR1cm4gcmVzcG9uc2UgIT09IHVuZGVmaW5lZFxuXHRcdFx0XHRcdCYmIE9iamVjdC5rZXlzKHJlc3BvbnNlKS5sZW5ndGggPiAwXG5cdFx0XHRcdFx0JiYgcmVzcG9uc2UucmVzdWx0ID09PSAnU1VDQ0VTUyc7XG5cdFx0XHR9LFxuXHRcdFx0b25TdWNjZXNzKHJlc3BvbnNlKSB7XG5cdFx0XHRcdGNvbnN0IGN1cnJlbnRWZXJpc29uID0gdXBkYXRlUEJYLmN1cnJlbnRWZXJzaW9uLnJlcGxhY2UoJy1kZXYnLCAnJyk7XG5cdFx0XHRcdHJlc3BvbnNlLmZpcm13YXJlLmZvckVhY2goKG9iaikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHZlcnNpb24gPSBvYmoudmVyc2lvbi5yZXBsYWNlKCctZGV2JywgJycpO1xuXHRcdFx0XHRcdGlmICh2ZXJzaW9uQ29tcGFyZSh2ZXJzaW9uLCBjdXJyZW50VmVyaXNvbikgPiAwKSB7XG5cdFx0XHRcdFx0XHR1cGRhdGVQQlguYWRkTmV3VmVyc2lvbkluZm9ybWF0aW9uKG9iaik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHQkKCdhLnJlZG8nKS5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0XHRpZiAodXBkYXRlUEJYLiRzdWJtaXRCdXR0b24uaGFzQ2xhc3MoJ2xvYWRpbmcnKSB8fCB1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MpIHJldHVybjtcblx0XHRcdFx0XHR1cGRhdGVQQlguJHJlc3RvcmVNb2RhbEZvcm1cblx0XHRcdFx0XHRcdC5tb2RhbCh7XG5cdFx0XHRcdFx0XHRcdGNsb3NhYmxlOiBmYWxzZSxcblx0XHRcdFx0XHRcdFx0b25EZW55OiAoKSA9PiB0cnVlLFxuXHRcdFx0XHRcdFx0XHRvbkFwcHJvdmU6ICgpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCBwYXJhbXMgPSBbXTtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCAkYUxpbmsgPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCdhJyk7XG5cdFx0XHRcdFx0XHRcdFx0cGFyYW1zLnVwZGF0ZUxpbmsgPSAkYUxpbmsuYXR0cignaHJlZicpO1xuXHRcdFx0XHRcdFx0XHRcdHBhcmFtcy5tZDUgPSAkYUxpbmsuYXR0cignZGF0YS1tZDUnKTtcblx0XHRcdFx0XHRcdFx0XHRwYXJhbXMudmVyc2lvbiA9ICRhTGluay5hdHRyKCdkYXRhLXZlcnNpb24nKTtcblx0XHRcdFx0XHRcdFx0XHRwYXJhbXMuc2l6ZSA9ICRhTGluay5hdHRyKCdkYXRhLXNpemUnKTtcblx0XHRcdFx0XHRcdFx0XHQkYUxpbmsuZmluZCgnaScpLmFkZENsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdFx0XHRcdFx0dXBkYXRlUEJYLnVwZ3JhZGVJblByb2dyZXNzID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHRQYnhBcGkuRmlsZXNEb3dubG9hZE5ld0Zpcm13YXJlKHBhcmFtcywgdXBkYXRlUEJYLmNiQWZ0ZXJTdGFydERvd25sb2FkRmlybXdhcmUpO1xuXHRcdFx0XHRcdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRcdC5tb2RhbCgnc2hvdycpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cdFx0fSk7XG5cdH0sXG5cdC8qKlxuXHQgKiBVcGxvYWQgZmlsZSBieSBjaHVua3Ncblx0ICogQHBhcmFtIGFjdGlvblxuXHQgKiBAcGFyYW0gcGFyYW1zXG5cdCAqL1xuXHRjYlJlc3VtYWJsZVVwbG9hZEZpbGUoYWN0aW9uLCBwYXJhbXMpe1xuXHRcdHN3aXRjaCAoYWN0aW9uKSB7XG5cdFx0XHRjYXNlICdmaWxlU3VjY2Vzcyc6XG5cdFx0XHRcdHVwZGF0ZVBCWC5jaGVja1N0YXR1c0ZpbGVNZXJnaW5nKHBhcmFtcy5yZXNwb25zZSk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAndXBsb2FkU3RhcnQnOlxuXHRcdFx0XHR1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHR1cGRhdGVQQlguJHByb2dyZXNzQmFyLnNob3coKTtcblx0XHRcdFx0dXBkYXRlUEJYLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLnVwZF9VcGxvYWRJblByb2dyZXNzKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICdwcm9ncmVzcyc6XG5cdFx0XHRcdHVwZGF0ZVBCWC4kcHJvZ3Jlc3NCYXIucHJvZ3Jlc3Moe1xuXHRcdFx0XHRcdHBlcmNlbnQ6IHBhcnNlSW50KHBhcmFtcy5wZXJjZW50LCAxMCksXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJ2Vycm9yJzpcblx0XHRcdFx0dXBkYXRlUEJYLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLnVwZF9VcGxvYWRFcnJvcik7XG5cdFx0XHRcdHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEVycm9yKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRkZWZhdWx0OlxuXG5cblx0XHR9XG5cdH0sXG5cdC8qKlxuXHQgKiBXYWl0IGZvciBmaWxlIHJlYWR5IHRvIHVzZVxuXHQgKlxuXHQgKiBAcGFyYW0gcmVzcG9uc2Ug0L7RgtCy0LXRgiDRhNGD0L3QutGG0LjQuCAvcGJ4Y29yZS9hcGkvdXBsb2FkL3N0YXR1c1xuXHQgKi9cblx0Y2hlY2tTdGF0dXNGaWxlTWVyZ2luZyhyZXNwb25zZSkge1xuXHRcdGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IFBieEFwaS50cnlQYXJzZUpTT04ocmVzcG9uc2UpID09PSBmYWxzZSkge1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGAke2dsb2JhbFRyYW5zbGF0ZS51cGRfVXBsb2FkRXJyb3J9YCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKHJlc3BvbnNlKTtcblx0XHRpZiAoanNvbiA9PT0gdW5kZWZpbmVkIHx8IGpzb24uZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoYCR7Z2xvYmFsVHJhbnNsYXRlLnVwZF9VcGxvYWRFcnJvcn1gKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3QgZmlsZUlEID0ganNvbi5kYXRhLnVwbG9hZF9pZDtcblx0XHRjb25zdCBmaWxlUGF0aCA9IGpzb24uZGF0YS5maWxlbmFtZTtcblx0XHQvLyBXYWl0IHVudGlsIHN5c3RlbSBnbHVlZCBhbGwgcGFydHMgb2YgZmlsZVxuXHRcdG1lcmdpbmdDaGVja1dvcmtlci5pbml0aWFsaXplKGZpbGVJRCwgZmlsZVBhdGgpO1xuXHR9LFxuXG5cdC8qKlxuXHQgKiBDYWxsYmFjayBhZnRlciBzdGFydCBQQlggdXBncmFkaW5nXG5cdCAqIEBwYXJhbSByZXNwb25zZVxuXHQgKi9cblx0Y2JBZnRlclN0YXJ0VXBkYXRlKHJlc3BvbnNlKSB7XG5cdFx0aWYgKHJlc3BvbnNlLmxlbmd0aCA9PT0gMCB8fCByZXNwb25zZSA9PT0gZmFsc2UpIHtcblx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhnbG9iYWxUcmFuc2xhdGUudXBkX1VwZ3JhZGVFcnJvcik7XG5cdFx0XHR1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuXHRcdH1cblx0fSxcblx0LyoqXG5cdCAqIEFmdGVyIHN0YXJ0IG9ubGluZSB1cGdyYWRlIHdlIGhhdmUgdG8gd2FpdCBhbiBhbnN3ZXIsXG5cdCAqIGFuZCB0aGVuIHN0YXJ0IHN0YXR1cyBjaGVjayB3b3JrZXJcblx0ICovXG5cdGNiQWZ0ZXJTdGFydERvd25sb2FkRmlybXdhcmUocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2UuZmlsZW5hbWUgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0dXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaW5pdGlhbGl6ZShyZXNwb25zZS5maWxlbmFtZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHVwZGF0ZVBCWC51cGdyYWRlSW5Qcm9ncmVzcyA9IGZhbHNlO1xuXHRcdFx0JCgnaS5sb2FkaW5nLnJlZG8nKS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuXHRcdH1cblx0fSxcblx0LyoqXG5cdCAqIEFkZCBuZXcgYmxvY2sgb2YgdXBkYXRlIGluZm9ybWF0aW9uIG9uIHBhZ2Vcblx0ICovXG5cdGFkZE5ld1ZlcnNpb25JbmZvcm1hdGlvbihvYmopIHtcblx0XHQkKCcjb25saW5lLXVwZGF0ZXMtYmxvY2snKS5zaG93KCk7XG5cdFx0bGV0IG1hcmtkb3duVGV4dCA9IGRlY29kZVVSSUNvbXBvbmVudChvYmouZGVzY3JpcHRpb24pO1xuXHRcdG1hcmtkb3duVGV4dCA9IG1hcmtkb3duVGV4dC5yZXBsYWNlKC88YnI+L2csICdcXHInKTtcblx0XHRtYXJrZG93blRleHQgPSBtYXJrZG93blRleHQucmVwbGFjZSgvPGJyID4vZywgJ1xccicpO1xuXHRcdG1hcmtkb3duVGV4dCA9IG1hcmtkb3duVGV4dC5yZXBsYWNlKC9cXCogXFwqL2csICcqJyk7XG5cdFx0bWFya2Rvd25UZXh0ID0gbWFya2Rvd25UZXh0LnJlcGxhY2UoL1xcKlxcKi9nLCAnKicpO1xuXHRcdGNvbnN0IGh0bWwgPSB1cGRhdGVQQlguY29udmVydGVyLm1ha2VIdG1sKG1hcmtkb3duVGV4dCk7XG5cdFx0Y29uc3QgZHltYW5pY1JvdyA9IGBcblx0XHRcdDx0ciBjbGFzcz1cInVwZGF0ZS1yb3dcIj5cblx0XHRcdDx0ZCBjbGFzcz1cImNlbnRlciBhbGlnbmVkXCI+JHtvYmoudmVyc2lvbn08L3RkPlxuXHRcdFx0PHRkPiR7aHRtbH08L3RkPlxuXHRcdFx0PHRkIGNsYXNzPVwicmlnaHQgYWxpZ25lZCBjb2xsYXBzaW5nXCI+XG4gICAgXHRcdDxkaXYgY2xhc3M9XCJ1aSBzbWFsbCBiYXNpYyBpY29uIGJ1dHRvbnMgYWN0aW9uLWJ1dHRvbnNcIj5cbiAgICBcdFx0XHQ8YSBocmVmPVwiJHtvYmouaHJlZn1cIiBjbGFzcz1cInVpIGJ1dHRvbiByZWRvIHBvcHVwZWRcIiBcbiAgICBcdFx0XHRcdGRhdGEtY29udGVudCA9IFwiJHtnbG9iYWxUcmFuc2xhdGUuYnRfVG9vbFRpcFVwZ3JhZGVPbmxpbmV9XCJcblx0XHRcdFx0XHRkYXRhLW1kNSA9XCIke29iai5tZDV9XCIgZGF0YS1zaXplID1cIiR7b2JqLnNpemV9XCJcblx0XHRcdFx0XHRkYXRhLXZlcnNpb24gPSBcIiR7b2JqLnZlcnNpb259XCIgPlxuXHRcdFx0XHRcdDxpIGNsYXNzPVwiaWNvbiByZWRvIGJsdWVcIj48L2k+XG5cdFx0XHRcdFx0PHNwYW4gY2xhc3M9XCJwZXJjZW50XCI+PC9zcGFuPlxuXHRcdFx0XHQ8L2E+XG5cdFx0XHRcdDxhIGhyZWY9XCIke29iai5ocmVmfVwiIGNsYXNzPVwidWkgYnV0dG9uIGRvd25sb2FkIHBvcHVwZWRcIiBcblx0XHRcdFx0XHRkYXRhLWNvbnRlbnQgPSBcIiR7Z2xvYmFsVHJhbnNsYXRlLmJ0X1Rvb2xUaXBEb3dubG9hZH1cIlxuXHRcdFx0XHRcdGRhdGEtbWQ1ID1cIiR7b2JqLm1kNX1cIiBkYXRhLXNpemUgPVwiJHtvYmouc2l6ZX1cIj5cblx0XHRcdFx0XHQ8aSBjbGFzcz1cImljb24gZG93bmxvYWQgYmx1ZVwiPjwvaT5cblx0XHRcdFx0PC9hPlxuICAgIFx0XHQ8L2Rpdj4gICBcblx0PC90cj5gO1xuXHRcdCQoJyN1cGRhdGVzLXRhYmxlIHRib2R5JykuYXBwZW5kKGR5bWFuaWNSb3cpO1xuXHRcdCQoJ2EucG9wdXBlZCcpLnBvcHVwKCk7XG5cdH0sXG59O1xuXG5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcblx0dXBkYXRlUEJYLmluaXRpYWxpemUoKTtcbn0pO1xuXG4iXX0=
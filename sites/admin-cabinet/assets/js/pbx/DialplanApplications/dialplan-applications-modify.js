"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl,globalTranslate, ace, Form, Extensions */

/**
 * The DialplanApplication object.
 *  Manages the operations and behaviors of the Dialplan applications in the UI.
 *
 * @module DialplanApplication
 */
var dialplanApplication = {
  $number: $('#extension'),
  defaultExtension: '',

  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#dialplan-application-form'),
  $typeSelectDropDown: $('#dialplan-application-form .type-select'),
  $tabMenuItems: $('#application-code-menu .item'),
  // Ace editor instance
  editor: '',

  /**
   * Validation rules for the form fields before submission.
   *
   * @type {object}
   */
  validateRules: {
    name: {
      identifier: 'name',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.da_ValidateNameIsEmpty
      }]
    },
    extension: {
      identifier: 'extension',
      rules: [{
        type: 'regExp',
        value: '/^(|[0-9#+\\*|X]{1,64})$/',
        prompt: globalTranslate.da_ValidateExtensionNumber
      }, {
        type: 'empty',
        prompt: globalTranslate.da_ValidateExtensionIsEmpty
      }, {
        type: 'existRule[extension-error]',
        prompt: globalTranslate.da_ValidateExtensionDouble
      }]
    }
  },

  /**
   * Initializes the DialplanApplication.
   * Sets up tabs, dropdowns, form and Ace editor.
   * Sets up change handlers for extension number and editor contents.
   */
  initialize: function initialize() {
    dialplanApplication.$tabMenuItems.tab();

    if (dialplanApplication.$formObj.form('get value', 'name').length === 0) {
      dialplanApplication.$tabMenuItems.tab('change tab', 'main');
    }

    dialplanApplication.$typeSelectDropDown.dropdown({
      onChange: dialplanApplication.changeAceMode
    }); // Add handler to dynamically check if the input number is available

    dialplanApplication.$number.on('change', function () {
      var newNumber = dialplanApplication.$formObj.form('get value', 'extension');
      Extensions.checkAvailability(dialplanApplication.defaultExtension, newNumber);
    }); // Initialize UI components

    dialplanApplication.initializeForm();
    dialplanApplication.initializeAce();
    dialplanApplication.changeAceMode();
    dialplanApplication.defaultExtension = dialplanApplication.$formObj.form('get value', 'extension');
  },

  /**
   * Initializes the Ace editor instance.
   * Sets up Ace editor with a monokai theme and custom options.
   * Attaches change handler to the editor session.
   */
  initializeAce: function initializeAce() {
    var applicationLogic = dialplanApplication.$formObj.form('get value', 'applicationlogic');
    var aceHeight = window.innerHeight - 380;
    var rowsCount = Math.round(aceHeight / 16.3);
    $(window).load(function () {
      $('.application-code').css('min-height', "".concat(aceHeight, "px"));
    });
    dialplanApplication.editor = ace.edit('application-code');
    dialplanApplication.editor.getSession().setValue(applicationLogic);
    dialplanApplication.editor.setTheme('ace/theme/monokai');
    dialplanApplication.editor.resize();
    dialplanApplication.editor.getSession().on('change', function () {
      // Trigger change event to acknowledge the modification
      Form.dataChanged();
    });
    dialplanApplication.editor.setOptions({
      maxLines: rowsCount,
      showPrintMargin: false,
      showLineNumbers: false
    });
  },

  /**
   * Changes the Ace editor mode and settings based on the 'type' form value.
   * If the 'type' is 'php', PHP mode is set, and line numbers are shown.
   * Otherwise, Julia mode is set, and line numbers are hidden.
   * The editor theme is set to Monokai in all cases.
   */
  changeAceMode: function changeAceMode() {
    // Retrieve 'type' value from the form
    var mode = dialplanApplication.$formObj.form('get value', 'type');
    var NewMode;

    if (mode === 'php') {
      // If 'type' is 'php', set the editor mode to PHP and show line numbers
      NewMode = ace.require('ace/mode/php').Mode;
      dialplanApplication.editor.setOptions({
        showLineNumbers: true
      });
    } else {
      // If 'type' is not 'php', set the editor mode to Julia and hide line numbers
      NewMode = ace.require('ace/mode/julia').Mode;
      dialplanApplication.editor.setOptions({
        showLineNumbers: false
      });
    } // Set the new mode and theme for the editor


    dialplanApplication.editor.session.setMode(new NewMode());
    dialplanApplication.editor.setTheme('ace/theme/monokai');
  },

  /**
   * Callback function to be called before the form is sent
   * @param {Object} settings - The current settings of the form
   * @returns {Object} - The updated settings of the form
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = dialplanApplication.$formObj.form('get values');
    result.data.applicationlogic = dialplanApplication.editor.getValue();
    return result;
  },

  /**
   * Callback function to be called after the form has been sent.
   * @param {Object} response - The response from the server after the form is sent
   */
  cbAfterSendForm: function cbAfterSendForm(response) {},

  /**
   * Initialize the form with custom settings
   */
  initializeForm: function initializeForm() {
    Form.$formObj = dialplanApplication.$formObj;
    Form.url = "".concat(globalRootUrl, "dialplan-applications/save"); // Form submission URL

    Form.validateRules = dialplanApplication.validateRules; // Form validation rules

    Form.cbBeforeSendForm = dialplanApplication.cbBeforeSendForm; // Callback before form is sent

    Form.cbAfterSendForm = dialplanApplication.cbAfterSendForm; // Callback after form is sent

    Form.initialize();
  }
};
/**
 * Checks if the number is taken by another account
 * @returns {boolean} True if the parameter has the 'hidden' class, false otherwise
 */

$.fn.form.settings.rules.existRule = function (value, parameter) {
  return $("#".concat(parameter)).hasClass('hidden');
};
/**
 *  Initialize Dialplan Application modify form on document ready
 */


$(document).ready(function () {
  dialplanApplication.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9EaWFscGxhbkFwcGxpY2F0aW9ucy9kaWFscGxhbi1hcHBsaWNhdGlvbnMtbW9kaWZ5LmpzIl0sIm5hbWVzIjpbImRpYWxwbGFuQXBwbGljYXRpb24iLCIkbnVtYmVyIiwiJCIsImRlZmF1bHRFeHRlbnNpb24iLCIkZm9ybU9iaiIsIiR0eXBlU2VsZWN0RHJvcERvd24iLCIkdGFiTWVudUl0ZW1zIiwiZWRpdG9yIiwidmFsaWRhdGVSdWxlcyIsIm5hbWUiLCJpZGVudGlmaWVyIiwicnVsZXMiLCJ0eXBlIiwicHJvbXB0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiZGFfVmFsaWRhdGVOYW1lSXNFbXB0eSIsImV4dGVuc2lvbiIsInZhbHVlIiwiZGFfVmFsaWRhdGVFeHRlbnNpb25OdW1iZXIiLCJkYV9WYWxpZGF0ZUV4dGVuc2lvbklzRW1wdHkiLCJkYV9WYWxpZGF0ZUV4dGVuc2lvbkRvdWJsZSIsImluaXRpYWxpemUiLCJ0YWIiLCJmb3JtIiwibGVuZ3RoIiwiZHJvcGRvd24iLCJvbkNoYW5nZSIsImNoYW5nZUFjZU1vZGUiLCJvbiIsIm5ld051bWJlciIsIkV4dGVuc2lvbnMiLCJjaGVja0F2YWlsYWJpbGl0eSIsImluaXRpYWxpemVGb3JtIiwiaW5pdGlhbGl6ZUFjZSIsImFwcGxpY2F0aW9uTG9naWMiLCJhY2VIZWlnaHQiLCJ3aW5kb3ciLCJpbm5lckhlaWdodCIsInJvd3NDb3VudCIsIk1hdGgiLCJyb3VuZCIsImxvYWQiLCJjc3MiLCJhY2UiLCJlZGl0IiwiZ2V0U2Vzc2lvbiIsInNldFZhbHVlIiwic2V0VGhlbWUiLCJyZXNpemUiLCJGb3JtIiwiZGF0YUNoYW5nZWQiLCJzZXRPcHRpb25zIiwibWF4TGluZXMiLCJzaG93UHJpbnRNYXJnaW4iLCJzaG93TGluZU51bWJlcnMiLCJtb2RlIiwiTmV3TW9kZSIsInJlcXVpcmUiLCJNb2RlIiwic2Vzc2lvbiIsInNldE1vZGUiLCJjYkJlZm9yZVNlbmRGb3JtIiwic2V0dGluZ3MiLCJyZXN1bHQiLCJkYXRhIiwiYXBwbGljYXRpb25sb2dpYyIsImdldFZhbHVlIiwiY2JBZnRlclNlbmRGb3JtIiwicmVzcG9uc2UiLCJ1cmwiLCJnbG9iYWxSb290VXJsIiwiZm4iLCJleGlzdFJ1bGUiLCJwYXJhbWV0ZXIiLCJoYXNDbGFzcyIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxtQkFBbUIsR0FBRztBQUV4QkMsRUFBQUEsT0FBTyxFQUFFQyxDQUFDLENBQUMsWUFBRCxDQUZjO0FBR3hCQyxFQUFBQSxnQkFBZ0IsRUFBRSxFQUhNOztBQUt4QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFRLEVBQUVGLENBQUMsQ0FBQyw0QkFBRCxDQVRhO0FBV3hCRyxFQUFBQSxtQkFBbUIsRUFBRUgsQ0FBQyxDQUFDLHlDQUFELENBWEU7QUFheEJJLEVBQUFBLGFBQWEsRUFBRUosQ0FBQyxDQUFDLDhCQUFELENBYlE7QUFleEI7QUFDQUssRUFBQUEsTUFBTSxFQUFFLEVBaEJnQjs7QUFrQnhCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFO0FBQ1hDLElBQUFBLElBQUksRUFBRTtBQUNGQyxNQUFBQSxVQUFVLEVBQUUsTUFEVjtBQUVGQyxNQUFBQSxLQUFLLEVBQUUsQ0FDSDtBQUNJQyxRQUFBQSxJQUFJLEVBQUUsT0FEVjtBQUVJQyxRQUFBQSxNQUFNLEVBQUVDLGVBQWUsQ0FBQ0M7QUFGNUIsT0FERztBQUZMLEtBREs7QUFVWEMsSUFBQUEsU0FBUyxFQUFFO0FBQ1BOLE1BQUFBLFVBQVUsRUFBRSxXQURMO0FBRVBDLE1BQUFBLEtBQUssRUFBRSxDQUNIO0FBQ0lDLFFBQUFBLElBQUksRUFBRSxRQURWO0FBRUlLLFFBQUFB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U0FBekIsR0FBcUMsVUFBQ3ZELEtBQUQsRUFBUXdELFNBQVI7QUFBQSxTQUFzQnZFLENBQUMsWUFBS3VFLFNBQUwsRUFBRCxDQUFtQkMsUUFBbkIsQ0FBNEIsUUFBNUIsQ0FBdEI7QUFBQSxDQUFyQztBQUVBO0FBQ0E7QUFDQTs7O0FBQ0F4RSxDQUFDLENBQUN5RSxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCNUUsRUFBQUEsbUJBQW1CLENBQUNxQixVQUFwQjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCxnbG9iYWxUcmFuc2xhdGUsIGFjZSwgRm9ybSwgRXh0ZW5zaW9ucyAqL1xuXG4vKipcbiAqIFRoZSBEaWFscGxhbkFwcGxpY2F0aW9uIG9iamVjdC5cbiAqICBNYW5hZ2VzIHRoZSBvcGVyYXRpb25zIGFuZCBiZWhhdmlvcnMgb2YgdGhlIERpYWxwbGFuIGFwcGxpY2F0aW9ucyBpbiB0aGUgVUkuXG4gKlxuICogQG1vZHVsZSBEaWFscGxhbkFwcGxpY2F0aW9uXG4gKi9cbmNvbnN0IGRpYWxwbGFuQXBwbGljYXRpb24gPSB7XG5cbiAgICAkbnVtYmVyOiAkKCcjZXh0ZW5zaW9uJyksXG4gICAgZGVmYXVsdEV4dGVuc2lvbjogJycsXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjZGlhbHBsYW4tYXBwbGljYXRpb24tZm9ybScpLFxuXG4gICAgJHR5cGVTZWxlY3REcm9wRG93bjogJCgnI2RpYWxwbGFuLWFwcGxpY2F0aW9uLWZvcm0gLnR5cGUtc2VsZWN0JyksXG5cbiAgICAkdGFiTWVudUl0ZW1zOiAkKCcjYXBwbGljYXRpb24tY29kZS1tZW51IC5pdGVtJyksXG5cbiAgICAvLyBBY2UgZWRpdG9yIGluc3RhbmNlXG4gICAgZWRpdG9yOiAnJyxcblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRpb24gcnVsZXMgZm9yIHRoZSBmb3JtIGZpZWxkcyBiZWZvcmUgc3VibWlzc2lvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtvYmplY3R9XG4gICAgICovXG4gICAgdmFsaWRhdGVSdWxlczoge1xuICAgICAgICBuYW1lOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnbmFtZScsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VtcHR5JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUuZGFfVmFsaWRhdGVOYW1lSXNFbXB0eSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgZXh0ZW5zaW9uOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnZXh0ZW5zaW9uJyxcbiAgICAgICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAncmVnRXhwJyxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICcvXih8WzAtOSMrXFxcXCp8WF17MSw2NH0pJC8nLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5kYV9WYWxpZGF0ZUV4dGVuc2lvbk51bWJlcixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VtcHR5JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUuZGFfVmFsaWRhdGVFeHRlbnNpb25Jc0VtcHR5LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZXhpc3RSdWxlW2V4dGVuc2lvbi1lcnJvcl0nLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5kYV9WYWxpZGF0ZUV4dGVuc2lvbkRvdWJsZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIERpYWxwbGFuQXBwbGljYXRpb24uXG4gICAgICogU2V0cyB1cCB0YWJzLCBkcm9wZG93bnMsIGZvcm0gYW5kIEFjZSBlZGl0b3IuXG4gICAgICogU2V0cyB1cCBjaGFuZ2UgaGFuZGxlcnMgZm9yIGV4dGVuc2lvbiBudW1iZXIgYW5kIGVkaXRvciBjb250ZW50cy5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBkaWFscGxhbkFwcGxpY2F0aW9uLiR0YWJNZW51SXRlbXMudGFiKCk7XG4gICAgICAgIGlmIChkaWFscGxhbkFwcGxpY2F0aW9uLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICduYW1lJykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBkaWFscGxhbkFwcGxpY2F0aW9uLiR0YWJNZW51SXRlbXMudGFiKCdjaGFuZ2UgdGFiJywgJ21haW4nKTtcbiAgICAgICAgfVxuICAgICAgICBkaWFscGxhbkFwcGxpY2F0aW9uLiR0eXBlU2VsZWN0RHJvcERvd24uZHJvcGRvd24oe1xuICAgICAgICAgICAgb25DaGFuZ2U6IGRpYWxwbGFuQXBwbGljYXRpb24uY2hhbmdlQWNlTW9kZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQWRkIGhhbmRsZXIgdG8gZHluYW1pY2FsbHkgY2hlY2sgaWYgdGhlIGlucHV0IG51bWJlciBpcyBhdmFpbGFibGVcbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi4kbnVtYmVyLm9uKCdjaGFuZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBuZXdOdW1iZXIgPSBkaWFscGxhbkFwcGxpY2F0aW9uLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICdleHRlbnNpb24nKTtcbiAgICAgICAgICAgIEV4dGVuc2lvbnMuY2hlY2tBdmFpbGFiaWxpdHkoZGlhbHBsYW5BcHBsaWNhdGlvbi5kZWZhdWx0RXh0ZW5zaW9uLCBuZXdOdW1iZXIpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBJbml0aWFsaXplIFVJIGNvbXBvbmVudHNcbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi5pbml0aWFsaXplRm9ybSgpO1xuICAgICAgICBkaWFscGxhbkFwcGxpY2F0aW9uLmluaXRpYWxpemVBY2UoKTtcbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi5jaGFuZ2VBY2VNb2RlKCk7XG5cbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi5kZWZhdWx0RXh0ZW5zaW9uID0gZGlhbHBsYW5BcHBsaWNhdGlvbi4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCAnZXh0ZW5zaW9uJyk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBBY2UgZWRpdG9yIGluc3RhbmNlLlxuICAgICAqIFNldHMgdXAgQWNlIGVkaXRvciB3aXRoIGEgbW9ub2thaSB0aGVtZSBhbmQgY3VzdG9tIG9wdGlvbnMuXG4gICAgICogQXR0YWNoZXMgY2hhbmdlIGhhbmRsZXIgdG8gdGhlIGVkaXRvciBzZXNzaW9uLlxuICAgICAqL1xuICAgIGluaXRpYWxpemVBY2UoKSB7XG4gICAgICAgIGNvbnN0IGFwcGxpY2F0aW9uTG9naWMgPSBkaWFscGxhbkFwcGxpY2F0aW9uLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICdhcHBsaWNhdGlvbmxvZ2ljJyk7XG4gICAgICAgIGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIDM4MDtcbiAgICAgICAgY29uc3Qgcm93c0NvdW50ID0gTWF0aC5yb3VuZChhY2VIZWlnaHQgLyAxNi4zKTtcbiAgICAgICAgJCh3aW5kb3cpLmxvYWQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJCgnLmFwcGxpY2F0aW9uLWNvZGUnKS5jc3MoJ21pbi1oZWlnaHQnLCBgJHthY2VIZWlnaHR9cHhgKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRpYWxwbGFuQXBwbGljYXRpb24uZWRpdG9yID0gYWNlLmVkaXQoJ2FwcGxpY2F0aW9uLWNvZGUnKTtcbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKGFwcGxpY2F0aW9uTG9naWMpO1xuICAgICAgICBkaWFscGxhbkFwcGxpY2F0aW9uLmVkaXRvci5zZXRUaGVtZSgnYWNlL3RoZW1lL21vbm9rYWknKTtcbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi5lZGl0b3IucmVzaXplKCk7XG4gICAgICAgIGRpYWxwbGFuQXBwbGljYXRpb24uZWRpdG9yLmdldFNlc3Npb24oKS5vbignY2hhbmdlJywgKCkgPT4ge1xuICAgICAgICAgICAgLy8gVHJpZ2dlciBjaGFuZ2UgZXZlbnQgdG8gYWNrbm93bGVkZ2UgdGhlIG1vZGlmaWNhdGlvblxuICAgICAgICAgICAgRm9ybS5kYXRhQ2hhbmdlZCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi5lZGl0b3Iuc2V0T3B0aW9ucyh7XG4gICAgICAgICAgICBtYXhMaW5lczogcm93c0NvdW50LFxuICAgICAgICAgICAgc2hvd1ByaW50TWFyZ2luOiBmYWxzZSxcbiAgICAgICAgICAgIHNob3dMaW5lTnVtYmVyczogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDaGFuZ2VzIHRoZSBBY2UgZWRpdG9yIG1vZGUgYW5kIHNldHRpbmdzIGJhc2VkIG9uIHRoZSAndHlwZScgZm9ybSB2YWx1ZS5cbiAgICAgKiBJZiB0aGUgJ3R5cGUnIGlzICdwaHAnLCBQSFAgbW9kZSBpcyBzZXQsIGFuZCBsaW5lIG51bWJlcnMgYXJlIHNob3duLlxuICAgICAqIE90aGVyd2lzZSwgSnVsaWEgbW9kZSBpcyBzZXQsIGFuZCBsaW5lIG51bWJlcnMgYXJlIGhpZGRlbi5cbiAgICAgKiBUaGUgZWRpdG9yIHRoZW1lIGlzIHNldCB0byBNb25va2FpIGluIGFsbCBjYXNlcy5cbiAgICAgKi9cbiAgICBjaGFuZ2VBY2VNb2RlKCkge1xuICAgICAgICAvLyBSZXRyaWV2ZSAndHlwZScgdmFsdWUgZnJvbSB0aGUgZm9ybVxuICAgICAgICBjb25zdCBtb2RlID0gZGlhbHBsYW5BcHBsaWNhdGlvbi4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCAndHlwZScpO1xuICAgICAgICBsZXQgTmV3TW9kZTtcblxuICAgICAgICBpZiAobW9kZSA9PT0gJ3BocCcpIHtcbiAgICAgICAgICAgIC8vIElmICd0eXBlJyBpcyAncGhwJywgc2V0IHRoZSBlZGl0b3IgbW9kZSB0byBQSFAgYW5kIHNob3cgbGluZSBudW1iZXJzXG4gICAgICAgICAgICBOZXdNb2RlID0gYWNlLnJlcXVpcmUoJ2FjZS9tb2RlL3BocCcpLk1vZGU7XG4gICAgICAgICAgICBkaWFscGxhbkFwcGxpY2F0aW9uLmVkaXRvci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgICAgICBzaG93TGluZU51bWJlcnM6IHRydWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIElmICd0eXBlJyBpcyBub3QgJ3BocCcsIHNldCB0aGUgZWRpdG9yIG1vZGUgdG8gSnVsaWEgYW5kIGhpZGUgbGluZSBudW1iZXJzXG4gICAgICAgICAgICBOZXdNb2RlID0gYWNlLnJlcXVpcmUoJ2FjZS9tb2RlL2p1bGlhJykuTW9kZTtcbiAgICAgICAgICAgIGRpYWxwbGFuQXBwbGljYXRpb24uZWRpdG9yLnNldE9wdGlvbnMoe1xuICAgICAgICAgICAgICAgIHNob3dMaW5lTnVtYmVyczogZmFsc2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNldCB0aGUgbmV3IG1vZGUgYW5kIHRoZW1lIGZvciB0aGUgZWRpdG9yXG4gICAgICAgIGRpYWxwbGFuQXBwbGljYXRpb24uZWRpdG9yLnNlc3Npb24uc2V0TW9kZShuZXcgTmV3TW9kZSgpKTtcbiAgICAgICAgZGlhbHBsYW5BcHBsaWNhdGlvbi5lZGl0b3Iuc2V0VGhlbWUoJ2FjZS90aGVtZS9tb25va2FpJyk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBiZWZvcmUgdGhlIGZvcm0gaXMgc2VudFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIFRoZSBjdXJyZW50IHNldHRpbmdzIG9mIHRoZSBmb3JtXG4gICAgICogQHJldHVybnMge09iamVjdH0gLSBUaGUgdXBkYXRlZCBzZXR0aW5ncyBvZiB0aGUgZm9ybVxuICAgICAqL1xuICAgIGNiQmVmb3JlU2VuZEZvcm0oc2V0dGluZ3MpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc2V0dGluZ3M7XG4gICAgICAgIHJlc3VsdC5kYXRhID0gZGlhbHBsYW5BcHBsaWNhdGlvbi4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG4gICAgICAgIHJlc3VsdC5kYXRhLmFwcGxpY2F0aW9ubG9naWMgPSBkaWFscGxhbkFwcGxpY2F0aW9uLmVkaXRvci5nZXRWYWx1ZSgpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGZvcm0gaGFzIGJlZW4gc2VudC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIGFmdGVyIHRoZSBmb3JtIGlzIHNlbnRcbiAgICAgKi9cbiAgICBjYkFmdGVyU2VuZEZvcm0ocmVzcG9uc2UpIHtcblxuICAgIH0sXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgZm9ybSB3aXRoIGN1c3RvbSBzZXR0aW5nc1xuICAgICAqL1xuICAgIGluaXRpYWxpemVGb3JtKCkge1xuICAgICAgICBGb3JtLiRmb3JtT2JqID0gZGlhbHBsYW5BcHBsaWNhdGlvbi4kZm9ybU9iajtcbiAgICAgICAgRm9ybS51cmwgPSBgJHtnbG9iYWxSb290VXJsfWRpYWxwbGFuLWFwcGxpY2F0aW9ucy9zYXZlYDsgLy8gRm9ybSBzdWJtaXNzaW9uIFVSTFxuICAgICAgICBGb3JtLnZhbGlkYXRlUnVsZXMgPSBkaWFscGxhbkFwcGxpY2F0aW9uLnZhbGlkYXRlUnVsZXM7IC8vIEZvcm0gdmFsaWRhdGlvbiBydWxlc1xuICAgICAgICBGb3JtLmNiQmVmb3JlU2VuZEZvcm0gPSBkaWFscGxhbkFwcGxpY2F0aW9uLmNiQmVmb3JlU2VuZEZvcm07IC8vIENhbGxiYWNrIGJlZm9yZSBmb3JtIGlzIHNlbnRcbiAgICAgICAgRm9ybS5jYkFmdGVyU2VuZEZvcm0gPSBkaWFscGxhbkFwcGxpY2F0aW9uLmNiQWZ0ZXJTZW5kRm9ybTsgLy8gQ2FsbGJhY2sgYWZ0ZXIgZm9ybSBpcyBzZW50XG4gICAgICAgIEZvcm0uaW5pdGlhbGl6ZSgpO1xuICAgIH0sXG59O1xuXG4vKipcbiAqIENoZWNrcyBpZiB0aGUgbnVtYmVyIGlzIHRha2VuIGJ5IGFub3RoZXIgYWNjb3VudFxuICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIHBhcmFtZXRlciBoYXMgdGhlICdoaWRkZW4nIGNsYXNzLCBmYWxzZSBvdGhlcndpc2VcbiAqL1xuJC5mbi5mb3JtLnNldHRpbmdzLnJ1bGVzLmV4aXN0UnVsZSA9ICh2YWx1ZSwgcGFyYW1ldGVyKSA9PiAkKGAjJHtwYXJhbWV0ZXJ9YCkuaGFzQ2xhc3MoJ2hpZGRlbicpO1xuXG4vKipcbiAqICBJbml0aWFsaXplIERpYWxwbGFuIEFwcGxpY2F0aW9uIG1vZGlmeSBmb3JtIG9uIGRvY3VtZW50IHJlYWR5XG4gKi9cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBkaWFscGxhbkFwcGxpY2F0aW9uLmluaXRpYWxpemUoKTtcbn0pO1xuXG4iXX0=
"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi */

/**
 * Worker object for checking connection to licensing and repository server.
 *
 * @module PbxExtensionModules
 */
var PingLicenseServerWorker = {
  /**
   * Stores in session the last connection status
   * @type {string}
   */
  cacheKey: 'InternetConnectionStatus',

  /**
   * jQuery object for the div with information if no internet.
   * @type {jQuery}
   */
  $noInternet: $('div.show-if-no-internet'),

  /**
   * Class name that should be disabled if no internet connection.
   * @type {string}
   */
  disableIfNoInternetClass: '.disable-if-no-internet',

  /**
   * Time in milliseconds before fetching new check internet request.
   * @type {number}
   */
  timeOut: 86400,

  /**
   * The id of the timer function for the worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * Initializes the worker.
   */
  initialize: function initialize() {
    PingLicenseServerWorker.changeTabsAvailability();
    PingLicenseServerWorker.restartWorker();
  },

  /**
   * Restarts the worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(PingLicenseServerWorker.timeoutHandle);
    PingLicenseServerWorker.worker();
  },

  /**
   * Worker function for checking the internet connection on background.
   */
  worker: function worker() {
    PbxApi.LicensePing(PingLicenseServerWorker.cbAfterResponse);
  },

  /**
   * Callback function after receiving a response from the server.
   * @param isConnected - connection result.
   */
  cbAfterResponse: function cbAfterResponse(isConnected) {
    if (isConnected === true) {
      // The internet is available
      sessionStorage.setItem(PingLicenseServerWorker.cacheKey, 'true');
    } else {
      // The internet is not available
      sessionStorage.setItem(PingLicenseServerWorker.cacheKey, 'false');
    }

    PingLicenseServerWorker.changeTabsAvailability();
    PingLicenseServerWorker.timeoutHandle = window.setTimeout(PingLicenseServerWorker.worker, PingLicenseServerWorker.timeOut);
  },

  /**
   * Change the availability of tabs based on the internet connection status.
   */
  changeTabsAvailability: function changeTabsAvailability() {
    var isConnected = sessionStorage.getItem(PingLicenseServerWorker.cacheKey);

    if (isConnected === 'false') {
      // The internet is not available
      PingLicenseServerWorker.$noInternet.show();
      $(PingLicenseServerWorker.disableIfNoInternetClass).addClass('disabled');
    } else {
      // The internet is available
      PingLicenseServerWorker.$noInternet.hide();
      $(PingLicenseServerWorker.disableIfNoInternetClass).removeClass('disabled');
    }
  }
}; // When the document is ready, initialize the internet connection worker

$(document).ready(function () {
  PingLicenseServerWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLXBpbmctbGljLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJQaW5nTGljZW5zZVNlcnZlcldvcmtlciIsImNhY2hlS2V5IiwiJG5vSW50ZXJuZXQiLCIkIiwiZGlzYWJsZUlmTm9JbnRlcm5ldENsYXNzIiwidGltZU91dCIsInRpbWVPdXRIYW5kbGUiLCJpbml0aWFsaXplIiwiY2hhbmdlVGFic0F2YWlsYWJpbGl0eSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiUGJ4QXBpIiwiTGljZW5zZVBpbmciLCJjYkFmdGVyUmVzcG9uc2UiLCJpc0Nvbm5lY3RlZCIsInNlc3Npb25TdG9yYWdlIiwic2V0SXRlbSIsInNldFRpbWVvdXQiLCJnZXRJdGVtIiwic2hvdyIsImFkZENsYXNzIiwiaGlkZSIsInJlbW92ZUNsYXNzIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUU1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFRLEVBQUMsMEJBTm1COztBQVE1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxXQUFXLEVBQUVDLENBQUMsQ0FBQyx5QkFBRCxDQVpjOztBQWM1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSx3QkFBd0IsRUFBRyx5QkFsQkM7O0FBb0I1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxPQUFPLEVBQUUsS0F4Qm1COztBQTBCNUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFLENBOUJhOztBQWdDNUI7QUFDSjtBQUNBO0FBQ0lDLEVBQUFBLFVBbkM0Qix3QkFtQ2Y7QUFDVFAsSUFBQUEsdUJBQXVCLENBQUNRLHNCQUF4QjtBQUNBUixJQUFBQSx1QkFBdUIsQ0FBQ1MsYUFBeEI7QUFDSCxHQXRDMkI7O0FBd0M1QjtBQUNKO0FBQ0E7QUFDSUEsRUFBQUEsYUEzQzRCLDJCQTJDWjtBQUNaQyxJQUFBQSxNQUFNLENBQUNDLFlBQVAsQ0FBb0JYLHVCQUF1QixDQUFDWSxhQUE1QztBQUNBWixJQUFBQSx1QkFBdUIsQ0FBQ2EsTUFBeEI7QUFDSCxHQTlDMkI7O0FBZ0Q1QjtBQUNKO0FBQ0E7QUFDSUEsRUFBQUEsTUFuRDRCLG9CQW1EbkI7QUFDTEMsSUFBQUEsTUFBTSxDQUFDQyxXQUFQLENBQW1CZix1QkFBdUIsQ0FBQ2dCLGVBQTNDO0FBQ0gsR0FyRDJCOztBQXVENUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUEsRUFBQUEsZUEzRDRCLDJCQTJEWkMsV0EzRFksRUEyREM7QUFDekIsUUFBSUEsV0FBVyxLQUFLLElBQXBCLEVBQTBCO0FBQ3RCO0FBQ0FDLE1BQUFBLGNBQWMsQ0FBQ0MsT0FBZixDQUF1Qm5CLHVCQUF1QixDQUFDQyxRQUEvQyxFQUF5RCxNQUF6RDtBQUNILEtBSEQsTUFHTztBQUNIO0FBQ0FpQixNQUFBQSxjQUFjLENBQUNDLE9BQWYsQ0FBdUJuQix1QkFBdUIsQ0FBQ0MsUUFBL0MsRUFBeUQsT0FBekQ7QUFDSDs7QUFDREQsSUFBQUEsdUJBQXVCLENBQUNRLHNCQUF4QjtBQUNBUixJQUFBQSx1QkFBdUIsQ0FBQ1ksYUFBeEIsR0FBd0NGLE1BQU0sQ0FBQ1UsVUFBUCxDQUNwQ3BCLHVCQUF1QixDQUFDYSxNQURZLEVBRXBDYix1QkFBdUIsQ0FBQ0ssT0FGWSxDQUF4QztBQUlILEdBeEUyQjs7QUEwRTVCO0FBQ0o7QUFDQTtBQUNJRyxFQUFBQSxzQkE3RTRCLG9DQThFNUI7QUFDSSxRQUFJUyxXQUFXLEdBQUdDLGNBQWMsQ0FBQ0csT0FBZixDQUF1QnJCLHVCQUF1QixDQUFDQyxRQUEvQyxDQUFsQjs7QUFFQSxRQUFJZ0IsV0FBVyxLQUFLLE9BQXBCLEVBQTZCO0FBQ3pCO0FBQ0FqQixNQUFBQSx1QkFBdUIsQ0FBQ0UsV0FBeEIsQ0FBb0NvQixJQUFwQztBQUNBbkIsTUFBQUEsQ0FBQyxDQUFDSCx1QkFBdUIsQ0FBQ0ksd0JBQXpCLENBQUQsQ0FBb0RtQixRQUFwRCxDQUE2RCxVQUE3RDtBQUNILEtBSkQsTUFJTztBQUNIO0FBQ0F2QixNQUFBQSx1QkFBdUIsQ0FBQ0UsV0FBeEIsQ0FBb0NzQixJQUFwQztBQUNBckIsTUFBQUEsQ0FBQyxDQUFDSCx1QkFBdUIsQ0FBQ0ksd0JBQXpCLENBQUQsQ0FBb0RxQixXQUFwRCxDQUFnRSxVQUFoRTtBQUNIO0FBQ0o7QUExRjJCLENBQWhDLEMsQ0E2RkE7O0FBQ0F0QixDQUFDLENBQUN1QixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCM0IsRUFBQUEsdUJBQXVCLENBQUNPLFVBQXhCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGkgKi9cblxuLyoqXG4gKiBXb3JrZXIgb2JqZWN0IGZvciBjaGVja2luZyBjb25uZWN0aW9uIHRvIGxpY2Vuc2luZyBhbmQgcmVwb3NpdG9yeSBzZXJ2ZXIuXG4gKlxuICogQG1vZHVsZSBQYnhFeHRlbnNpb25Nb2R1bGVzXG4gKi9cbmNvbnN0IFBpbmdMaWNlbnNlU2VydmVyV29ya2VyID0ge1xuXG4gICAgLyoqXG4gICAgICogU3RvcmVzIGluIHNlc3Npb24gdGhlIGxhc3QgY29ubmVjdGlvbiBzdGF0dXNcbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIGNhY2hlS2V5OidJbnRlcm5ldENvbm5lY3Rpb25TdGF0dXMnLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGRpdiB3aXRoIGluZm9ybWF0aW9uIGlmIG5vIGludGVybmV0LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJG5vSW50ZXJuZXQ6ICQoJ2Rpdi5zaG93LWlmLW5vLWludGVybmV0JyksXG5cbiAgICAvKipcbiAgICAgKiBDbGFzcyBuYW1lIHRoYXQgc2hvdWxkIGJlIGRpc2FibGVkIGlmIG5vIGludGVybmV0IGNvbm5lY3Rpb24uXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBkaXNhYmxlSWZOb0ludGVybmV0Q2xhc3M6ICAnLmRpc2FibGUtaWYtbm8taW50ZXJuZXQnLFxuXG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGZldGNoaW5nIG5ldyBjaGVjayBpbnRlcm5ldCByZXF1ZXN0LlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dDogODY0MDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciB0aGUgd29ya2VyLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dEhhbmRsZTogMCxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSB3b3JrZXIuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuY2hhbmdlVGFic0F2YWlsYWJpbGl0eSgpO1xuICAgICAgICBQaW5nTGljZW5zZVNlcnZlcldvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChQaW5nTGljZW5zZVNlcnZlcldvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIud29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFdvcmtlciBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgdGhlIGludGVybmV0IGNvbm5lY3Rpb24gb24gYmFja2dyb3VuZC5cbiAgICAgKi9cbiAgICB3b3JrZXIoKSB7XG4gICAgICAgIFBieEFwaS5MaWNlbnNlUGluZyhQaW5nTGljZW5zZVNlcnZlcldvcmtlci5jYkFmdGVyUmVzcG9uc2UpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBhZnRlciByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIuXG4gICAgICogQHBhcmFtIGlzQ29ubmVjdGVkIC0gY29ubmVjdGlvbiByZXN1bHQuXG4gICAgICovXG4gICAgY2JBZnRlclJlc3BvbnNlKGlzQ29ubmVjdGVkKSB7XG4gICAgICAgIGlmIChpc0Nvbm5lY3RlZCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgLy8gVGhlIGludGVybmV0IGlzIGF2YWlsYWJsZVxuICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShQaW5nTGljZW5zZVNlcnZlcldvcmtlci5jYWNoZUtleSwgJ3RydWUnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFRoZSBpbnRlcm5ldCBpcyBub3QgYXZhaWxhYmxlXG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKFBpbmdMaWNlbnNlU2VydmVyV29ya2VyLmNhY2hlS2V5LCAnZmFsc2UnKTtcbiAgICAgICAgfVxuICAgICAgICBQaW5nTGljZW5zZVNlcnZlcldvcmtlci5jaGFuZ2VUYWJzQXZhaWxhYmlsaXR5KCk7XG4gICAgICAgIFBpbmdMaWNlbnNlU2VydmVyV29ya2VyLnRpbWVvdXRIYW5kbGUgPSB3aW5kb3cuc2V0VGltZW91dChcbiAgICAgICAgICAgIFBpbmdMaWNlbnNlU2VydmVyV29ya2VyLndvcmtlcixcbiAgICAgICAgICAgIFBpbmdMaWNlbnNlU2VydmVyV29ya2VyLnRpbWVPdXQsXG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENoYW5nZSB0aGUgYXZhaWxhYmlsaXR5IG9mIHRhYnMgYmFzZWQgb24gdGhlIGludGVybmV0IGNvbm5lY3Rpb24gc3RhdHVzLlxuICAgICAqL1xuICAgIGNoYW5nZVRhYnNBdmFpbGFiaWxpdHkoKVxuICAgIHtcbiAgICAgICAgbGV0IGlzQ29ubmVjdGVkID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShQaW5nTGljZW5zZVNlcnZlcldvcmtlci5jYWNoZUtleSk7XG5cbiAgICAgICAgaWYgKGlzQ29ubmVjdGVkID09PSAnZmFsc2UnKSB7XG4gICAgICAgICAgICAvLyBUaGUgaW50ZXJuZXQgaXMgbm90IGF2YWlsYWJsZVxuICAgICAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuJG5vSW50ZXJuZXQuc2hvdygpO1xuICAgICAgICAgICAgJChQaW5nTGljZW5zZVNlcnZlcldvcmtlci5kaXNhYmxlSWZOb0ludGVybmV0Q2xhc3MpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gVGhlIGludGVybmV0IGlzIGF2YWlsYWJsZVxuICAgICAgICAgICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuJG5vSW50ZXJuZXQuaGlkZSgpO1xuICAgICAgICAgICAgJChQaW5nTGljZW5zZVNlcnZlcldvcmtlci5kaXNhYmxlSWZOb0ludGVybmV0Q2xhc3MpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxuLy8gV2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHksIGluaXRpYWxpemUgdGhlIGludGVybmV0IGNvbm5lY3Rpb24gd29ya2VyXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgUGluZ0xpY2Vuc2VTZXJ2ZXJXb3JrZXIuaW5pdGlhbGl6ZSgpO1xufSk7XG4iXX0=
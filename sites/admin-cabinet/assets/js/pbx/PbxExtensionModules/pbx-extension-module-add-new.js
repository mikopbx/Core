"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global UserMessage, globalTranslate, PbxApi, mergingCheckWorker */

/**
 * Object for handling the addition of a new extension from a ZIP file.
 *
 * @module addNewExtension
 */
var addNewExtension = {
  /**
   * The upload button element.
   * @type {jQuery}
   */
  $uploadButton: $('#add-new-button'),

  /**
   * The progress bar element.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * The progress bar label element.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * Flag indicating if an upload is in progress.
   * @type {boolean}
   */
  uploadInProgress: false,

  /**
   * Initializes the addNewExtension object.
   */
  initialize: function initialize() {
    addNewExtension.$progressBar.hide();
    PbxApi.SystemUploadFileAttachToBtn('add-new-button', ['zip'], addNewExtension.cbResumableUploadFile);
  },

  /**
   * Callback function for resumable file upload.
   * @param {string} action - The action of the upload.
   * @param {object} params - Additional parameters for the upload.
   */
  cbResumableUploadFile: function cbResumableUploadFile(action, params) {
    switch (action) {
      case 'fileSuccess':
        addNewExtension.checkStatusFileMerging(params.response);
        break;

      case 'uploadStart':
        addNewExtension.uploadInProgress = true;
        addNewExtension.$uploadButton.addClass('loading');
        addNewExtension.$progressBar.show();
        addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
        break;

      case 'progress':
        addNewExtension.$progressBar.progress({
          percent: parseInt(params.percent, 10)
        });
        break;

      case 'error':
        addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadError);
        addNewExtension.$uploadButton.removeClass('loading');
        UserMessage.showMultiString(globalTranslate.ext_UploadError);
        break;

      default:
    }
  },

  /**
   * Checks the status of the file merging process.
   * @param {string} response - The response from the /pbxcore/api/upload/status function.
   */
  checkStatusFileMerging: function checkStatusFileMerging(response) {
    if (response === undefined || PbxApi.tryParseJSON(response) === false) {
      UserMessage.showMultiString("".concat(globalTranslate.ext_UploadError));
      return;
    }

    var json = JSON.parse(response);

    if (json === undefined || json.data === undefined) {
      UserMessage.showMultiString("".concat(globalTranslate.ext_UploadError));
      return;
    }

    var fileID = json.data.upload_id;
    var filePath = json.data.filename;
    mergingCheckWorker.initialize(fileID, filePath);
  }
}; // When the document is ready, initialize the external modules management interface.

$(document).ready(function () {
  addNewExtension.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWFkZC1uZXcuanMiXSwibmFtZXMiOlsiYWRkTmV3RXh0ZW5zaW9uIiwiJHVwbG9hZEJ1dHRvbiIsIiQiLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsInVwbG9hZEluUHJvZ3Jlc3MiLCJpbml0aWFsaXplIiwiaGlkZSIsIlBieEFwaSIsIlN5c3RlbVVwbG9hZEZpbGVBdHRhY2hUb0J0biIsImNiUmVzdW1hYmxlVXBsb2FkRmlsZSIsImFjdGlvbiIsInBhcmFtcyIsImNoZWNrU3RhdHVzRmlsZU1lcmdpbmciLCJyZXNwb25zZSIsImFkZENsYXNzIiwic2hvdyIsInRleHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfVXBsb2FkSW5Qcm9ncmVzcyIsInByb2dyZXNzIiwicGVyY2VudCIsInBhcnNlSW50IiwiZXh0X1VwbG9hZEVycm9yIiwicmVtb3ZlQ2xhc3MiLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsInVuZGVmaW5lZCIsInRyeVBhcnNlSlNPTiIsImpzb24iLCJKU09OIiwicGFyc2UiLCJkYXRhIiwiZmlsZUlEIiwidXBsb2FkX2lkIiwiZmlsZVBhdGgiLCJmaWxlbmFtZSIsIm1lcmdpbmdDaGVja1dvcmtlciIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsZUFBZSxHQUFHO0FBQ3BCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGFBQWEsRUFBRUMsQ0FBQyxDQUFDLGlCQUFELENBTEk7O0FBT3BCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFlBQVksRUFBRUQsQ0FBQyxDQUFD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WCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgVXNlck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZSwgUGJ4QXBpLCBtZXJnaW5nQ2hlY2tXb3JrZXIgKi9cblxuLyoqXG4gKiBPYmplY3QgZm9yIGhhbmRsaW5nIHRoZSBhZGRpdGlvbiBvZiBhIG5ldyBleHRlbnNpb24gZnJvbSBhIFpJUCBmaWxlLlxuICpcbiAqIEBtb2R1bGUgYWRkTmV3RXh0ZW5zaW9uXG4gKi9cbmNvbnN0IGFkZE5ld0V4dGVuc2lvbiA9IHtcbiAgICAvKipcbiAgICAgKiBUaGUgdXBsb2FkIGJ1dHRvbiBlbGVtZW50LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHVwbG9hZEJ1dHRvbjogJCgnI2FkZC1uZXctYnV0dG9uJyksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgcHJvZ3Jlc3MgYmFyIGVsZW1lbnQuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXI6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyJyksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgcHJvZ3Jlc3MgYmFyIGxhYmVsIGVsZW1lbnQuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXItbGFiZWwnKSxcblxuICAgIC8qKlxuICAgICAqIEZsYWcgaW5kaWNhdGluZyBpZiBhbiB1cGxvYWQgaXMgaW4gcHJvZ3Jlc3MuXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgdXBsb2FkSW5Qcm9ncmVzczogZmFsc2UsXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgYWRkTmV3RXh0ZW5zaW9uIG9iamVjdC5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBhZGROZXdFeHRlbnNpb24uJHByb2dyZXNzQmFyLmhpZGUoKTtcbiAgICAgICAgUGJ4QXBpLlN5c3RlbVVwbG9hZEZpbGVBdHRhY2hUb0J0bignYWRkLW5ldy1idXR0b24nLCBbJ3ppcCddLCBhZGROZXdFeHRlbnNpb24uY2JSZXN1bWFibGVVcGxvYWRGaWxlKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHJlc3VtYWJsZSBmaWxlIHVwbG9hZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYWN0aW9uIC0gVGhlIGFjdGlvbiBvZiB0aGUgdXBsb2FkLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgZm9yIHRoZSB1cGxvYWQuXG4gICAgICovXG4gICAgY2JSZXN1bWFibGVVcGxvYWRGaWxlKGFjdGlvbiwgcGFyYW1zKSB7XG4gICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdmaWxlU3VjY2Vzcyc6XG4gICAgICAgICAgICAgICAgYWRkTmV3RXh0ZW5zaW9uLmNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocGFyYW1zLnJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3VwbG9hZFN0YXJ0JzpcbiAgICAgICAgICAgICAgICBhZGROZXdFeHRlbnNpb24udXBsb2FkSW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgYWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24uYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICBhZGROZXdFeHRlbnNpb24uJHByb2dyZXNzQmFyLnNob3coKTtcbiAgICAgICAgICAgICAgICBhZGROZXdFeHRlbnNpb24uJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEluUHJvZ3Jlc3MpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAncHJvZ3Jlc3MnOlxuICAgICAgICAgICAgICAgIGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXIucHJvZ3Jlc3Moe1xuICAgICAgICAgICAgICAgICAgICBwZXJjZW50OiBwYXJzZUludChwYXJhbXMucGVyY2VudCwgMTApLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICAgICAgICAgIGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuICAgICAgICAgICAgICAgIGFkZE5ld0V4dGVuc2lvbi4kdXBsb2FkQnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgfVxuICAgIH0sXG4gICAgXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIHRoZSBzdGF0dXMgb2YgdGhlIGZpbGUgbWVyZ2luZyBwcm9jZXNzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBmcm9tIHRoZSAvcGJ4Y29yZS9hcGkvdXBsb2FkL3N0YXR1cyBmdW5jdGlvbi5cbiAgICAgKi9cbiAgICBjaGVja1N0YXR1c0ZpbGVNZXJnaW5nKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IFBieEFwaS50cnlQYXJzZUpTT04ocmVzcG9uc2UpID09PSBmYWxzZSkge1xuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGAke2dsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3J9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2UpO1xuICAgICAgICBpZiAoanNvbiA9PT0gdW5kZWZpbmVkIHx8IGpzb24uZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoYCR7Z2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcn1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBmaWxlSUQgPSBqc29uLmRhdGEudXBsb2FkX2lkO1xuICAgICAgICBjb25zdCBmaWxlUGF0aCA9IGpzb24uZGF0YS5maWxlbmFtZTtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmluaXRpYWxpemUoZmlsZUlELCBmaWxlUGF0aCk7XG4gICAgfSxcblxufTtcblxuLy8gV2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHksIGluaXRpYWxpemUgdGhlIGV4dGVybmFsIG1vZHVsZXMgbWFuYWdlbWVudCBpbnRlcmZhY2UuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgYWRkTmV3RXh0ZW5zaW9uLmluaXRpYWxpemUoKTtcbn0pO1xuIl19
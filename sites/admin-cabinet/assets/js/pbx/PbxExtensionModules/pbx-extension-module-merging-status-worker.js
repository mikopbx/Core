"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2021 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalTranslate, UserMessage, installStatusLoopWorker */

/**
 * Worker object for monitoring the merging process of uploaded file parts.
 *
 * @module mergingCheckWorker
 */
var mergingCheckWorker = {
  /**
   * Time in milliseconds before fetching new status request.
   * @type {number}
   */
  timeOut: 3000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,
  errorCounts: 0,

  /**
   * The progress bar label element.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),
  fileID: null,
  filePath: '',

  /**
   * Initializes the merging check worker.
   * @param {string} fileID - The ID of the uploaded file.
   * @param {string} filePath - The path of the uploaded file.
   */
  initialize: function initialize(fileID, filePath) {
    mergingCheckWorker.fileID = fileID;
    mergingCheckWorker.filePath = filePath;
    mergingCheckWorker.restartWorker(fileID);
  },

  /**
   * Restarts the merging check worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(mergingCheckWorker.timeoutHandle);
    mergingCheckWorker.worker();
  },

  /**
   * Performs the merging check worker process.
   */
  worker: function worker() {
    PbxApi.FilesGetStatusUploadFile(mergingCheckWorker.fileID, mergingCheckWorker.cbAfterResponse);
    mergingCheckWorker.timeoutHandle = window.setTimeout(mergingCheckWorker.worker, mergingCheckWorker.timeOut);
  },

  /**
   * Callback function after receiving the merging check response.
   * @param {object} response - The response object from the merging check API.
   */
  cbAfterResponse: function cbAfterResponse(response) {
    // Check if error counts exceeded the limit
    if (mergingCheckWorker.errorCounts > 10) {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadError);
      UserMessage.showMultiString(response, globalTranslate.ext_UploadError);
      addNewExtension.$uploadButton.removeClass('loading');
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    } // Check if the response is valid


    if (response === undefined || Object.keys(response).length === 0) {
      mergingCheckWorker.errorCounts += 1;
      return;
    } // Check the status of the merging process


    if (response.d_status === 'UPLOAD_COMPLETE') {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_InstallationInProgress);
      PbxApi.ModulesInstallModule(mergingCheckWorker.filePath, mergingCheckWorker.cbAfterModuleInstall);
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    } else if (response.d_status !== undefined) {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
      mergingCheckWorker.errorCounts = 0;
    } else {
      mergingCheckWorker.errorCounts += 1;
    }
  },

  /**
   * Callback function after module installation.
   * @param {object} response - The response object from the module installation API.
   */
  cbAfterModuleInstall: function cbAfterModuleInstall(response) {
    if (response.result === true && response.data.filePath !== '') {
      installStatusLoopWorker.initialize(response.data.filePath, response.data.moduleWasEnabled);
    } else {
      UserMessage.showMultiString(response, globalTranslate.ext_InstallationError);
      addNewExtension.$uploadButton.removeClass('loading');
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLW1lcmdpbmctc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJtZXJnaW5nQ2hlY2tXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImVycm9yQ291bnRzIiwiJHByb2dyZXNzQmFyTGFiZWwiLCIkIiwiZmlsZUlEIiwiZmlsZVBhdGgiLCJpbml0aWFsaXplIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJQYnhBcGkiLCJGaWxlc0dldFN0YXR1c1VwbG9hZEZpbGUiLCJjYkFmdGVyUmVzcG9uc2UiLCJzZXRUaW1lb3V0IiwicmVzcG9uc2UiLCJ0ZXh0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiZXh0X1VwbG9hZEVycm9yIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJhZGROZXdFeHRlbnNpb24iLCIkdXBsb2FkQnV0dG9uIiwicmVtb3ZlQ2xhc3MiLCJ1bmRlZmluZWQiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwiZF9zdGF0dXMiLCJleHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcyIsIk1vZHVsZXNJbnN0YWxsTW9kdWxlIiwiY2JBZnRlck1vZHVsZUluc3RhbGwiLCJleHRfVXBsb2FkSW5Qcm9ncmVzcyIsInJlc3VsdCIsImRhdGEiLCJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsIm1vZHVsZVdhc0VuYWJsZWQiLCJleHRfSW5zdGFsbGF0aW9uRXJyb3IiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsa0JBQWtCLEdBQUc7QUFFdkI7QUFDSjtBQUNBO0FB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QixDQUFDRyxXQUFuQixHQUFpQyxDQUFqQztBQUNILEtBSE0sTUFHQTtBQUNISCxNQUFBQSxrQkFBa0IsQ0FBQ0csV0FBbkIsSUFBa0MsQ0FBbEM7QUFDSDtBQUNKLEdBdEZzQjs7QUF3RnZCO0FBQ0o7QUFDQTtBQUNBO0FBQ0krQixFQUFBQSxvQkE1RnVCLGdDQTRGRmhCLFFBNUZFLEVBNEZRO0FBQzNCLFFBQUlBLFFBQVEsQ0FBQ2tCLE1BQVQsS0FBb0IsSUFBcEIsSUFBNEJsQixRQUFRLENBQUNtQixJQUFULENBQWM5QixRQUFkLEtBQTBCLEVBQTFELEVBQThEO0FBQzFEK0IsTUFBQUEsdUJBQXVCLENBQUM5QixVQUF4QixDQUFtQ1UsUUFBUSxDQUFDbUIsSUFBVCxDQUFjOUIsUUFBakQsRUFBNERXLFFBQVEsQ0FBQ21CLElBQVQsQ0FBY0UsZ0JBQTFFO0FBQ0gsS0FGRCxNQUVPO0FBQ0hqQixNQUFBQSxXQUFXLENBQUNDLGVBQVosQ0FBNEJMLFFBQTVCLEVBQXNDRSxlQUFlLENBQUNvQixxQkFBdEQ7QUFDQWhCLE1BQUFBLGVBQWUsQ0FBQ0MsYUFBaEIsQ0FBOEJDLFdBQTlCLENBQTBDLFNBQTFDO0FBQ0g7QUFDSjtBQW5Hc0IsQ0FBM0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMSBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgUGJ4QXBpLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlLCBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciAqL1xuXG4vKipcbiAqIFdvcmtlciBvYmplY3QgZm9yIG1vbml0b3JpbmcgdGhlIG1lcmdpbmcgcHJvY2VzcyBvZiB1cGxvYWRlZCBmaWxlIHBhcnRzLlxuICpcbiAqIEBtb2R1bGUgbWVyZ2luZ0NoZWNrV29ya2VyXG4gKi9cbmNvbnN0IG1lcmdpbmdDaGVja1dvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgc3RhdHVzIHJlcXVlc3QuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0OiAzMDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3IgdGhlIHN0YXR1cyB3b3JrZXIuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0SGFuZGxlOiAwLFxuICAgIFxuICAgIGVycm9yQ291bnRzOiAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHByb2dyZXNzIGJhciBsYWJlbCBlbGVtZW50LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyTGFiZWw6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyLWxhYmVsJyksXG5cbiAgICBmaWxlSUQ6IG51bGwsXG4gICAgZmlsZVBhdGg6ICcnLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIG1lcmdpbmcgY2hlY2sgd29ya2VyLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlSUQgLSBUaGUgSUQgb2YgdGhlIHVwbG9hZGVkIGZpbGUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbGVQYXRoIC0gVGhlIHBhdGggb2YgdGhlIHVwbG9hZGVkIGZpbGUuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZShmaWxlSUQsIGZpbGVQYXRoKSB7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5maWxlSUQgPSBmaWxlSUQ7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCA9IGZpbGVQYXRoO1xuICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIucmVzdGFydFdvcmtlcihmaWxlSUQpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXN0YXJ0cyB0aGUgbWVyZ2luZyBjaGVjayB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci53b3JrZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybXMgdGhlIG1lcmdpbmcgY2hlY2sgd29ya2VyIHByb2Nlc3MuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICBQYnhBcGkuRmlsZXNHZXRTdGF0dXNVcGxvYWRGaWxlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlSUQsIG1lcmdpbmdDaGVja1dvcmtlci5jYkFmdGVyUmVzcG9uc2UpO1xuICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcixcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci50aW1lT3V0LFxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBhZnRlciByZWNlaXZpbmcgdGhlIG1lcmdpbmcgY2hlY2sgcmVzcG9uc2UuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIG9iamVjdCBmcm9tIHRoZSBtZXJnaW5nIGNoZWNrIEFQSS5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVzcG9uc2UocmVzcG9uc2UpIHtcblxuICAgICAgICAvLyBDaGVjayBpZiBlcnJvciBjb3VudHMgZXhjZWVkZWQgdGhlIGxpbWl0XG4gICAgICAgIGlmIChtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgPiAxMCkge1xuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcik7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuICAgICAgICAgICAgYWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQobWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHJlc3BvbnNlIGlzIHZhbGlkXG4gICAgICAgIGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IE9iamVjdC5rZXlzKHJlc3BvbnNlKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyArPSAxO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgdGhlIHN0YXR1cyBvZiB0aGUgbWVyZ2luZyBwcm9jZXNzXG4gICAgICAgIGlmIChyZXNwb25zZS5kX3N0YXR1cyA9PT0gJ1VQTE9BRF9DT01QTEVURScpIHtcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcyk7XG4gICAgICAgICAgICBQYnhBcGkuTW9kdWxlc0luc3RhbGxNb2R1bGUobWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVQYXRoLCBtZXJnaW5nQ2hlY2tXb3JrZXIuY2JBZnRlck1vZHVsZUluc3RhbGwpO1xuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZF9zdGF0dXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRJblByb2dyZXNzKTtcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyA9IDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgKz0gMTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBhZnRlciBtb2R1bGUgaW5zdGFsbGF0aW9uLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBvYmplY3QgZnJvbSB0aGUgbW9kdWxlIGluc3RhbGxhdGlvbiBBUEkuXG4gICAgICovXG4gICAgY2JBZnRlck1vZHVsZUluc3RhbGwocmVzcG9uc2UpIHtcbiAgICAgICAgaWYgKHJlc3BvbnNlLnJlc3VsdCA9PT0gdHJ1ZSAmJiByZXNwb25zZS5kYXRhLmZpbGVQYXRoICE9PScnKSB7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pbml0aWFsaXplKHJlc3BvbnNlLmRhdGEuZmlsZVBhdGgsICByZXNwb25zZS5kYXRhLm1vZHVsZVdhc0VuYWJsZWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkVycm9yKTtcbiAgICAgICAgICAgIGFkZE5ld0V4dGVuc2lvbi4kdXBsb2FkQnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgIH1cbiAgICB9LFxufTsiXX0=
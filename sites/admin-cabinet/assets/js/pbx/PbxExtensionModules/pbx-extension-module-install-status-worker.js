"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Monitors status of module installation
 *
 */
var installStatusLoopWorker = {
  timeOut: 1000,
  timeOutHandle: '',
  filePath: '',
  iterations: 0,
  oldPercent: '0',
  needEnableAfterInstall: false,
  initialize: function initialize(filePath) {
    var needEnable = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
    installStatusLoopWorker.filePath = filePath;
    installStatusLoopWorker.iterations = 0;
    installStatusLoopWorker.needEnableAfterInstall = needEnable;
    installStatusLoopWorker.restartWorker();
  },
  restartWorker: function restartWorker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    installStatusLoopWorker.worker();
  },
  worker: function worker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    PbxApi.SystemGetModuleInstallationStatus(installStatusLoopWorker.filePath, installStatusLoopWorker.cbAfterReceiveNewStatus);
  },
  cbAfterReceiveNewStatus: function cbAfterReceiveNewStatus(response) {
    installStatusLoopWorker.iterations += 1;
    installStatusLoopWorker.timeoutHandle = window.setTimeout(installStatusLoopWorker.worker, installStatusLoopWorker.timeOut); // Check installation status

    if (response === false && installStatusLoopWorker.iterations < 50) {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    } else if (installStatusLoopWorker.iterations > 50 || response.i_status === 'INSTALLATION_ERROR' || response.i_status === 'PROGRESS_FILE_NOT_FOUND') {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
      var errorMessage = response.i_error !== undefined ? response.i_error : '';
      errorMessage = errorMessage.replace(/\n/g, '<br>');
      UserMessage.showMultiString(errorMessage, globalTranslate.ext_InstallationError);
    } else if (response.i_status === 'INSTALLATION_IN_PROGRESS') {
      if (installStatusLoopWorker.oldPercent !== response.i_status_progress) {
        installStatusLoopWorker.iterations = 0;
      }

      installStatusLoopWorker.oldPercent = response.d_status_progress;
    } else if (response.i_status === 'INSTALLATION_COMPLETE') {
      if (installStatusLoopWorker.needEnableAfterInstall) {
        PbxApi.SystemEnableModule(installStatusLoopWorker.moduleUniqid, function () {
          window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
        });
      } else {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }

      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZmlsZVBhdGgiLCJpdGVyYXRpb25zIiwib2xkUGVyY2VudCIsIm5lZWRFbmFibGVBZnRlckluc3RhbGwiLCJpbml0aWFsaXplIiwibmVlZEVuYWJsZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiUGJ4QXBpIiwiU3lzdGVtR2V0TW9kdWxlSW5zdGFsbGF0aW9uU3RhdHVzIiwiY2JBZnRlclJlY2VpdmVOZXdTdGF0dXMiLCJyZXNwb25zZSIsInNldFRpbWVvdXQiLCJpX3N0YXR1cyIsImVycm9yTWVzc2FnZSIsImlfZXJyb3IiLCJ1bmRlZmluZWQiLCJyZXBsYWNlIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfSW5zdGFsbGF0aW9uRXJyb3IiLCJpX3N0YXR1c19wcm9ncmVzcyIsImRfc3RhdHVzX3Byb2dyZXNzIiwiU3lzdGVtRW5hYmxlTW9kdWxlIiwibW9kdWxlVW5pcWlkIiwibG9jYXRpb24iLCJnbG9iYWxSb290VXJsIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUMvQkMsRUFBQUEsT0FBTyxFQUFFLElBRHNCO0FBRS9CQyxFQUFBQSxhQUFhLEVBQUUsRUFGZ0I7QUFHL0JDLEVBQUFBLFFBQVEsRUFBRSxFQUhxQjtBQUkvQkMsRUFBQUEsVUFB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RCxNQU9PO0FBQ052QixRQUFBQSxNQUFNLENBQUNzQixRQUFQLGFBQXFCQyxhQUFyQjtBQUNBOztBQUNEdkIsTUFBQUEsTUFBTSxDQUFDQyxZQUFQLENBQW9CWCx1QkFBdUIsQ0FBQ1ksYUFBNUM7QUFDQTtBQUNEO0FBMUQ4QixDQUFoQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMCBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgUGJ4QXBpLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlICovXG5cbi8qKlxuICogTW9uaXRvcnMgc3RhdHVzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb25cbiAqXG4gKi9cbmNvbnN0IGluc3RhbGxTdGF0dXNMb29wV29ya2VyID0ge1xuXHR0aW1lT3V0OiAxMDAwLFxuXHR0aW1lT3V0SGFuZGxlOiAnJyxcblx0ZmlsZVBhdGg6ICcnLFxuXHRpdGVyYXRpb25zOiAwLFxuXHRvbGRQZXJjZW50OiAnMCcsXG5cdG5lZWRFbmFibGVBZnRlckluc3RhbGw6IGZhbHNlLFxuXHRpbml0aWFsaXplKGZpbGVQYXRoLCBuZWVkRW5hYmxlPWZhbHNlKSB7XG5cdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuZmlsZVBhdGggPSBmaWxlUGF0aDtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID0gMDtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5uZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsID0gbmVlZEVuYWJsZTtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG5cdH0sXG5cdHJlc3RhcnRXb3JrZXIoKSB7XG5cdFx0d2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci53b3JrZXIoKTtcblx0fSxcblx0d29ya2VyKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0UGJ4QXBpLlN5c3RlbUdldE1vZHVsZUluc3RhbGxhdGlvblN0YXR1cyhcblx0XHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmZpbGVQYXRoLFxuXHRcdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2JBZnRlclJlY2VpdmVOZXdTdGF0dXNcblx0XHQpO1xuXHR9LFxuXHRjYkFmdGVyUmVjZWl2ZU5ld1N0YXR1cyhyZXNwb25zZSkge1xuXHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgKz0gMTtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlID1cblx0XHRcdHdpbmRvdy5zZXRUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLndvcmtlciwgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZU91dCk7XG5cdFx0Ly8gQ2hlY2sgaW5zdGFsbGF0aW9uIHN0YXR1c1xuXHRcdGlmIChyZXNwb25zZSA9PT0gZmFsc2Vcblx0XHRcdCYmIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPCA1MCkge1xuXHRcdFx0d2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHR9IGVsc2UgaWYgKGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPiA1MFxuXHRcdFx0fHwgcmVzcG9uc2UuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fRVJST1InXG5cdFx0XHR8fCByZXNwb25zZS5pX3N0YXR1cyA9PT0gJ1BST0dSRVNTX0ZJTEVfTk9UX0ZPVU5EJ1xuXHRcdCkge1xuXHRcdFx0d2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHRcdGxldCBlcnJvck1lc3NhZ2UgPSAocmVzcG9uc2UuaV9lcnJvciAhPT0gdW5kZWZpbmVkKSA/IHJlc3BvbnNlLmlfZXJyb3IgOiAnJztcblx0XHRcdGVycm9yTWVzc2FnZSA9IGVycm9yTWVzc2FnZS5yZXBsYWNlKC9cXG4vZywgJzxicj4nKTtcblx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhlcnJvck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuXHRcdH0gZWxzZSBpZiAocmVzcG9uc2UuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fSU5fUFJPR1JFU1MnKSB7XG5cdFx0XHRpZiAoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIub2xkUGVyY2VudCAhPT0gcmVzcG9uc2UuaV9zdGF0dXNfcHJvZ3Jlc3MpIHtcblx0XHRcdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA9IDA7XG5cdFx0XHR9XG5cdFx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5vbGRQZXJjZW50ID0gcmVzcG9uc2UuZF9zdGF0dXNfcHJvZ3Jlc3M7XG5cdFx0fSBlbHNlIGlmIChyZXNwb25zZS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9DT01QTEVURScpIHtcblx0XHRcdGlmIChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5uZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsKSB7XG5cdFx0XHRcdFBieEFwaS5TeXN0ZW1FbmFibGVNb2R1bGUoXG5cdFx0XHRcdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIubW9kdWxlVW5pcWlkLFxuXHRcdFx0XHRcdCgpID0+IHtcblx0XHRcdFx0XHRcdHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9cGJ4LWV4dGVuc2lvbi1tb2R1bGVzL2luZGV4L2A7XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9cGJ4LWV4dGVuc2lvbi1tb2R1bGVzL2luZGV4L2A7XG5cdFx0XHR9XG5cdFx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH1cblx0fSxcbn07XG4iXX0=
"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalTranslate, Extensions,Form, SoundFilesSelector */

/**
 * callQueue module.
 * @module callQueue
 */
var callQueue = {
  // Default extension number
  defaultExtension: '',
  // The input field for the extension number
  $extension: $('#extension'),
  // List of available members for this call queue
  AvailableMembersList: [],

  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#queue-form'),
  // The accordion UI components in the form
  $accordions: $('#queue-form .ui.accordion'),
  // The dropdown UI components in the form
  $dropDowns: $('#queue-form .dropdown'),
  // The field for form error messages
  $errorMessages: $('#form-error-messages'),
  // The checkbox UI components in the form
  $checkBoxes: $('#queue-form .checkbox'),
  // The select for forwarding in the form
  forwardingSelect: '#queue-form .forwarding-select',
  // The button to delete a row
  $deleteRowButton: $('.delete-row-button'),
  // The dropdown for periodic announce sound selection
  $periodicAnnounceDropdown: $('#queue-form .periodic-announce-sound-id-select'),
  // The row of the member
  memberRow: '#queue-form .member-row',
  // The dropdown for extension selection
  $extensionSelectDropdown: $('#extensionselect'),
  // The table of extensions
  $extensionsTable: $('#extensionsTable'),

  /**
   * Validation rules for the form fields before submission.
   *
   * @type {object}
   */
  validateRules: {
    name: {
      identifier: 'name',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.cq_ValidateNameEmpty
      }]
    },
    extension: {
      identifier: 'extension',
      rules: [{
        type: 'number',
        prompt: globalTranslate.cq_ValidateExtensionNumber
      }, {
        type: 'empty',
        prompt: globalTranslate.cq_ValidateExtensionEmpty
      }, {
        type: 'existRule[extension-error]',
        prompt: globalTranslate.cq_ValidateExtensionDouble
      }]
    }
  },

  /**
   * Initialize the call queue form
   */
  initialize: function initialize() {
    // Get phone extensions and set available queue members
    Extensions.getPhoneExtensions(callQueue.setAvailableQueueMembers); // Initialize UI components

    callQueue.$accordions.accordion();
    callQueue.$dropDowns.dropdown();
    callQueue.$checkBoxes.checkbox(); // Set up periodic announce dropdown behaviour

    callQueue.$periodicAnnounceDropdown.dropdown({
      onChange: function onChange(value) {
        if (parseInt(value, 10) === -1) {
          callQueue.$periodicAnnounceDropdown.dropdown('clear');
        }
      }
    }); // Initialize forwarding select

    $(callQueue.forwardingSelect).dropdown(Extensions.getDropdownSettingsWithEmpty()); // Set up dynamic availability check for extension number

    callQueue.$extension.on('change', function () {
      var newNumber = callQueue.$formObj.form('get value', 'extension');
      Extensions.checkAvailability(callQueue.defaultNumber, newNumber);
    }); // Initialize drag and drop for extension table rows

    callQueue.initializeDragAndDropExtensionTableRows(); // Set up row deletion from queue members table

    callQueue.$deleteRowButton.on('click', function (e) {
      e.preventDefault();
      $(e.target).closest('tr').remove();
      callQueue.reinitializeExtensionSelect();
      callQueue.updateExtensionTableView();
      Form.dataChanged();
      return false;
    }); // Initialize audio message select

    $('#queue-form .audio-message-select').dropdown(SoundFilesSelector.getDropdownSettingsWithEmpty()); // Initialize the form

    callQueue.initializeForm(); // Set the default extension number

    callQueue.defaultExtension = callQueue.$formObj.form('get value', 'extension');
  },

  /**
   * Set available members for the call queue
   * @param {Object} arrResult - The list of available members
   */
  setAvailableQueueMembers: function setAvailableQueueMembers(arrResult) {
    // Loop through the result and populate AvailableMembersList
    $.each(arrResult.results, function (index, extension) {
      callQueue.AvailableMembersList.push({
        number: extension.value,
        callerid: extension.name
      });
    }); // Reinitialize the extension select and update the view

    callQueue.reinitializeExtensionSelect();
    callQueue.updateExtensionTableView();
  },

  /**
   * Return the list of available members for the queue
   * @returns {Array} - The list of available members
   */
  getAvailableQueueMembers: function getAvailableQueueMembers() {
    var result = []; // Loop through available members and add to result if not already selected

    callQueue.AvailableMembersList.forEach(function (member) {
      if ($(".member-row#".concat(member.number)).length === 0) {
        result.push({
          name: member.callerid,
          value: member.number
        });
      }
    }); // result.sort((a, b) => ((a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0)));

    return result;
  },

  /**
   * Reinitialize extension select with consideration for already selected members
   */
  reinitializeExtensionSelect: function reinitializeExtensionSelect() {
    // Setup dropdown with available queue members
    callQueue.$extensionSelectDropdown.dropdown({
      action: 'hide',
      forceSelection: false,
      onChange: function onChange(value, text) {
        // If a value is selected
        if (value) {
          // Get the last template row, clone it and populate with the selected member data
          var $tr = $('.member-row-tpl').last();
          var $clone = $tr.clone(true);
          $clone.removeClass('member-row-tpl').addClass('member-row').show();
          $clone.attr('id', value);
          $clone.find('.number').html(value);
          $clone.find('.callerid').html(text); // Insert the new member row into the table

          if ($(callQueue.memberRow).last().length === 0) {
            $tr.after($clone);
          } else {
            $(callQueue.memberRow).last().after($clone);
          } // Reinitialize the extension select and update the view


          callQueue.reinitializeExtensionSelect();
          callQueue.updateExtensionTableView();
          Form.dataChanged();
        }
      },
      // Set the values for the dropdown
      values: callQueue.getAvailableQueueMembers()
    });
  },

  /**
   * Initialize Drag and Drop functionality for the extension table rows
   */
  initializeDragAndDropExtensionTableRows: function initializeDragAndDropExtensionTableRows() {
    callQueue.$extensionsTable.tableDnD({
      onDragClass: 'hoveringRow',
      // CSS class to be applied while a row is being dragged
      dragHandle: '.dragHandle',
      // Class of the handler to initiate the drag action
      onDrop: function onDrop() {
        // Callback to be executed after a row has been dropped
        // Trigger change event to acknowledge the modification
        Form.dataChanged();
      }
    });
  },

  /**
   * Display a placeholder if the table has zero rows
   */
  updateExtensionTableView: function updateExtensionTableView() {
    // Placeholder to be displayed
    var dummy = "<tr class=\"dummy\"><td colspan=\"4\" class=\"center aligned\">".concat(globalTranslate.cq_AddQueueMembers, "</td></tr>");

    if ($(callQueue.memberRow).length === 0) {
      $('#extensionsTable tbody').append(dummy); // Add the placeholder if there are no rows
    } else {
      $('#extensionsTable tbody .dummy').remove(); // Remove the placeholder if rows are present
    }
  },

  /**
   * Callback function to be called before the form is sent
   * @param {Object} settings - The current settings of the form
   * @returns {Object} - The updated settings of the form
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings; // Retrieve form values

    result.data = callQueue.$formObj.form('get values');
    var arrMembers = []; // Iterate through each member row and add to arrMembers

    $(callQueue.memberRow).each(function (index, obj) {
      if ($(obj).attr('id')) {
        arrMembers.push({
          number: $(obj).attr('id'),
          priority: index
        });
      }
    }); // Validate if any members exist

    if (arrMembers.length === 0) {
      result = false;
      callQueue.$errorMessages.html(globalTranslate.cq_ValidateNoExtensions);
      callQueue.$formObj.addClass('error');
    } else {
      result.data.members = JSON.stringify(arrMembers);
    }

    return result;
  },

  /**
   * Callback function to be called after the form has been sent.
   * @param {Object} response - The response from the server after the form is sent
   */
  cbAfterSendForm: function cbAfterSendForm(response) {
    callQueue.defaultNumber = callQueue.$formObj.form('get value', 'extension');
  },

  /**
   * Initialize the form with custom settings
   */
  initializeForm: function initializeForm() {
    Form.$formObj = callQueue.$formObj;
    Form.url = "".concat(globalRootUrl, "call-queues/save"); // Form submission URL

    Form.validateRules = callQueue.validateRules; // Form validation rules

    Form.cbBeforeSendForm = callQueue.cbBeforeSendForm; // Callback before form is sent

    Form.cbAfterSendForm = callQueue.cbAfterSendForm; // Callback after form is sent

    Form.initialize();
  }
};
/**
 * Checks if the number is taken by another account
 * @returns {boolean} True if the parameter has the 'hidden' class, false otherwise
 */

$.fn.form.settings.rules.existRule = function (value, parameter) {
  return $("#".concat(parameter)).hasClass('hidden');
};
/**
 *  Initialize Call Queues modify form on document ready
 */


$(document).ready(function () {
  callQueue.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9DYWxsUXVldWVzL2NhbGxxdWV1ZS1tb2RpZnkuanMiXSwibmFtZXMiOlsiY2FsbFF1ZXVlIiwiZGVmYXVsdEV4dGVuc2lvbiIsIiRleHRlbnNpb24iLCIkIiwiQXZhaWxhYmxlTWVtYmVyc0xpc3QiLCIkZm9ybU9iaiIsIiRhY2NvcmRpb25zIiwiJGRyb3BEb3ducyIsIiRlcnJvck1lc3NhZ2VzIiwiJGNoZWNrQm94ZXMiLCJmb3J3YXJkaW5nU2VsZWN0IiwiJGRlbGV0ZVJvd0J1dHRvbiIsIiRwZXJpb2RpY0Fubm91bmNlRHJvcGRvd24iLCJtZW1iZXJSb3ciLCIkZXh0ZW5zaW9uU2VsZWN0RHJvcGRvd24iLCIkZXh0ZW5zaW9uc1RhYmxlIiwidmFsaWRhdGVSdWxlcyIsIm5hbWUiLCJpZGVudGlmaWVyIiwicnVsZXMiLCJ0eXBlIiwicHJvbXB0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiY3FfVmFsaWRhdGVOYW1lRW1wdHkiLCJleHRlbnNpb24iLCJjcV9WYWxpZGF0ZUV4dGVuc2lvbk51bWJlciIsImNxX1ZhbGlkYXRlRXh0ZW5zaW9uRW1wdHkiLCJjcV9WYWxpZGF0ZUV4dGVuc2lvbkRvdWJsZSIsImluaXRpYWxpemUiLCJFeHRlbnNpb25zIiwiZ2V0UGhvbmVFeHRlbnNpb25zIiwic2V0QXZhaWxhYmxlUXVldWVNZW1iZXJzIiwiYWNjb3JkaW9uIiwiZHJvcGRvd24iLCJjaGVja2JveCIsIm9uQ2hhbmdlIiwidmFsdWUiLCJwYXJzZUludCIsImdldERyb3Bkb3duU2V0dGluZ3NXaXRoRW1wdHkiLCJvbiIsIm5ld051bWJlciIsImZvcm0iLCJjaGVja0F2YWlsYWJpbGl0eSIsImRlZmF1bHROdW1iZXIiLCJpbml0aWFsaXplRHJhZ0FuZERyb3BFeHRlbnNpb25UYWJsZVJvd3MiLCJlIiwicHJldmVudERlZmF1bHQiLCJ0YXJnZXQiLCJjbG9zZXN0IiwicmVtb3ZlIiwicmVpbml0aWFsaXplRXh0ZW5zaW9uU2VsZWN0IiwidXBkYXRlRXh0ZW5zaW9uVGFibGVWaWV3IiwiRm9ybSIsImRhdGFDaGFuZ2VkIiwiU291bmRGaWxlc1NlbGVjdG9yIiwiaW5pdGlhbGl6ZUZvcm0iLCJhcnJSZXN1bHQiLCJlYWNoIiwicmVzdWx0cyIsImluZGV4IiwicHVzaCIsIm51bWJlciIsImNhbGxlcmlkIiwiZ2V0QXZhaWxhYmxlUXVldWVNZW1iZXJzIiwicmVzdWx0IiwiZm9yRWFjaCIsIm1lbWJlciIsImxlbmd0aCIsImFjdGlvbiIsImZvcmNlU2VsZWN0aW9uIiwidGV4dCIsIiR0ciIsImxhc3QiLCIkY2xvbmUiLCJjbG9uZSIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJzaG93IiwiYXR0ciIsImZpbmQiLCJodG1sIiwiYWZ0ZXIiLCJ2YWx1ZXMiLCJ0YWJsZURuRCIsIm9uRHJhZ0NsYXNzIiwiZHJhZ0hhbmRsZSIsIm9uRHJvcCIsImR1bW15IiwiY3FfQWRkUXVldWVNZW1iZXJzIiwiYXBwZW5kIiwiY2JCZWZvcmVTZW5kRm9ybSIsInNldHRpbmdzIiwiZGF0YSIsImFyck1lbWJlcnMiLCJvYmoiLCJwcmlvcml0eSIsImNxX1ZhbGlkYXRlTm9FeHRlbnNpb25zIiwibWVtYmVycyIsIkpTT04iLCJzdHJpbmdpZnkiLCJjYkFmdGVyU2VuZEZvcm0iLCJyZXNwb25zZSIsInVybCIsImdsb2JhbFJvb3RVcmwiLCJmbiIsImV4aXN0UnVsZSIsInBhcmFtZXRlciIsImhhc0NsYXNzIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsU0FBUyxHQUFHO0FBRWQ7QUFDQUMsRUFBQUEsZ0JBQWdCLEVBQUUsRUFISjtBQUtkO0FBQ0FDLEVBQUFBLFVBQVUsRUFBRUMsQ0FBQyxDQUFDLFlBQUQsQ0FOQztBQVFkO0FBQ0FDLEVBQUFB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QUFDOUNvQyxJQUFBQSxJQUFJLENBQUNzQyxnQkFBTCxHQUF3QjFGLFNBQVMsQ0FBQzBGLGdCQUFsQyxDQUphLENBSXdDOztBQUNyRHRDLElBQUFBLElBQUksQ0FBQ2dELGVBQUwsR0FBdUJwRyxTQUFTLENBQUNvRyxlQUFqQyxDQUxhLENBS3NDOztBQUNuRGhELElBQUFBLElBQUksQ0FBQ3hCLFVBQUw7QUFDSDtBQXhTYSxDQUFsQjtBQTJTQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQXpCLENBQUMsQ0FBQ3FHLEVBQUYsQ0FBSy9ELElBQUwsQ0FBVWtELFFBQVYsQ0FBbUJ4RSxLQUFuQixDQUF5QnNGLFNBQXpCLEdBQXFDLFVBQUNyRSxLQUFELEVBQVFzRSxTQUFSO0FBQUEsU0FBc0J2RyxDQUFDLFlBQUt1RyxTQUFMLEVBQUQsQ0FBbUJDLFFBQW5CLENBQTRCLFFBQTVCLENBQXRCO0FBQUEsQ0FBckM7QUFHQTtBQUNBO0FBQ0E7OztBQUNBeEcsQ0FBQyxDQUFDeUcsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQjdHLEVBQUFBLFNBQVMsQ0FBQzRCLFVBQVY7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIGdsb2JhbFRyYW5zbGF0ZSwgRXh0ZW5zaW9ucyxGb3JtLCBTb3VuZEZpbGVzU2VsZWN0b3IgKi9cblxuXG4vKipcbiAqIGNhbGxRdWV1ZSBtb2R1bGUuXG4gKiBAbW9kdWxlIGNhbGxRdWV1ZVxuICovXG5jb25zdCBjYWxsUXVldWUgPSB7XG5cbiAgICAvLyBEZWZhdWx0IGV4dGVuc2lvbiBudW1iZXJcbiAgICBkZWZhdWx0RXh0ZW5zaW9uOiAnJyxcblxuICAgIC8vIFRoZSBpbnB1dCBmaWVsZCBmb3IgdGhlIGV4dGVuc2lvbiBudW1iZXJcbiAgICAkZXh0ZW5zaW9uOiAkKCcjZXh0ZW5zaW9uJyksXG5cbiAgICAvLyBMaXN0IG9mIGF2YWlsYWJsZSBtZW1iZXJzIGZvciB0aGlzIGNhbGwgcXVldWVcbiAgICBBdmFpbGFibGVNZW1iZXJzTGlzdDogW10sXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjcXVldWUtZm9ybScpLFxuXG4gICAgLy8gVGhlIGFjY29yZGlvbiBVSSBjb21wb25lbnRzIGluIHRoZSBmb3JtXG4gICAgJGFjY29yZGlvbnM6ICQoJyNxdWV1ZS1mb3JtIC51aS5hY2NvcmRpb24nKSxcblxuICAgIC8vIFRoZSBkcm9wZG93biBVSSBjb21wb25lbnRzIGluIHRoZSBmb3JtXG4gICAgJGRyb3BEb3duczogJCgnI3F1ZXVlLWZvcm0gLmRyb3Bkb3duJyksXG5cbiAgICAvLyBUaGUgZmllbGQgZm9yIGZvcm0gZXJyb3IgbWVzc2FnZXNcbiAgICAkZXJyb3JNZXNzYWdlczogJCgnI2Zvcm0tZXJyb3ItbWVzc2FnZXMnKSxcblxuICAgIC8vIFRoZSBjaGVja2JveCBVSSBjb21wb25lbnRzIGluIHRoZSBmb3JtXG4gICAgJGNoZWNrQm94ZXM6ICQoJyNxdWV1ZS1mb3JtIC5jaGVja2JveCcpLFxuXG4gICAgLy8gVGhlIHNlbGVjdCBmb3IgZm9yd2FyZGluZyBpbiB0aGUgZm9ybVxuICAgIGZvcndhcmRpbmdTZWxlY3Q6ICcjcXVldWUtZm9ybSAuZm9yd2FyZGluZy1zZWxlY3QnLFxuXG4gICAgLy8gVGhlIGJ1dHRvbiB0byBkZWxldGUgYSByb3dcbiAgICAkZGVsZXRlUm93QnV0dG9uOiAkKCcuZGVsZXRlLXJvdy1idXR0b24nKSxcblxuICAgIC8vIFRoZSBkcm9wZG93biBmb3IgcGVyaW9kaWMgYW5ub3VuY2Ugc291bmQgc2VsZWN0aW9uXG4gICAgJHBlcmlvZGljQW5ub3VuY2VEcm9wZG93bjogJCgnI3F1ZXVlLWZvcm0gLnBlcmlvZGljLWFubm91bmNlLXNvdW5kLWlkLXNlbGVjdCcpLFxuXG4gICAgLy8gVGhlIHJvdyBvZiB0aGUgbWVtYmVyXG4gICAgbWVtYmVyUm93OiAnI3F1ZXVlLWZvcm0gLm1lbWJlci1yb3cnLFxuXG4gICAgLy8gVGhlIGRyb3Bkb3duIGZvciBleHRlbnNpb24gc2VsZWN0aW9uXG4gICAgJGV4dGVuc2lvblNlbGVjdERyb3Bkb3duOiAkKCcjZXh0ZW5zaW9uc2VsZWN0JyksXG5cbiAgICAvLyBUaGUgdGFibGUgb2YgZXh0ZW5zaW9uc1xuICAgICRleHRlbnNpb25zVGFibGU6ICQoJyNleHRlbnNpb25zVGFibGUnKSxcblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRpb24gcnVsZXMgZm9yIHRoZSBmb3JtIGZpZWxkcyBiZWZvcmUgc3VibWlzc2lvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtvYmplY3R9XG4gICAgICovXG4gICAgdmFsaWRhdGVSdWxlczoge1xuICAgICAgICBuYW1lOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnbmFtZScsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VtcHR5JyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUuY3FfVmFsaWRhdGVOYW1lRW1wdHksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIGV4dGVuc2lvbjoge1xuICAgICAgICAgICAgaWRlbnRpZmllcjogJ2V4dGVuc2lvbicsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ251bWJlcicsXG4gICAgICAgICAgICAgICAgICAgIHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmNxX1ZhbGlkYXRlRXh0ZW5zaW9uTnVtYmVyLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZW1wdHknLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5jcV9WYWxpZGF0ZUV4dGVuc2lvbkVtcHR5LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZXhpc3RSdWxlW2V4dGVuc2lvbi1lcnJvcl0nLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5jcV9WYWxpZGF0ZUV4dGVuc2lvbkRvdWJsZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgY2FsbCBxdWV1ZSBmb3JtXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgLy8gR2V0IHBob25lIGV4dGVuc2lvbnMgYW5kIHNldCBhdmFpbGFibGUgcXVldWUgbWVtYmVyc1xuICAgICAgICBFeHRlbnNpb25zLmdldFBob25lRXh0ZW5zaW9ucyhjYWxsUXVldWUuc2V0QXZhaWxhYmxlUXVldWVNZW1iZXJzKTtcblxuICAgICAgICAvLyBJbml0aWFsaXplIFVJIGNvbXBvbmVudHNcbiAgICAgICAgY2FsbFF1ZXVlLiRhY2NvcmRpb25zLmFjY29yZGlvbigpO1xuICAgICAgICBjYWxsUXVldWUuJGRyb3BEb3ducy5kcm9wZG93bigpO1xuICAgICAgICBjYWxsUXVldWUuJGNoZWNrQm94ZXMuY2hlY2tib3goKTtcblxuICAgICAgICAvLyBTZXQgdXAgcGVyaW9kaWMgYW5ub3VuY2UgZHJvcGRvd24gYmVoYXZpb3VyXG4gICAgICAgIGNhbGxRdWV1ZS4kcGVyaW9kaWNBbm5vdW5jZURyb3Bkb3duLmRyb3Bkb3duKHtcbiAgICAgICAgICAgIG9uQ2hhbmdlKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcnNlSW50KHZhbHVlLCAxMCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxRdWV1ZS4kcGVyaW9kaWNBbm5vdW5jZURyb3Bkb3duLmRyb3Bkb3duKCdjbGVhcicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgZm9yd2FyZGluZyBzZWxlY3RcbiAgICAgICAgJChjYWxsUXVldWUuZm9yd2FyZGluZ1NlbGVjdCkuZHJvcGRvd24oRXh0ZW5zaW9ucy5nZXREcm9wZG93blNldHRpbmdzV2l0aEVtcHR5KCkpO1xuXG4gICAgICAgIC8vIFNldCB1cCBkeW5hbWljIGF2YWlsYWJpbGl0eSBjaGVjayBmb3IgZXh0ZW5zaW9uIG51bWJlclxuICAgICAgICBjYWxsUXVldWUuJGV4dGVuc2lvbi5vbignY2hhbmdlJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV3TnVtYmVyID0gY2FsbFF1ZXVlLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICdleHRlbnNpb24nKTtcbiAgICAgICAgICAgIEV4dGVuc2lvbnMuY2hlY2tBdmFpbGFiaWxpdHkoY2FsbFF1ZXVlLmRlZmF1bHROdW1iZXIsIG5ld051bWJlcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgZHJhZyBhbmQgZHJvcCBmb3IgZXh0ZW5zaW9uIHRhYmxlIHJvd3NcbiAgICAgICAgY2FsbFF1ZXVlLmluaXRpYWxpemVEcmFnQW5kRHJvcEV4dGVuc2lvblRhYmxlUm93cygpO1xuXG4gICAgICAgIC8vIFNldCB1cCByb3cgZGVsZXRpb24gZnJvbSBxdWV1ZSBtZW1iZXJzIHRhYmxlXG4gICAgICAgIGNhbGxRdWV1ZS4kZGVsZXRlUm93QnV0dG9uLm9uKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAkKGUudGFyZ2V0KS5jbG9zZXN0KCd0cicpLnJlbW92ZSgpO1xuICAgICAgICAgICAgY2FsbFF1ZXVlLnJlaW5pdGlhbGl6ZUV4dGVuc2lvblNlbGVjdCgpO1xuICAgICAgICAgICAgY2FsbFF1ZXVlLnVwZGF0ZUV4dGVuc2lvblRhYmxlVmlldygpO1xuICAgICAgICAgICAgRm9ybS5kYXRhQ2hhbmdlZCgpO1xuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgYXVkaW8gbWVzc2FnZSBzZWxlY3RcbiAgICAgICAgJCgnI3F1ZXVlLWZvcm0gLmF1ZGlvLW1lc3NhZ2Utc2VsZWN0JykuZHJvcGRvd24oU291bmRGaWxlc1NlbGVjdG9yLmdldERyb3Bkb3duU2V0dGluZ3NXaXRoRW1wdHkoKSk7XG5cbiAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgZm9ybVxuICAgICAgICBjYWxsUXVldWUuaW5pdGlhbGl6ZUZvcm0oKTtcblxuICAgICAgICAvLyBTZXQgdGhlIGRlZmF1bHQgZXh0ZW5zaW9uIG51bWJlclxuICAgICAgICBjYWxsUXVldWUuZGVmYXVsdEV4dGVuc2lvbiA9IGNhbGxRdWV1ZS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCdleHRlbnNpb24nKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU2V0IGF2YWlsYWJsZSBtZW1iZXJzIGZvciB0aGUgY2FsbCBxdWV1ZVxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBhcnJSZXN1bHQgLSBUaGUgbGlzdCBvZiBhdmFpbGFibGUgbWVtYmVyc1xuICAgICAqL1xuICAgIHNldEF2YWlsYWJsZVF1ZXVlTWVtYmVycyhhcnJSZXN1bHQpIHtcbiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIHRoZSByZXN1bHQgYW5kIHBvcHVsYXRlIEF2YWlsYWJsZU1lbWJlcnNMaXN0XG4gICAgICAgICQuZWFjaChhcnJSZXN1bHQucmVzdWx0cywgKGluZGV4LCBleHRlbnNpb24pID0+IHtcbiAgICAgICAgICAgIGNhbGxRdWV1ZS5BdmFpbGFibGVNZW1iZXJzTGlzdC5wdXNoKHtcbiAgICAgICAgICAgICAgICBudW1iZXI6IGV4dGVuc2lvbi52YWx1ZSxcbiAgICAgICAgICAgICAgICBjYWxsZXJpZDogZXh0ZW5zaW9uLm5hbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUmVpbml0aWFsaXplIHRoZSBleHRlbnNpb24gc2VsZWN0IGFuZCB1cGRhdGUgdGhlIHZpZXdcbiAgICAgICAgY2FsbFF1ZXVlLnJlaW5pdGlhbGl6ZUV4dGVuc2lvblNlbGVjdCgpO1xuICAgICAgICBjYWxsUXVldWUudXBkYXRlRXh0ZW5zaW9uVGFibGVWaWV3KCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0aGUgbGlzdCBvZiBhdmFpbGFibGUgbWVtYmVycyBmb3IgdGhlIHF1ZXVlXG4gICAgICogQHJldHVybnMge0FycmF5fSAtIFRoZSBsaXN0IG9mIGF2YWlsYWJsZSBtZW1iZXJzXG4gICAgICovXG4gICAgZ2V0QXZhaWxhYmxlUXVldWVNZW1iZXJzKCkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcblxuICAgICAgICAvLyBMb29wIHRocm91Z2ggYXZhaWxhYmxlIG1lbWJlcnMgYW5kIGFkZCB0byByZXN1bHQgaWYgbm90IGFscmVhZHkgc2VsZWN0ZWRcbiAgICAgICAgY2FsbFF1ZXVlLkF2YWlsYWJsZU1lbWJlcnNMaXN0LmZvckVhY2goKG1lbWJlcikgPT4ge1xuICAgICAgICAgICAgaWYgKCQoYC5tZW1iZXItcm93IyR7bWVtYmVyLm51bWJlcn1gKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG1lbWJlci5jYWxsZXJpZCxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG1lbWJlci5udW1iZXIsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyByZXN1bHQuc29ydCgoYSwgYikgPT4gKChhLm5hbWUgPiBiLm5hbWUpID8gMSA6ICgoYi5uYW1lID4gYS5uYW1lKSA/IC0xIDogMCkpKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVpbml0aWFsaXplIGV4dGVuc2lvbiBzZWxlY3Qgd2l0aCBjb25zaWRlcmF0aW9uIGZvciBhbHJlYWR5IHNlbGVjdGVkIG1lbWJlcnNcbiAgICAgKi9cbiAgICByZWluaXRpYWxpemVFeHRlbnNpb25TZWxlY3QoKSB7XG4gICAgICAgIC8vIFNldHVwIGRyb3Bkb3duIHdpdGggYXZhaWxhYmxlIHF1ZXVlIG1lbWJlcnNcbiAgICAgICAgY2FsbFF1ZXVlLiRleHRlbnNpb25TZWxlY3REcm9wZG93bi5kcm9wZG93bih7XG4gICAgICAgICAgICBhY3Rpb246ICdoaWRlJyxcbiAgICAgICAgICAgIGZvcmNlU2VsZWN0aW9uOiBmYWxzZSxcbiAgICAgICAgICAgIG9uQ2hhbmdlKHZhbHVlLCB0ZXh0KSB7XG4gICAgICAgICAgICAgICAgLy8gSWYgYSB2YWx1ZSBpcyBzZWxlY3RlZFxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIGxhc3QgdGVtcGxhdGUgcm93LCBjbG9uZSBpdCBhbmQgcG9wdWxhdGUgd2l0aCB0aGUgc2VsZWN0ZWQgbWVtYmVyIGRhdGFcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgJHRyID0gJCgnLm1lbWJlci1yb3ctdHBsJykubGFzdCgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCAkY2xvbmUgPSAkdHIuY2xvbmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICRjbG9uZVxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdtZW1iZXItcm93LXRwbCcpXG4gICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ21lbWJlci1yb3cnKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgJGNsb25lLmF0dHIoJ2lkJywgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAkY2xvbmUuZmluZCgnLm51bWJlcicpLmh0bWwodmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAkY2xvbmUuZmluZCgnLmNhbGxlcmlkJykuaHRtbCh0ZXh0KTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBJbnNlcnQgdGhlIG5ldyBtZW1iZXIgcm93IGludG8gdGhlIHRhYmxlXG4gICAgICAgICAgICAgICAgICAgIGlmICgkKGNhbGxRdWV1ZS5tZW1iZXJSb3cpLmxhc3QoKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICR0ci5hZnRlcigkY2xvbmUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgJChjYWxsUXVldWUubWVtYmVyUm93KS5sYXN0KCkuYWZ0ZXIoJGNsb25lKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIFJlaW5pdGlhbGl6ZSB0aGUgZXh0ZW5zaW9uIHNlbGVjdCBhbmQgdXBkYXRlIHRoZSB2aWV3XG4gICAgICAgICAgICAgICAgICAgIGNhbGxRdWV1ZS5yZWluaXRpYWxpemVFeHRlbnNpb25TZWxlY3QoKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbFF1ZXVlLnVwZGF0ZUV4dGVuc2lvblRhYmxlVmlldygpO1xuXG4gICAgICAgICAgICAgICAgICAgIEZvcm0uZGF0YUNoYW5nZWQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gU2V0IHRoZSB2YWx1ZXMgZm9yIHRoZSBkcm9wZG93blxuICAgICAgICAgICAgdmFsdWVzOiBjYWxsUXVldWUuZ2V0QXZhaWxhYmxlUXVldWVNZW1iZXJzKCksXG5cbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgRHJhZyBhbmQgRHJvcCBmdW5jdGlvbmFsaXR5IGZvciB0aGUgZXh0ZW5zaW9uIHRhYmxlIHJvd3NcbiAgICAgKi9cbiAgICBpbml0aWFsaXplRHJhZ0FuZERyb3BFeHRlbnNpb25UYWJsZVJvd3MoKSB7XG4gICAgICAgIGNhbGxRdWV1ZS4kZXh0ZW5zaW9uc1RhYmxlLnRhYmxlRG5EKHtcbiAgICAgICAgICAgIG9uRHJhZ0NsYXNzOiAnaG92ZXJpbmdSb3cnLCAgLy8gQ1NTIGNsYXNzIHRvIGJlIGFwcGxpZWQgd2hpbGUgYSByb3cgaXMgYmVpbmcgZHJhZ2dlZFxuICAgICAgICAgICAgZHJhZ0hhbmRsZTogJy5kcmFnSGFuZGxlJywgIC8vIENsYXNzIG9mIHRoZSBoYW5kbGVyIHRvIGluaXRpYXRlIHRoZSBkcmFnIGFjdGlvblxuICAgICAgICAgICAgb25Ecm9wOiAoKSA9PiB7IC8vIENhbGxiYWNrIHRvIGJlIGV4ZWN1dGVkIGFmdGVyIGEgcm93IGhhcyBiZWVuIGRyb3BwZWRcbiAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIGNoYW5nZSBldmVudCB0byBhY2tub3dsZWRnZSB0aGUgbW9kaWZpY2F0aW9uXG4gICAgICAgICAgICAgICAgRm9ybS5kYXRhQ2hhbmdlZCgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIERpc3BsYXkgYSBwbGFjZWhvbGRlciBpZiB0aGUgdGFibGUgaGFzIHplcm8gcm93c1xuICAgICAqL1xuICAgIHVwZGF0ZUV4dGVuc2lvblRhYmxlVmlldygpIHtcbiAgICAgICAgLy8gUGxhY2Vob2xkZXIgdG8gYmUgZGlzcGxheWVkXG4gICAgICAgIGNvbnN0IGR1bW15ID0gYDx0ciBjbGFzcz1cImR1bW15XCI+PHRkIGNvbHNwYW49XCI0XCIgY2xhc3M9XCJjZW50ZXIgYWxpZ25lZFwiPiR7Z2xvYmFsVHJhbnNsYXRlLmNxX0FkZFF1ZXVlTWVtYmVyc308L3RkPjwvdHI+YDtcblxuICAgICAgICBpZiAoJChjYWxsUXVldWUubWVtYmVyUm93KS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICQoJyNleHRlbnNpb25zVGFibGUgdGJvZHknKS5hcHBlbmQoZHVtbXkpOyAvLyBBZGQgdGhlIHBsYWNlaG9sZGVyIGlmIHRoZXJlIGFyZSBubyByb3dzXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAkKCcjZXh0ZW5zaW9uc1RhYmxlIHRib2R5IC5kdW1teScpLnJlbW92ZSgpOyAvLyBSZW1vdmUgdGhlIHBsYWNlaG9sZGVyIGlmIHJvd3MgYXJlIHByZXNlbnRcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYmVmb3JlIHRoZSBmb3JtIGlzIHNlbnRcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgLSBUaGUgY3VycmVudCBzZXR0aW5ncyBvZiB0aGUgZm9ybVxuICAgICAqIEByZXR1cm5zIHtPYmplY3R9IC0gVGhlIHVwZGF0ZWQgc2V0dGluZ3Mgb2YgdGhlIGZvcm1cbiAgICAgKi9cbiAgICBjYkJlZm9yZVNlbmRGb3JtKHNldHRpbmdzKSB7XG4gICAgICAgIGxldCByZXN1bHQgPSBzZXR0aW5ncztcblxuICAgICAgICAvLyBSZXRyaWV2ZSBmb3JtIHZhbHVlc1xuICAgICAgICByZXN1bHQuZGF0YSA9IGNhbGxRdWV1ZS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG5cbiAgICAgICAgY29uc3QgYXJyTWVtYmVycyA9IFtdO1xuXG4gICAgICAgIC8vIEl0ZXJhdGUgdGhyb3VnaCBlYWNoIG1lbWJlciByb3cgYW5kIGFkZCB0byBhcnJNZW1iZXJzXG4gICAgICAgICQoY2FsbFF1ZXVlLm1lbWJlclJvdykuZWFjaCgoaW5kZXgsIG9iaikgPT4ge1xuICAgICAgICAgICAgaWYgKCQob2JqKS5hdHRyKCdpZCcpKSB7XG4gICAgICAgICAgICAgICAgYXJyTWVtYmVycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiAkKG9iaikuYXR0cignaWQnKSxcbiAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IGluZGV4LFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBWYWxpZGF0ZSBpZiBhbnkgbWVtYmVycyBleGlzdFxuICAgICAgICBpZiAoYXJyTWVtYmVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlO1xuICAgICAgICAgICAgY2FsbFF1ZXVlLiRlcnJvck1lc3NhZ2VzLmh0bWwoZ2xvYmFsVHJhbnNsYXRlLmNxX1ZhbGlkYXRlTm9FeHRlbnNpb25zKTtcbiAgICAgICAgICAgIGNhbGxRdWV1ZS4kZm9ybU9iai5hZGRDbGFzcygnZXJyb3InKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdC5kYXRhLm1lbWJlcnMgPSBKU09OLnN0cmluZ2lmeShhcnJNZW1iZXJzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBhZnRlciB0aGUgZm9ybSBoYXMgYmVlbiBzZW50LlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgYWZ0ZXIgdGhlIGZvcm0gaXMgc2VudFxuICAgICAqL1xuICAgIGNiQWZ0ZXJTZW5kRm9ybShyZXNwb25zZSkge1xuICAgICAgICBjYWxsUXVldWUuZGVmYXVsdE51bWJlciA9IGNhbGxRdWV1ZS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCdleHRlbnNpb24nKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgZm9ybSB3aXRoIGN1c3RvbSBzZXR0aW5nc1xuICAgICAqL1xuICAgIGluaXRpYWxpemVGb3JtKCkge1xuICAgICAgICBGb3JtLiRmb3JtT2JqID0gY2FsbFF1ZXVlLiRmb3JtT2JqO1xuICAgICAgICBGb3JtLnVybCA9IGAke2dsb2JhbFJvb3RVcmx9Y2FsbC1xdWV1ZXMvc2F2ZWA7ICAvLyBGb3JtIHN1Ym1pc3Npb24gVVJMXG4gICAgICAgIEZvcm0udmFsaWRhdGVSdWxlcyA9IGNhbGxRdWV1ZS52YWxpZGF0ZVJ1bGVzOyAvLyBGb3JtIHZhbGlkYXRpb24gcnVsZXNcbiAgICAgICAgRm9ybS5jYkJlZm9yZVNlbmRGb3JtID0gY2FsbFF1ZXVlLmNiQmVmb3JlU2VuZEZvcm07ICAvLyBDYWxsYmFjayBiZWZvcmUgZm9ybSBpcyBzZW50XG4gICAgICAgIEZvcm0uY2JBZnRlclNlbmRGb3JtID0gY2FsbFF1ZXVlLmNiQWZ0ZXJTZW5kRm9ybTsgIC8vIENhbGxiYWNrIGFmdGVyIGZvcm0gaXMgc2VudFxuICAgICAgICBGb3JtLmluaXRpYWxpemUoKTtcbiAgICB9LFxufTtcblxuLyoqXG4gKiBDaGVja3MgaWYgdGhlIG51bWJlciBpcyB0YWtlbiBieSBhbm90aGVyIGFjY291bnRcbiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIHRoZSBwYXJhbWV0ZXIgaGFzIHRoZSAnaGlkZGVuJyBjbGFzcywgZmFsc2Ugb3RoZXJ3aXNlXG4gKi9cbiQuZm4uZm9ybS5zZXR0aW5ncy5ydWxlcy5leGlzdFJ1bGUgPSAodmFsdWUsIHBhcmFtZXRlcikgPT4gJChgIyR7cGFyYW1ldGVyfWApLmhhc0NsYXNzKCdoaWRkZW4nKTtcblxuXG4vKipcbiAqICBJbml0aWFsaXplIENhbGwgUXVldWVzIG1vZGlmeSBmb3JtIG9uIGRvY3VtZW50IHJlYWR5XG4gKi9cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBjYWxsUXVldWUuaW5pdGlhbGl6ZSgpO1xufSk7XG5cbiJdfQ==
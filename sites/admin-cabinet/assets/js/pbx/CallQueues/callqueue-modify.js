"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalTranslate, Extensions,Form, SoundFilesSelector */
// Проверка нет ли ошибки занятого другой учеткой номера
$.fn.form.settings.rules.existRule = function (value, parameter) {
  return $("#".concat(parameter)).hasClass('hidden');
};

var callQueue = {
  defaultExtension: '',
  $number: $('#extension'),
  $dirrtyField: $('#dirrty'),
  AvailableMembersList: [],
  $formObj: $('#queue-form'),
  $accordions: $('#queue-form .ui.accordion'),
  $dropDowns: $('#queue-form .dropdown'),
  $errorMessages: $('#form-error-messages'),
  $checkBoxes: $('#queue-form .checkbox'),
  forwardingSelect: '#queue-form .forwarding-select',
  $deleteRowButton: $('.delete-row-button'),
  $periodicAnnounceDropdown: $('#queue-form .periodic-announce-sound-id-select'),
  memberRow: '#queue-form .member-row',
  $extensionSelectDropdown: $('#extensionselect'),
  $extensionsTable: $('#extensionsTable'),
  validateRules: {
    name: {
      identifier: 'name',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.cq_ValidateNameEmpty
      }]
    },
    extension: {
      identifier: 'extension',
      rules: [{
        type: 'number',
        prompt: globalTranslate.cq_ValidateExtensionNumber
      }, {
        type: 'empty',
        prompt: globalTranslate.cq_ValidateExtensionEmpty
      }, {
        type: 'existRule[extension-error]',
        prompt: globalTranslate.cq_ValidateExtensionDouble
      }]
    }
  },
  initialize: function initialize() {
    Extensions.getPhoneExtensions(callQueue.setAvailableQueueMembers);
    callQueue.defaultExtension = $('#extension').val();
    callQueue.$accordions.accordion();
    callQueue.$dropDowns.dropdown();
    callQueue.$checkBoxes.checkbox();
    callQueue.$periodicAnnounceDropdown.dropdown({
      onChange: function onChange(value) {
        if (parseInt(value, 10) === -1) {
          callQueue.$periodicAnnounceDropdown.dropdown('clear');
        }
      }
    });
    $(callQueue.forwardingSelect).dropdown(Extensions.getDropdownSettingsWithEmpty()); // Динамическая прововерка свободен ли внутренний номер

    callQueue.$number.on('change', function () {
      var newNumber = callQueue.$formObj.form('get value', 'extension');
      Extensions.checkAvailability(callQueue.defaultNumber, newNumber);
    });
    callQueue.initializeDragAndDropExtensionTableRows(); // Удаление строки из таблицы участников очереди

    callQueue.$deleteRowButton.on('click', function (e) {
      $(e.target).closest('tr').remove();
      callQueue.reinitializeExtensionSelect();
      callQueue.updateExtensionTableView();
      callQueue.$dirrtyField.val(Math.random());
      callQueue.$dirrtyField.trigger('change');
      e.preventDefault();
      return false;
    });
    $('#queue-form .audio-message-select').dropdown(SoundFilesSelector.getDropdownSettingsWithEmpty());
    callQueue.initializeForm();
  },
  setAvailableQueueMembers: function setAvailableQueueMembers(arrResult) {
    $.each(arrResult.results, function (index, extension) {
      callQueue.AvailableMembersList.push({
        number: extension.value,
        callerid: extension.name
      });
    });
    callQueue.reinitializeExtensionSelect();
    callQueue.updateExtensionTableView();
  },
  // Вернуть список доступных членов очереди
  getAvailableQueueMembers: function getAvailableQueueMembers() {
    var result = [];
    callQueue.AvailableMembersList.forEach(function (member) {
      if ($(".member-row#".concat(member.number)).length === 0) {
        result.push({
          name: member.callerid,
          value: member.number
        });
      }
    }); // result.sort((a, b) => ((a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0)));

    return result;
  },
  // Пересобрать членов очереди с учетом уже выбранных
  reinitializeExtensionSelect: function reinitializeExtensionSelect() {
    callQueue.$extensionSelectDropdown.dropdown({
      action: 'hide',
      forceSelection: false,
      onChange: function onChange(value, text) {
        if (value) {
          var $tr = $('.member-row-tpl').last();
          var $clone = $tr.clone(true);
          $clone.removeClass('member-row-tpl').addClass('member-row').show();
          $clone.attr('id', value);
          $clone.find('.number').html(value);
          $clone.find('.callerid').html(text);

          if ($(callQueue.memberRow).last().length === 0) {
            $tr.after($clone);
          } else {
            $(callQueue.memberRow).last().after($clone);
          }

          callQueue.reinitializeExtensionSelect();
          callQueue.updateExtensionTableView();
          callQueue.$dirrtyField.val(Math.random());
          callQueue.$dirrtyField.trigger('change');
        }
      },
      values: callQueue.getAvailableQueueMembers()
    });
  },
  // Включить возможность перетаскивания элементов таблицы участников очереди
  initializeDragAndDropExtensionTableRows: function initializeDragAndDropExtensionTableRows() {
    callQueue.$extensionsTable.tableDnD({
      onDragClass: 'hoveringRow',
      dragHandle: '.dragHandle',
      onDrop: function onDrop() {
        callQueue.$dirrtyField.val(Math.random());
        callQueue.$dirrtyField.trigger('change');
      }
    });
  },
  // Отобразить заглушку если в таблице 0 строк
  updateExtensionTableView: function updateExtensionTableView() {
    var dummy = "<tr class=\"dummy\"><td colspan=\"4\" class=\"center aligned\">".concat(globalTranslate.cq_AddQueueMembers, "</td></tr>");

    if ($(callQueue.memberRow).length === 0) {
      $('#extensionsTable tbody').append(dummy);
    } else {
      $('#extensionsTable tbody .dummy').remove();
    }
  },
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = callQueue.$formObj.form('get values');
    var arrMembers = [];
    $(callQueue.memberRow).each(function (index, obj) {
      if ($(obj).attr('id')) {
        arrMembers.push({
          number: $(obj).attr('id'),
          priority: index
        });
      }
    });

    if (arrMembers.length === 0) {
      result = false;
      callQueue.$errorMessages.html(globalTranslate.cq_ValidateNoExtensions);
      callQueue.$formObj.addClass('error');
    } else {
      result.data.members = JSON.stringify(arrMembers);
    }

    return result;
  },
  cbAfterSendForm: function cbAfterSendForm() {
    callQueue.defaultNumber = callQueue.$number.val();
  },
  initializeForm: function initializeForm() {
    Form.$formObj = callQueue.$formObj;
    Form.url = "".concat(globalRootUrl, "call-queues/save");
    Form.validateRules = callQueue.validateRules;
    Form.cbBeforeSendForm = callQueue.cbBeforeSendForm;
    Form.cbAfterSendForm = callQueue.cbAfterSendForm;
    Form.initialize();
  }
};
$(document).ready(function () {
  callQueue.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9DYWxsUXVldWVzL2NhbGxxdWV1ZS1tb2RpZnkuanMiXSwibmFtZXMiOlsiJCIsImZuIiwiZm9ybSIsInNldHRpbmdzIiwicnVsZXMiLCJleGlzdFJ1bGUiLCJ2YWx1ZSIsInBhcmFtZXRlciIsImhhc0NsYXNzIiwiY2FsbFF1ZXVlIiwiZGVmYXVsdEV4dGVuc2lvbiIsIiRudW1iZXIiLCIkZGlycnR5RmllbGQiLCJBdmFpbGFibGVNZW1iZXJzTGlzdCIsIiRmb3JtT2JqIiwiJGFjY29yZGlvbnMiLCIkZHJvcERvd25zIiwiJGVycm9yTWVzc2FnZXMiLCIkY2hlY2tCb3hlcyIsImZvcndhcmRpbmdTZWxlY3QiLCIkZGVsZXRlUm93QnV0dG9uIiwiJHBlcmlvZGljQW5ub3VuY2VEcm9wZG93biIsIm1lbWJlclJvdyIsIiRleHRlbnNpb25TZWxlY3REcm9wZG93biIsIiRleHRlbnNpb25zVGFibGUiLCJ2YWxpZGF0ZVJ1bGVzIiwibmFtZSIsImlkZW50aWZpZXIiLCJ0eXBlIiwicHJvbXB0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiY3FfVmFsaWRhdGVOYW1lRW1wdHkiLCJleHRlbnNpb24iLCJjcV9WYWxpZGF0ZUV4dGVuc2lvbk51bWJlciIsImNxX1ZhbGlkYXRlRXh0ZW5zaW9uRW1wdHkiLCJjcV9WYWxpZGF0ZUV4dGVuc2lvbkRvdWJsZSIsImluaXRpYWxpemUiLCJFeHRlbnNpb25zIiwiZ2V0UGhvbmVFeHRlbnNpb25zIiwic2V0QXZhaWxhYmxlUXVldWVNZW1iZXJzIiwidmFsIiwiYWNjb3JkaW9uIiwiZHJvcGRvd24iLCJjaGVja2JveCIsIm9uQ2hhbmdlIiwicGFyc2VJbnQiLCJnZXREcm9wZG93blNldHRpbmdzV2l0aEVtcHR5Iiwib24iLCJuZXdOdW1iZXIiLCJjaGVja0F2YWlsYWJpbGl0eSIsImRlZmF1bHROdW1iZXIiLCJpbml0aWFsaXplRHJhZ0FuZERyb3BFeHRlbnNpb25UYWJsZVJvd3MiLCJlIiwidGFyZ2V0IiwiY2xvc2VzdCIsInJlbW92ZSIsInJlaW5pdGlhbGl6ZUV4dGVuc2lvblNlbGVjdCIsInVwZGF0ZUV4dGVuc2lvblRhYmxlVmlldyIsIk1hdGgiLCJyYW5kb20iLCJ0cmlnZ2VyIiwicHJldmVudERlZmF1bHQiLCJTb3VuZEZpbGVzU2VsZWN0b3IiLCJpbml0aWFsaXplRm9ybSIsImFyclJlc3VsdCIsImVhY2giLCJyZXN1bHRzIiwiaW5kZXgiLCJwdXNoIiwibnVtYmVyIiwiY2FsbGVyaWQiLCJnZXRBdmFpbGFibGVRdWV1ZU1lbWJlcnMiLCJyZXN1bHQiLCJmb3JFYWNoIiwibWVtYmVyIiwibGVuZ3RoIiwiYWN0aW9uIiwiZm9yY2VTZWxlY3Rpb24iLCJ0ZXh0IiwiJHRyIiwibGFzdCIsIiRjbG9uZSIsImNsb25lIiwicmVtb3ZlQ2xhc3MiLCJhZGRDbGFzcyIsInNob3ciLCJhdHRyIiwiZmluZCIsImh0bWwiLCJhZnRlciIsInZhbHVlcyIsInRhYmxlRG5EIiwib25EcmFnQ2xhc3MiLCJkcmFnSGFuZGxlIiwib25Ecm9wIiwiZHVtbXkiLCJjcV9BZGRRdWV1ZU1lbWJlcnMiLCJhcHBlbmQiLCJjYkJlZm9yZVNlbmRGb3JtIiwiZGF0YSIsImFyck1lbWJlcnMiLCJvYmoiLCJwcmlvcml0eSIsImNxX1ZhbGlkYXRlTm9FeHRlbnNpb25zIiwibWVtYmVycyIsIkpTT04iLCJzdHJpbmdpZnkiLCJjYkFmdGVyU2VuZEZvcm0iLCJGb3JtIiwidXJsIiwiZ2xvYmFsUm9vdFVybCIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUVBO0FBQ0FBLENBQUMsQ0FBQ0MsRUFBRixDQUFLQyxJQUFMLENBQVVDLFFBQVYsQ0FBbUJDLEtBQW5CLENBQXlCQyxTQUF6QixHQUFxQyxVQUFDQyxLQUFELEVBQVFDLFNBQVI7QUFBQSxTQUFzQlAsQ0FBQyxZ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LFNBQVMsQ0FBQ3lGLGdCQUFsQztBQUNBVSxJQUFBQSxJQUFJLENBQUNELGVBQUwsR0FBdUJsRyxTQUFTLENBQUNrRyxlQUFqQztBQUNBQyxJQUFBQSxJQUFJLENBQUN4RSxVQUFMO0FBQ0E7QUE5TGdCLENBQWxCO0FBaU1BcEMsQ0FBQyxDQUFDK0csUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUN2QnZHLEVBQUFBLFNBQVMsQ0FBQzJCLFVBQVY7QUFDQSxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCAoQykgMjAxNy0yMDIwIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBnbG9iYWxUcmFuc2xhdGUsIEV4dGVuc2lvbnMsRm9ybSwgU291bmRGaWxlc1NlbGVjdG9yICovXG5cbi8vINCf0YDQvtCy0LXRgNC60LAg0L3QtdGCINC70Lgg0L7RiNC40LHQutC4INC30LDQvdGP0YLQvtCz0L4g0LTRgNGD0LPQvtC5INGD0YfQtdGC0LrQvtC5INC90L7QvNC10YDQsFxuJC5mbi5mb3JtLnNldHRpbmdzLnJ1bGVzLmV4aXN0UnVsZSA9ICh2YWx1ZSwgcGFyYW1ldGVyKSA9PiAkKGAjJHtwYXJhbWV0ZXJ9YCkuaGFzQ2xhc3MoJ2hpZGRlbicpO1xuXG5jb25zdCBjYWxsUXVldWUgPSB7XG5cdGRlZmF1bHRFeHRlbnNpb246ICcnLFxuXHQkbnVtYmVyOiAkKCcjZXh0ZW5zaW9uJyksXG5cdCRkaXJydHlGaWVsZDogJCgnI2RpcnJ0eScpLFxuXHRBdmFpbGFibGVNZW1iZXJzTGlzdDogW10sXG5cdCRmb3JtT2JqOiAkKCcjcXVldWUtZm9ybScpLFxuXHQkYWNjb3JkaW9uczogJCgnI3F1ZXVlLWZvcm0gLnVpLmFjY29yZGlvbicpLFxuXHQkZHJvcERvd25zOiAkKCcjcXVldWUtZm9ybSAuZHJvcGRvd24nKSxcblx0JGVycm9yTWVzc2FnZXM6ICQoJyNmb3JtLWVycm9yLW1lc3NhZ2VzJyksXG5cdCRjaGVja0JveGVzOiAkKCcjcXVldWUtZm9ybSAuY2hlY2tib3gnKSxcblx0Zm9yd2FyZGluZ1NlbGVjdDogJyNxdWV1ZS1mb3JtIC5mb3J3YXJkaW5nLXNlbGVjdCcsXG5cdCRkZWxldGVSb3dCdXR0b246ICQoJy5kZWxldGUtcm93LWJ1dHRvbicpLFxuXHQkcGVyaW9kaWNBbm5vdW5jZURyb3Bkb3duOiAkKCcjcXVldWUtZm9ybSAucGVyaW9kaWMtYW5ub3VuY2Utc291bmQtaWQtc2VsZWN0JyksXG5cdG1lbWJlclJvdzogJyNxdWV1ZS1mb3JtIC5tZW1iZXItcm93Jyxcblx0JGV4dGVuc2lvblNlbGVjdERyb3Bkb3duOiAkKCcjZXh0ZW5zaW9uc2VsZWN0JyksXG5cdCRleHRlbnNpb25zVGFibGU6ICQoJyNleHRlbnNpb25zVGFibGUnKSxcblx0dmFsaWRhdGVSdWxlczoge1xuXHRcdG5hbWU6IHtcblx0XHRcdGlkZW50aWZpZXI6ICduYW1lJyxcblx0XHRcdHJ1bGVzOiBbXG5cdFx0XHRcdHtcblx0XHRcdFx0XHR0eXBlOiAnZW1wdHknLFxuXHRcdFx0XHRcdHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmNxX1ZhbGlkYXRlTmFtZUVtcHR5LFxuXHRcdFx0XHR9LFxuXHRcdFx0XSxcblx0XHR9LFxuXHRcdGV4dGVuc2lvbjoge1xuXHRcdFx0aWRlbnRpZmllcjogJ2V4dGVuc2lvbicsXG5cdFx0XHRydWxlczogW1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0dHlwZTogJ251bWJlcicsXG5cdFx0XHRcdFx0cHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUuY3FfVmFsaWRhdGVFeHRlbnNpb25OdW1iZXIsXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHR0eXBlOiAnZW1wdHknLFxuXHRcdFx0XHRcdHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmNxX1ZhbGlkYXRlRXh0ZW5zaW9uRW1wdHksXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHR0eXBlOiAnZXhpc3RSdWxlW2V4dGVuc2lvbi1lcnJvcl0nLFxuXHRcdFx0XHRcdHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmNxX1ZhbGlkYXRlRXh0ZW5zaW9uRG91YmxlLFxuXHRcdFx0XHR9LFxuXHRcdFx0XSxcblx0XHR9LFxuXHR9LFxuXHRpbml0aWFsaXplKCkge1xuXHRcdEV4dGVuc2lvbnMuZ2V0UGhvbmVFeHRlbnNpb25zKGNhbGxRdWV1ZS5zZXRBdmFpbGFibGVRdWV1ZU1lbWJlcnMpO1xuXHRcdGNhbGxRdWV1ZS5kZWZhdWx0RXh0ZW5zaW9uID0gJCgnI2V4dGVuc2lvbicpLnZhbCgpO1xuXHRcdGNhbGxRdWV1ZS4kYWNjb3JkaW9ucy5hY2NvcmRpb24oKTtcblx0XHRjYWxsUXVldWUuJGRyb3BEb3ducy5kcm9wZG93bigpO1xuXHRcdGNhbGxRdWV1ZS4kY2hlY2tCb3hlcy5jaGVja2JveCgpO1xuXHRcdGNhbGxRdWV1ZS4kcGVyaW9kaWNBbm5vdW5jZURyb3Bkb3duLmRyb3Bkb3duKHtcblx0XHRcdG9uQ2hhbmdlKHZhbHVlKSB7XG5cdFx0XHRcdGlmIChwYXJzZUludCh2YWx1ZSwgMTApID09PSAtMSkge1xuXHRcdFx0XHRcdGNhbGxRdWV1ZS4kcGVyaW9kaWNBbm5vdW5jZURyb3Bkb3duLmRyb3Bkb3duKCdjbGVhcicpO1xuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdH0pO1xuXHRcdCQoY2FsbFF1ZXVlLmZvcndhcmRpbmdTZWxlY3QpLmRyb3Bkb3duKEV4dGVuc2lvbnMuZ2V0RHJvcGRvd25TZXR0aW5nc1dpdGhFbXB0eSgpKTtcblx0XHQvLyDQlNC40L3QsNC80LjRh9C10YHQutCw0Y8g0L/RgNC+0LLQvtCy0LXRgNC60LAg0YHQstC+0LHQvtC00LXQvSDQu9C4INCy0L3Rg9GC0YDQtdC90L3QuNC5INC90L7QvNC10YBcblx0XHRjYWxsUXVldWUuJG51bWJlci5vbignY2hhbmdlJywgKCkgPT4ge1xuXHRcdFx0Y29uc3QgbmV3TnVtYmVyID0gY2FsbFF1ZXVlLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICdleHRlbnNpb24nKTtcblx0XHRcdEV4dGVuc2lvbnMuY2hlY2tBdmFpbGFiaWxpdHkoY2FsbFF1ZXVlLmRlZmF1bHROdW1iZXIsIG5ld051bWJlcik7XG5cdFx0fSk7XG5cblx0XHRjYWxsUXVldWUuaW5pdGlhbGl6ZURyYWdBbmREcm9wRXh0ZW5zaW9uVGFibGVSb3dzKCk7XG5cblx0XHQvLyDQo9C00LDQu9C10L3QuNC1INGB0YLRgNC+0LrQuCDQuNC3INGC0LDQsdC70LjRhtGLINGD0YfQsNGB0YLQvdC40LrQvtCyINC+0YfQtdGA0LXQtNC4XG5cdFx0Y2FsbFF1ZXVlLiRkZWxldGVSb3dCdXR0b24ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdCQoZS50YXJnZXQpLmNsb3Nlc3QoJ3RyJykucmVtb3ZlKCk7XG5cdFx0XHRjYWxsUXVldWUucmVpbml0aWFsaXplRXh0ZW5zaW9uU2VsZWN0KCk7XG5cdFx0XHRjYWxsUXVldWUudXBkYXRlRXh0ZW5zaW9uVGFibGVWaWV3KCk7XG5cdFx0XHRjYWxsUXVldWUuJGRpcnJ0eUZpZWxkLnZhbChNYXRoLnJhbmRvbSgpKTtcblx0XHRcdGNhbGxRdWV1ZS4kZGlycnR5RmllbGQudHJpZ2dlcignY2hhbmdlJyk7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fSk7XG5cblx0XHQkKCcjcXVldWUtZm9ybSAuYXVkaW8tbWVzc2FnZS1zZWxlY3QnKS5kcm9wZG93bihTb3VuZEZpbGVzU2VsZWN0b3IuZ2V0RHJvcGRvd25TZXR0aW5nc1dpdGhFbXB0eSgpKTtcblx0XHRjYWxsUXVldWUuaW5pdGlhbGl6ZUZvcm0oKTtcblx0fSxcblx0c2V0QXZhaWxhYmxlUXVldWVNZW1iZXJzKGFyclJlc3VsdCkge1xuXHRcdCQuZWFjaChhcnJSZXN1bHQucmVzdWx0cywgKGluZGV4LCBleHRlbnNpb24pID0+IHtcblx0XHRcdGNhbGxRdWV1ZS5BdmFpbGFibGVNZW1iZXJzTGlzdC5wdXNoKHtcblx0XHRcdFx0bnVtYmVyOiBleHRlbnNpb24udmFsdWUsXG5cdFx0XHRcdGNhbGxlcmlkOiBleHRlbnNpb24ubmFtZSxcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHRcdGNhbGxRdWV1ZS5yZWluaXRpYWxpemVFeHRlbnNpb25TZWxlY3QoKTtcblx0XHRjYWxsUXVldWUudXBkYXRlRXh0ZW5zaW9uVGFibGVWaWV3KCk7XG5cdH0sXG5cdC8vINCS0LXRgNC90YPRgtGMINGB0L/QuNGB0L7QuiDQtNC+0YHRgtGD0L/QvdGL0YUg0YfQu9C10L3QvtCyINC+0YfQtdGA0LXQtNC4XG5cdGdldEF2YWlsYWJsZVF1ZXVlTWVtYmVycygpIHtcblx0XHRjb25zdCByZXN1bHQgPSBbXTtcblx0XHRjYWxsUXVldWUuQXZhaWxhYmxlTWVtYmVyc0xpc3QuZm9yRWFjaCgobWVtYmVyKSA9PiB7XG5cdFx0XHRpZiAoJChgLm1lbWJlci1yb3cjJHttZW1iZXIubnVtYmVyfWApLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0XHRyZXN1bHQucHVzaCh7XG5cdFx0XHRcdFx0bmFtZTogbWVtYmVyLmNhbGxlcmlkLFxuXHRcdFx0XHRcdHZhbHVlOiBtZW1iZXIubnVtYmVyLFxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHQvLyByZXN1bHQuc29ydCgoYSwgYikgPT4gKChhLm5hbWUgPiBiLm5hbWUpID8gMSA6ICgoYi5uYW1lID4gYS5uYW1lKSA/IC0xIDogMCkpKTtcblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9LFxuXHQvLyDQn9C10YDQtdGB0L7QsdGA0LDRgtGMINGH0LvQtdC90L7QsiDQvtGH0LXRgNC10LTQuCDRgSDRg9GH0LXRgtC+0Lwg0YPQttC1INCy0YvQsdGA0LDQvdC90YvRhVxuXHRyZWluaXRpYWxpemVFeHRlbnNpb25TZWxlY3QoKSB7XG5cdFx0Y2FsbFF1ZXVlLiRleHRlbnNpb25TZWxlY3REcm9wZG93bi5kcm9wZG93bih7XG5cdFx0XHRhY3Rpb246ICdoaWRlJyxcblx0XHRcdGZvcmNlU2VsZWN0aW9uOiBmYWxzZSxcblx0XHRcdG9uQ2hhbmdlKHZhbHVlLCB0ZXh0KSB7XG5cdFx0XHRcdGlmICh2YWx1ZSkge1xuXHRcdFx0XHRcdGNvbnN0ICR0ciA9ICQoJy5tZW1iZXItcm93LXRwbCcpLmxhc3QoKTtcblx0XHRcdFx0XHRjb25zdCAkY2xvbmUgPSAkdHIuY2xvbmUodHJ1ZSk7XG5cdFx0XHRcdFx0JGNsb25lXG5cdFx0XHRcdFx0XHQucmVtb3ZlQ2xhc3MoJ21lbWJlci1yb3ctdHBsJylcblx0XHRcdFx0XHRcdC5hZGRDbGFzcygnbWVtYmVyLXJvdycpXG5cdFx0XHRcdFx0XHQuc2hvdygpO1xuXHRcdFx0XHRcdCRjbG9uZS5hdHRyKCdpZCcsIHZhbHVlKTtcblx0XHRcdFx0XHQkY2xvbmUuZmluZCgnLm51bWJlcicpLmh0bWwodmFsdWUpO1xuXHRcdFx0XHRcdCRjbG9uZS5maW5kKCcuY2FsbGVyaWQnKS5odG1sKHRleHQpO1xuXHRcdFx0XHRcdGlmICgkKGNhbGxRdWV1ZS5tZW1iZXJSb3cpLmxhc3QoKS5sZW5ndGggPT09IDApIHtcblx0XHRcdFx0XHRcdCR0ci5hZnRlcigkY2xvbmUpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHQkKGNhbGxRdWV1ZS5tZW1iZXJSb3cpLmxhc3QoKS5hZnRlcigkY2xvbmUpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGNhbGxRdWV1ZS5yZWluaXRpYWxpemVFeHRlbnNpb25TZWxlY3QoKTtcblx0XHRcdFx0XHRjYWxsUXVldWUudXBkYXRlRXh0ZW5zaW9uVGFibGVWaWV3KCk7XG5cdFx0XHRcdFx0Y2FsbFF1ZXVlLiRkaXJydHlGaWVsZC52YWwoTWF0aC5yYW5kb20oKSk7XG5cdFx0XHRcdFx0Y2FsbFF1ZXVlLiRkaXJydHlGaWVsZC50cmlnZ2VyKCdjaGFuZ2UnKTtcblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHRcdHZhbHVlczogY2FsbFF1ZXVlLmdldEF2YWlsYWJsZVF1ZXVlTWVtYmVycygpLFxuXG5cdFx0fSk7XG5cdH0sIC8vINCS0LrQu9GO0YfQuNGC0Ywg0LLQvtC30LzQvtC20L3QvtGB0YLRjCDQv9C10YDQtdGC0LDRgdC60LjQstCw0L3QuNGPINGN0LvQtdC80LXQvdGC0L7QsiDRgtCw0LHQu9C40YbRiyDRg9GH0LDRgdGC0L3QuNC60L7QsiDQvtGH0LXRgNC10LTQuFxuXG5cdGluaXRpYWxpemVEcmFnQW5kRHJvcEV4dGVuc2lvblRhYmxlUm93cygpIHtcblx0XHRjYWxsUXVldWUuJGV4dGVuc2lvbnNUYWJsZS50YWJsZURuRCh7XG5cdFx0XHRvbkRyYWdDbGFzczogJ2hvdmVyaW5nUm93Jyxcblx0XHRcdGRyYWdIYW5kbGU6ICcuZHJhZ0hhbmRsZScsXG5cdFx0XHRvbkRyb3A6ICgpID0+IHtcblx0XHRcdFx0Y2FsbFF1ZXVlLiRkaXJydHlGaWVsZC52YWwoTWF0aC5yYW5kb20oKSk7XG5cdFx0XHRcdGNhbGxRdWV1ZS4kZGlycnR5RmllbGQudHJpZ2dlcignY2hhbmdlJyk7XG5cdFx0XHR9LFxuXHRcdH0pO1xuXHR9LFxuXG5cdC8vINCe0YLQvtCx0YDQsNC30LjRgtGMINC30LDQs9C70YPRiNC60YMg0LXRgdC70Lgg0LIg0YLQsNCx0LvQuNGG0LUgMCDRgdGC0YDQvtC6XG5cdHVwZGF0ZUV4dGVuc2lvblRhYmxlVmlldygpIHtcblx0XHRjb25zdCBkdW1teSA9IGA8dHIgY2xhc3M9XCJkdW1teVwiPjx0ZCBjb2xzcGFuPVwiNFwiIGNsYXNzPVwiY2VudGVyIGFsaWduZWRcIj4ke2dsb2JhbFRyYW5zbGF0ZS5jcV9BZGRRdWV1ZU1lbWJlcnN9PC90ZD48L3RyPmA7XG5cblx0XHRpZiAoJChjYWxsUXVldWUubWVtYmVyUm93KS5sZW5ndGggPT09IDApIHtcblx0XHRcdCQoJyNleHRlbnNpb25zVGFibGUgdGJvZHknKS5hcHBlbmQoZHVtbXkpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHQkKCcjZXh0ZW5zaW9uc1RhYmxlIHRib2R5IC5kdW1teScpLnJlbW92ZSgpO1xuXHRcdH1cblx0fSxcblx0Y2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncykge1xuXHRcdGxldCByZXN1bHQgPSBzZXR0aW5ncztcblx0XHRyZXN1bHQuZGF0YSA9IGNhbGxRdWV1ZS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG5cdFx0Y29uc3QgYXJyTWVtYmVycyA9IFtdO1xuXHRcdCQoY2FsbFF1ZXVlLm1lbWJlclJvdykuZWFjaCgoaW5kZXgsIG9iaikgPT4ge1xuXHRcdFx0aWYgKCQob2JqKS5hdHRyKCdpZCcpKSB7XG5cdFx0XHRcdGFyck1lbWJlcnMucHVzaCh7XG5cdFx0XHRcdFx0bnVtYmVyOiAkKG9iaikuYXR0cignaWQnKSxcblx0XHRcdFx0XHRwcmlvcml0eTogaW5kZXgsXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdGlmIChhcnJNZW1iZXJzLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0cmVzdWx0ID0gZmFsc2U7XG5cdFx0XHRjYWxsUXVldWUuJGVycm9yTWVzc2FnZXMuaHRtbChnbG9iYWxUcmFuc2xhdGUuY3FfVmFsaWRhdGVOb0V4dGVuc2lvbnMpO1xuXHRcdFx0Y2FsbFF1ZXVlLiRmb3JtT2JqLmFkZENsYXNzKCdlcnJvcicpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXN1bHQuZGF0YS5tZW1iZXJzID0gSlNPTi5zdHJpbmdpZnkoYXJyTWVtYmVycyk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fSxcblx0Y2JBZnRlclNlbmRGb3JtKCkge1xuXHRcdGNhbGxRdWV1ZS5kZWZhdWx0TnVtYmVyID0gY2FsbFF1ZXVlLiRudW1iZXIudmFsKCk7XG5cdH0sXG5cdGluaXRpYWxpemVGb3JtKCkge1xuXHRcdEZvcm0uJGZvcm1PYmogPSBjYWxsUXVldWUuJGZvcm1PYmo7XG5cdFx0Rm9ybS51cmwgPSBgJHtnbG9iYWxSb290VXJsfWNhbGwtcXVldWVzL3NhdmVgO1xuXHRcdEZvcm0udmFsaWRhdGVSdWxlcyA9IGNhbGxRdWV1ZS52YWxpZGF0ZVJ1bGVzO1xuXHRcdEZvcm0uY2JCZWZvcmVTZW5kRm9ybSA9IGNhbGxRdWV1ZS5jYkJlZm9yZVNlbmRGb3JtO1xuXHRcdEZvcm0uY2JBZnRlclNlbmRGb3JtID0gY2FsbFF1ZXVlLmNiQWZ0ZXJTZW5kRm9ybTtcblx0XHRGb3JtLmluaXRpYWxpemUoKTtcblx0fSxcbn07XG5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcblx0Y2FsbFF1ZXVlLmluaXRpYWxpemUoKTtcbn0pO1xuXG4iXX0=
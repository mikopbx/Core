"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/**
 * Object representing the sound player with slider functionality.
 *
 * @module sndPlayer
 */
var sndPlayer = {
  slider: document.getElementById('audio-player'),

  /**
   * Duration of the audio clip.
   * @type {number}
   */
  duration: 0,

  /**
   * jQuery object for the play button.
   * @type {jQuery}
   */
  $pButton: $('#play-button'),

  /**
   * jQuery object for the slider.
   * @type {jQuery}
   */
  $slider: $('#play-slider'),

  /**
   * jQuery object for the player segment.
   * @type {jQuery}
   */
  $playerSegment: $('#audio-player-segment'),

  /**
   * Initializes the sound player with slider functionality.
   */
  initialize: function initialize() {
    // Play button event listener
    sndPlayer.$pButton.on('click', function (e) {
      e.preventDefault();
      sndPlayer.play();
    }); // Timeupdate event listener

    sndPlayer.slider.addEventListener('timeupdate', sndPlayer.cbTimeUpdate, false); // Gets audio file duration

    sndPlayer.slider.addEventListener('canplaythrough', sndPlayer.cbCanPlayThrough, false); // Initialize range slider

    sndPlayer.$slider.range({
      min: 0,
      max: 100,
      start: 0,
      onChange: sndPlayer.cbOnSliderChange
    });
  },

  /**
   * Updates the audio source.
   * @param {string} newSource - The new source for the audio.
   */
  UpdateSource: function UpdateSource(newSource) {
    sndPlayer.slider.getElementsByTagName('source')[0].src = newSource;
    sndPlayer.slider.pause();
    sndPlayer.slider.load();
    sndPlayer.slider.oncanplaythrough = sndPlayer.cbCanPlayThrough;
  },

  /**
   * Callback function for the canplaythrough event.
   */
  cbCanPlayThrough: function cbCanPlayThrough() {
    sndPlayer.duration = sndPlayer.slider.duration; // console.log(`New duration ${sndPlayer.slider.readyState}`);

    if (sndPlayer.duration > 0) {
      sndPlayer.$slider.range('set value', 0);
      sndPlayer.$playerSegment.show();
    } else {
      sndPlayer.$playerSegment.hide();
    }
  },

  /**
   * Callback function for the slider change event.
   * @param {number} newVal - The new value of the slider.
   * @param {Object} meta - Additional metadata for the slider.
   */
  cbOnSliderChange: function cbOnSliderChange(newVal, meta) {
    if (meta.triggeredByUser && Number.isFinite(sndPlayer.slider.duration)) {
      sndPlayer.slider.removeEventListener('timeupdate', sndPlayer.cbTimeUpdate, false);
      sndPlayer.slider.currentTime = sndPlayer.slider.duration * newVal / 100;
      sndPlayer.slider.addEventListener('timeupdate', sndPlayer.cbTimeUpdate, false);
    }
  },

  /**
   * Callback function for the timeupdate event.
   * Synchronizes playhead position with current point in audio
   */
  cbTimeUpdate: function cbTimeUpdate() {
    if (Number.isFinite(sndPlayer.slider.duration)) {
      var percent = sndPlayer.slider.currentTime / sndPlayer.slider.duration;
      var rangePosition = Math.round(percent * 100);
      sndPlayer.$slider.range('set value', rangePosition);

      if (rangePosition === 100) {
        sndPlayer.$pButton.html('<i class="icon play"></i>');
      }
    }
  },

  /**
   * Plays or pauses the audio based on its current state.
   */
  play: function play() {
    if (sndPlayer.slider.paused && sndPlayer.slider.duration) {
      // Start playing the audio
      sndPlayer.slider.play(); // Update the play button icon to pause

      sndPlayer.$pButton.html('<i class="icon pause"></i>');
    } else {
      // Pause the audio
      sndPlayer.slider.pause(); // Update the play button icon to play

      sndPlayer.$pButton.html('<i class="icon play"></i>');
    }
  }
}; // When the document is ready, initialize the sound player with slider

$(document).ready(function () {
  sndPlayer.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Tb3VuZEZpbGVzL3NvdW5kLWZpbGUtbW9kaWZ5LXBsYXllci5qcyJdLCJuYW1lcyI6WyJzbmRQbGF5ZXIiLCJzbGlkZXIiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwiZHVyYXRpb24iLCIkcEJ1dHRvbiIsIiQiLCIkc2xpZGVyIiwiJHBsYXllclNlZ21lbnQiLCJpbml0aWFsaXplIiwib24iLCJlIiwicHJldmVudERlZmF1bHQiLCJwbGF5IiwiYWRkRXZlbnRMaXN0ZW5lciIsImNiVGltZVVwZGF0ZSIsImNiQ2FuUGxheVRocm91Z2giLCJyYW5nZSIsIm1pbiIsIm1heCIsInN0YXJ0Iiwib25DaGFuZ2UiLCJjYk9uU2xpZGVyQ2hhbmdlIiwiVXBkYXRlU291cmNlIiwibmV3U291cmNlIiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJzcmMiLCJwYXVzZSIsImxvYWQiLCJvbmNhbnBsYXl0aHJvdWdoIiwic2hvdyIsImhpZGUiLCJuZXdWYWwiLCJtZXRhIiwidHJpZ2dlcmVkQnlVc2VyIiwiTnVtYmVyIiwiaXNGaW5pdGUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiY3VycmVudFRpbWUiLCJwZXJjZW50IiwicmFuZ2VQb3NpdGlvbiIsIk1hdGgiLCJyb3VuZCIsImh0bWwiLCJwYXVzZWQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxTQUFTLEdBQUc7QUFDZEMsRUFBQUEsTUFBTSxFQUFFQyxRQUFRLENBQUNDLGNBQVQsQ0FBd0IsY0FBeEIsQ0FETTs7QUFHZDtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFRLEVBQUUsQ0FQSTs7QUFTZDtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFRLEVBQUVDLENB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Q0ssUUFBVixDQUFtQnNDLElBQW5CLENBQXdCLDJCQUF4QjtBQUNIO0FBQ0o7QUF6SGEsQ0FBbEIsQyxDQTZIQTs7QUFDQXJDLENBQUMsQ0FBQ0osUUFBRCxDQUFELENBQVkyQyxLQUFaLENBQWtCLFlBQU07QUFDcEI3QyxFQUFBQSxTQUFTLENBQUNTLFVBQVY7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyoqXG4gKiBPYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzb3VuZCBwbGF5ZXIgd2l0aCBzbGlkZXIgZnVuY3Rpb25hbGl0eS5cbiAqXG4gKiBAbW9kdWxlIHNuZFBsYXllclxuICovXG5jb25zdCBzbmRQbGF5ZXIgPSB7XG4gICAgc2xpZGVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXVkaW8tcGxheWVyJyksXG5cbiAgICAvKipcbiAgICAgKiBEdXJhdGlvbiBvZiB0aGUgYXVkaW8gY2xpcC5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIGR1cmF0aW9uOiAwLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIHBsYXkgYnV0dG9uLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHBCdXR0b246ICQoJyNwbGF5LWJ1dHRvbicpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIHNsaWRlci5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRzbGlkZXI6ICQoJyNwbGF5LXNsaWRlcicpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIHBsYXllciBzZWdtZW50LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHBsYXllclNlZ21lbnQ6ICQoJyNhdWRpby1wbGF5ZXItc2VnbWVudCcpLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIHNvdW5kIHBsYXllciB3aXRoIHNsaWRlciBmdW5jdGlvbmFsaXR5LlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIC8vIFBsYXkgYnV0dG9uIGV2ZW50IGxpc3RlbmVyXG4gICAgICAgIHNuZFBsYXllci4kcEJ1dHRvbi5vbignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgc25kUGxheWVyLnBsYXkoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVGltZXVwZGF0ZSBldmVudCBsaXN0ZW5lclxuICAgICAgICBzbmRQbGF5ZXIuc2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ3RpbWV1cGRhdGUnLCBzbmRQbGF5ZXIuY2JUaW1lVXBkYXRlLCBmYWxzZSk7XG5cbiAgICAgICAgLy8gR2V0cyBhdWRpbyBmaWxlIGR1cmF0aW9uXG4gICAgICAgIHNuZFBsYXllci5zbGlkZXIuYWRkRXZlbnRMaXN0ZW5lcignY2FucGxheXRocm91Z2gnLCBzbmRQbGF5ZXIuY2JDYW5QbGF5VGhyb3VnaCwgZmFsc2UpO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgcmFuZ2Ugc2xpZGVyXG4gICAgICAgIHNuZFBsYXllci4kc2xpZGVyLnJhbmdlKHtcbiAgICAgICAgICAgIG1pbjogMCxcbiAgICAgICAgICAgIG1heDogMTAwLFxuICAgICAgICAgICAgc3RhcnQ6IDAsXG4gICAgICAgICAgICBvbkNoYW5nZTogc25kUGxheWVyLmNiT25TbGlkZXJDaGFuZ2UsXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBhdWRpbyBzb3VyY2UuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1NvdXJjZSAtIFRoZSBuZXcgc291cmNlIGZvciB0aGUgYXVkaW8uXG4gICAgICovXG4gICAgVXBkYXRlU291cmNlKG5ld1NvdXJjZSkge1xuICAgICAgICBzbmRQbGF5ZXIuc2xpZGVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzb3VyY2UnKVswXS5zcmMgPSBuZXdTb3VyY2U7XG4gICAgICAgIHNuZFBsYXllci5zbGlkZXIucGF1c2UoKTtcbiAgICAgICAgc25kUGxheWVyLnNsaWRlci5sb2FkKCk7XG4gICAgICAgIHNuZFBsYXllci5zbGlkZXIub25jYW5wbGF5dGhyb3VnaCA9IHNuZFBsYXllci5jYkNhblBsYXlUaHJvdWdoO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBmb3IgdGhlIGNhbnBsYXl0aHJvdWdoIGV2ZW50LlxuICAgICAqL1xuICAgIGNiQ2FuUGxheVRocm91Z2goKSB7XG4gICAgICAgIHNuZFBsYXllci5kdXJhdGlvbiA9IHNuZFBsYXllci5zbGlkZXIuZHVyYXRpb247XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGBOZXcgZHVyYXRpb24gJHtzbmRQbGF5ZXIuc2xpZGVyLnJlYWR5U3RhdGV9YCk7XG4gICAgICAgIGlmIChzbmRQbGF5ZXIuZHVyYXRpb24gPiAwKSB7XG4gICAgICAgICAgICBzbmRQbGF5ZXIuJHNsaWRlci5yYW5nZSgnc2V0IHZhbHVlJywgMCk7XG4gICAgICAgICAgICBzbmRQbGF5ZXIuJHBsYXllclNlZ21lbnQuc2hvdygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc25kUGxheWVyLiRwbGF5ZXJTZWdtZW50LmhpZGUoKTtcbiAgICAgICAgfVxuICAgIH0sXG5cblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciB0aGUgc2xpZGVyIGNoYW5nZSBldmVudC5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbmV3VmFsIC0gVGhlIG5ldyB2YWx1ZSBvZiB0aGUgc2xpZGVyLlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBtZXRhIC0gQWRkaXRpb25hbCBtZXRhZGF0YSBmb3IgdGhlIHNsaWRlci5cbiAgICAgKi9cbiAgICBjYk9uU2xpZGVyQ2hhbmdlKG5ld1ZhbCwgbWV0YSkge1xuICAgICAgICBpZiAobWV0YS50cmlnZ2VyZWRCeVVzZXIgJiYgTnVtYmVyLmlzRmluaXRlKHNuZFBsYXllci5zbGlkZXIuZHVyYXRpb24pKSB7XG4gICAgICAgICAgICBzbmRQbGF5ZXIuc2xpZGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RpbWV1cGRhdGUnLCBzbmRQbGF5ZXIuY2JUaW1lVXBkYXRlLCBmYWxzZSk7XG4gICAgICAgICAgICBzbmRQbGF5ZXIuc2xpZGVyLmN1cnJlbnRUaW1lID0gKHNuZFBsYXllci5zbGlkZXIuZHVyYXRpb24gKiBuZXdWYWwpIC8gMTAwO1xuICAgICAgICAgICAgc25kUGxheWVyLnNsaWRlci5hZGRFdmVudExpc3RlbmVyKCd0aW1ldXBkYXRlJywgc25kUGxheWVyLmNiVGltZVVwZGF0ZSwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciB0aGUgdGltZXVwZGF0ZSBldmVudC5cbiAgICAgKiBTeW5jaHJvbml6ZXMgcGxheWhlYWQgcG9zaXRpb24gd2l0aCBjdXJyZW50IHBvaW50IGluIGF1ZGlvXG4gICAgICovXG4gICAgY2JUaW1lVXBkYXRlKCkge1xuICAgICAgICBpZiAoTnVtYmVyLmlzRmluaXRlKHNuZFBsYXllci5zbGlkZXIuZHVyYXRpb24pKSB7XG4gICAgICAgICAgICBjb25zdCBwZXJjZW50ID0gc25kUGxheWVyLnNsaWRlci5jdXJyZW50VGltZSAvIHNuZFBsYXllci5zbGlkZXIuZHVyYXRpb247XG4gICAgICAgICAgICBjb25zdCByYW5nZVBvc2l0aW9uID0gTWF0aC5yb3VuZCgocGVyY2VudCkgKiAxMDApO1xuICAgICAgICAgICAgc25kUGxheWVyLiRzbGlkZXIucmFuZ2UoJ3NldCB2YWx1ZScsIHJhbmdlUG9zaXRpb24pO1xuICAgICAgICAgICAgaWYgKHJhbmdlUG9zaXRpb24gPT09IDEwMCkge1xuICAgICAgICAgICAgICAgIHNuZFBsYXllci4kcEJ1dHRvbi5odG1sKCc8aSBjbGFzcz1cImljb24gcGxheVwiPjwvaT4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBQbGF5cyBvciBwYXVzZXMgdGhlIGF1ZGlvIGJhc2VkIG9uIGl0cyBjdXJyZW50IHN0YXRlLlxuICAgICAqL1xuICAgIHBsYXkoKSB7XG4gICAgICAgIGlmIChzbmRQbGF5ZXIuc2xpZGVyLnBhdXNlZCAmJiBzbmRQbGF5ZXIuc2xpZGVyLmR1cmF0aW9uKSB7XG4gICAgICAgICAgICAvLyBTdGFydCBwbGF5aW5nIHRoZSBhdWRpb1xuICAgICAgICAgICAgc25kUGxheWVyLnNsaWRlci5wbGF5KCk7XG4gICAgICAgICAgICAvLyBVcGRhdGUgdGhlIHBsYXkgYnV0dG9uIGljb24gdG8gcGF1c2VcbiAgICAgICAgICAgIHNuZFBsYXllci4kcEJ1dHRvbi5odG1sKCc8aSBjbGFzcz1cImljb24gcGF1c2VcIj48L2k+Jyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBQYXVzZSB0aGUgYXVkaW9cbiAgICAgICAgICAgIHNuZFBsYXllci5zbGlkZXIucGF1c2UoKTtcbiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgcGxheSBidXR0b24gaWNvbiB0byBwbGF5XG4gICAgICAgICAgICBzbmRQbGF5ZXIuJHBCdXR0b24uaHRtbCgnPGkgY2xhc3M9XCJpY29uIHBsYXlcIj48L2k+Jyk7XG4gICAgICAgIH1cbiAgICB9LFxuXG59O1xuXG4vLyBXaGVuIHRoZSBkb2N1bWVudCBpcyByZWFkeSwgaW5pdGlhbGl6ZSB0aGUgc291bmQgcGxheWVyIHdpdGggc2xpZGVyXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgc25kUGxheWVyLmluaXRpYWxpemUoKTtcbn0pO1xuIl19
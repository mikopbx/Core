"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global MediaStreamRecorder, StereoAudioRecorder, PbxApi, sndPlayer */
var webkitRecorder = {
  $recordLabel: $('#record-label'),
  $recordButton: $('#start-record-button'),
  $stopButton: $('#stop-record-button'),
  $selectAudioInput: $('#select-audio-button'),
  $audioPlayer: $('#audio-player'),
  audioInputMenu: document.getElementById('audio-input-select'),
  chunks: [],
  mediaRecorder: '',
  initialize: function () {
    function initialize() {
      webkitRecorder.$stopButton.addClass('disabled');
      webkitRecorder.$recordButton.on('click', function (e) {
        e.preventDefault();
        webkitRecorder.chunks = [];
        var constraints = {
          audio: true
        };

        if (webkitRecorder.audioInputMenu.getElementsByClassName('selected').length > 0) {
          var audioSource = webkitRecorder.audioInputMenu.getElementsByClassName('selected')[0].id;
          constraints = {
            audio: {
              deviceId: audioSource ? {
                exact: audioSource
              } : undefined
            }
          };
        }

        console.log(constraints);
        webkitRecorder.captureUserMedia(constraints, webkitRecorder.cbOnSuccess, webkitRecorder.gotDevices, webkitRecorder.onError);
      });
      webkitRecorder.$stopButton.on('click', function (e) {
        e.preventDefault();
        webkitRecorder.mediaRecorder.stop();
      });
      webkitRecorder.$selectAudioInput.dropdown();

      if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        $('#only-https-field').addClass('disabled');
      }

      if (window.navigator.userAgent.indexOf('MSIE ') > 0) {
        $('#only-https-field').addClass('disabled');
      }
    }

    return initialize;
  }(),
  captureUserMedia: function () {
    function captureUserMedia(mediaConstraints, successCallback, gotDevicesCallBack, errorCallback) {
      navigator.mediaDevices.getUserMedia(mediaConstraints).then(successCallback).then(gotDevicesCallBack)["catch"](errorCallback);
    }

    return captureUserMedia;
  }(),
  gotDevices: function () {
    function gotDevices(deviceInfos) {
      if (webkitRecorder.audioInputMenu.getElementsByTagName('div').length > 0) return;

      for (var i = 0; i !== deviceInfos.length; i += 1) {
        var deviceInfo = deviceInfos[i];
        var option = document.createElement('div');
        option.className = 'item';
        option.id = deviceInfo.deviceId;

        if (deviceInfo.kind === 'audioinput') {
          option.innerHTML = deviceInfo.label || "microphone ".concat(webkitRecorder.audioInputMenu.length + 1);
          webkitRecorder.audioInputMenu.appendChild(option);
        }
      }

      if (webkitRecorder.audioInputMenu.getElementsByTagName('div').length > 0) {
        webkitRecorder.$selectAudioInput.removeClass('disabled');
      }
    }

    return gotDevices;
  }(),
  cbOnSuccess: function () {
    function cbOnSuccess(stream) {
      try {
        webkitRecorder.mediaRecorder = new MediaStreamRecorder(stream);
        webkitRecorder.mediaRecorder.stream = stream;
        webkitRecorder.mediaRecorder.recorderType = StereoAudioRecorder;
        webkitRecorder.mediaRecorder.mimeType = 'audio/wav';
        webkitRecorder.mediaRecorder.audioChannels = 1; // webkitRecorder.mediaRecorder = new MediaRecorder(stream);

        webkitRecorder.mediaRecorder.onstop = webkitRecorder.cbOnStopMediaRecorder;
        webkitRecorder.mediaRecorder.ondataavailable = webkitRecorder.cbOnDataAvailable;
        webkitRecorder.mediaRecorder.start(300000);
        console.log('recorder started');
        webkitRecorder.$recordLabel.addClass('red');
        webkitRecorder.$stopButton.removeClass('disabled');
        webkitRecorder.$recordButton.addClass('disabled');
        return navigator.mediaDevices.enumerateDevices();
      } catch (e) {
        console.error('MediaStreamRecorder is not supported by this browser.\n\n' + 'Try Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags.');
        console.error('Exception while creating MediaRecorder:', e);
        webkitRecorder.$recordButton.addClass('disabled');
      }

      return false;
    }

    return cbOnSuccess;
  }(),
  cbOnError: function () {
    function cbOnError(err) {
      console.log("The following error occured: ".concat(err));
    }

    return cbOnError;
  }(),
  cbOnStopMediaRecorder: function () {
    function cbOnStopMediaRecorder() {
      console.log('data available after MediaStreamRecorder.stop() called.');
      soundFileModify.blob = new Blob(webkitRecorder.chunks);
      console.log('recorder stopped');
      var fileURL = URL.createObjectURL(soundFileModify.blob);
      sndPlayer.UpdateSource(fileURL);
      var blobFile = new File([webkitRecorder.chunks[0]], 'blob' + new Date().getTime() + '.wav');
      PbxApi.FilesUploadFile(blobFile, soundFileModify.cbUploadResumable);
      webkitRecorder.$recordLabel.removeClass('red');
      webkitRecorder.$stopButton.addClass('disabled');
      webkitRecorder.$recordButton.removeClass('disabled');
      soundFileModify.$soundFileInput.val('');
    }

    return cbOnStopMediaRecorder;
  }(),
  cbOnDataAvailable: function () {
    function cbOnDataAvailable(e) {
      webkitRecorder.chunks.push(e);
    }

    return cbOnDataAvailable;
  }()
};
$(document).ready(function () {
  webkitRecorder.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Tb3VuZEZpbGVzL3NvdW5kLWZpbGUtbW9kaWZ5LXdlYmtpdC1yZWNvcmRlci5qcyJdLCJuYW1lcyI6WyJ3ZWJraXRSZWNvcmRlciIsIiRyZWNvcmRMYWJlbCIsIiQiLCIkcmVjb3JkQnV0dG9uIiwiJHN0b3BCdXR0b24iLCIkc2VsZWN0QXVkaW9JbnB1dCIsIiRhdWRpb1BsYXllciIsImF1ZGlvSW5wdXRNZW51IiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsImNodW5rcyIsIm1lZGlhUmVjb3JkZXIiLCJpbml0aWFsaXplIiwiYWRkQ2xhc3MiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImNvbnN0cmFpbnRzIiwiYXVkaW8iLCJnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIiwibGVuZ3RoIiwiYXVkaW9Tb3VyY2UiLCJpZCIsImRldmljZUlkIiwiZXhhY3QiLCJ1bmRlZmluZWQiLCJjb25zb2xlIiwibG9nIiwiY2FwdHVyZVVzZXJNZWRpYSIsImNiT25TdWNjZXNzIiwiZ290RGV2aWNlcyIsIm9uRXJyb3IiLCJzdG9wIiwiZHJvcGRvd24iLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInByb3RvY29sIiwiaG9zdG5hbWUiLCJuYXZpZ2F0b3IiLCJ1c2VyQWdlbnQiLCJpbmRleE9mIiwibWVkaWFDb25zdHJhaW50cyIsInN1Y2Nlc3NDYWxsYmFjayIsImdvdERldmljZXNDYWxsQmFjayIsImVycm9yQ2FsbGJhY2siLCJtZWRpYURldmljZXMiLCJnZXRVc2VyTWVkaWEiLCJ0aGVuIiwiZGV2aWNlSW5mb3MiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsImkiLCJkZXZpY2VJbmZvIiwib3B0aW9uIiwiY3JlYXRlRWxlbWVudCIsImNsYXNzTmFtZSIsImtpbmQiLCJpbm5lckhUTUwiLCJsYWJlbCIsImFwcGVuZENoaWxkIiwicmVtb3ZlQ2xhc3MiLCJzdHJlYW0iLCJNZWRpYVN0cmVhbVJlY29yZGVyIiwicmVjb3JkZXJUeXBlIiwiU3RlcmVvQXVkaW9SZWNvcmRlciIsIm1pbWVUeXBlIiwiYXVkaW9DaGFubmVscyIsIm9uc3RvcCIsImNiT25TdG9wTWVkaWFSZWNvcmRlciIsIm9uZGF0YWF2YWlsYWJsZSIsImNiT25EYXRhQXZhaWxhYmxlIiwic3RhcnQiLCJlbnVtZXJhdGVEZXZpY2VzIiwiZXJyb3IiLCJjYk9uRXJyb3IiLCJlcnIiLCJzb3VuZEZpbGVNb2RpZnkiLCJibG9iIiwiQmxvYiIsImZpbGVVUkwiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJzbmRQbGF5ZXIiLCJVcGRhdGVTb3VyY2UiLCJibG9iRmlsZSIsIkZpbGUiLCJEYXRlIiwiZ2V0VGltZSIsIlBieEFwaSIsIkZpbGVzVXBsb2FkRmlsZSIsImNiVXBsb2FkUmVzdW1hYmxlIiwiJHNvdW5kRmlsZUlucHV0IiwidmFsIiwicHVzaCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFrQkE7QUFDQSxJQUFNQSxjQUFjLEdBQUc7QUFDdEJDLEVBQUFBLFlBQVksRUFBRUMsQ0FBQyxDQUFDLGVBQUQsQ0FETztBQUV0QkMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsc0JBQUQsQ0FGTTtBQUd0QkUsRUFBQUEsV0FBVyxFQUFFRixDQUFDLENBQUMscUJBQUQsQ0FIUTtBQUl0QkcsRUFBQUEsaUJBQWlCLEVBQUVILENBQUMsQ0FBQyxzQkFBRCxDQUpFO0FBS3RCSSxFQUFBQSxZQUFZLEVBQUVKLENBQUMsQ0FBQyxlQUFELENBTE87QUFNdEJLLEVBQUFBLGNBQWMsRUFBRUMsUUFBUSxDQUFDQyxjQUFULENBQXdCLG9CQUF4QixDQU5NO0FBT3RCQyxFQUFBQSxNQUFNLEVBQUUsRUFQYztBQVF0QkMsRUFBQUEsYUFBYSxFQUFFLEVBUk87QUFTdEJDLEVBQUFBLFVBVHNCO0FBQUEsMEJBU1Q7QUFDWlosTUFBQUEsY0FBYyxDQUFDSSxXQUFmLENBQTJCUyxRQUEzQixDQUFvQyxVQUFwQztBQUVBYixNQUFBQSxjQUFjLENBQUNHLGFBQWYsQ0FBNkJXLEVB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SixDQUFvQkwsZUFBZSxDQUFDQyxJQUFwQyxDQUFoQjtBQUNBSyxNQUFBQSxTQUFTLENBQUNDLFlBQVYsQ0FBdUJKLE9BQXZCO0FBQ0EsVUFBTUssUUFBUSxHQUFHLElBQUlDLElBQUosQ0FBUyxDQUFDcEYsY0FBYyxDQUFDVSxNQUFmLENBQXNCLENBQXRCLENBQUQsQ0FBVCxFQUFxQyxTQUFRLElBQUkyRSxJQUFKLEdBQVdDLE9BQVgsRUFBUixHQUE2QixNQUFsRSxDQUFqQjtBQUNBQyxNQUFBQSxNQUFNLENBQUNDLGVBQVAsQ0FBdUJMLFFBQXZCLEVBQWlDUixlQUFlLENBQUNjLGlCQUFqRDtBQUNBekYsTUFBQUEsY0FBYyxDQUFDQyxZQUFmLENBQTRCMEQsV0FBNUIsQ0FBd0MsS0FBeEM7QUFDQTNELE1BQUFBLGNBQWMsQ0FBQ0ksV0FBZixDQUEyQlMsUUFBM0IsQ0FBb0MsVUFBcEM7QUFDQWIsTUFBQUEsY0FBYyxDQUFDRyxhQUFmLENBQTZCd0QsV0FBN0IsQ0FBeUMsVUFBekM7QUFDQWdCLE1BQUFBLGVBQWUsQ0FBQ2UsZUFBaEIsQ0FBZ0NDLEdBQWhDLENBQW9DLEVBQXBDO0FBQ0E7O0FBOUdxQjtBQUFBO0FBK0d0QnRCLEVBQUFBLGlCQS9Hc0I7QUFBQSwrQkErR0p0RCxDQS9HSSxFQStHRDtBQUNwQmYsTUFBQUEsY0FBYyxDQUFDVSxNQUFmLENBQXNCa0YsSUFBdEIsQ0FBMkI3RSxDQUEzQjtBQUNBOztBQWpIcUI7QUFBQTtBQUFBLENBQXZCO0FBcUhBYixDQUFDLENBQUNNLFFBQUQsQ0FBRCxDQUFZcUYsS0FBWixDQUFrQixZQUFNO0FBQ3ZCN0YsRUFBQUEsY0FBYyxDQUFDWSxVQUFmO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMCBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgTWVkaWFTdHJlYW1SZWNvcmRlciwgU3RlcmVvQXVkaW9SZWNvcmRlciwgUGJ4QXBpLCBzbmRQbGF5ZXIgKi9cbmNvbnN0IHdlYmtpdFJlY29yZGVyID0ge1xuXHQkcmVjb3JkTGFiZWw6ICQoJyNyZWNvcmQtbGFiZWwnKSxcblx0JHJlY29yZEJ1dHRvbjogJCgnI3N0YXJ0LXJlY29yZC1idXR0b24nKSxcblx0JHN0b3BCdXR0b246ICQoJyNzdG9wLXJlY29yZC1idXR0b24nKSxcblx0JHNlbGVjdEF1ZGlvSW5wdXQ6ICQoJyNzZWxlY3QtYXVkaW8tYnV0dG9uJyksXG5cdCRhdWRpb1BsYXllcjogJCgnI2F1ZGlvLXBsYXllcicpLFxuXHRhdWRpb0lucHV0TWVudTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1ZGlvLWlucHV0LXNlbGVjdCcpLFxuXHRjaHVua3M6IFtdLFxuXHRtZWRpYVJlY29yZGVyOiAnJyxcblx0aW5pdGlhbGl6ZSgpIHtcblx0XHR3ZWJraXRSZWNvcmRlci4kc3RvcEJ1dHRvbi5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblxuXHRcdHdlYmtpdFJlY29yZGVyLiRyZWNvcmRCdXR0b24ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdHdlYmtpdFJlY29yZGVyLmNodW5rcyA9IFtdO1xuXHRcdFx0bGV0IGNvbnN0cmFpbnRzID0ge1xuXHRcdFx0XHRhdWRpbzogdHJ1ZSxcblx0XHRcdH07XG5cdFx0XHRpZiAod2Via2l0UmVjb3JkZXIuYXVkaW9JbnB1dE1lbnUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnc2VsZWN0ZWQnKS5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdGNvbnN0IGF1ZGlvU291cmNlID0gd2Via2l0UmVjb3JkZXIuYXVkaW9JbnB1dE1lbnUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnc2VsZWN0ZWQnKVswXS5pZDtcblx0XHRcdFx0Y29uc3RyYWludHMgPSB7XG5cdFx0XHRcdFx0YXVkaW86IHtkZXZpY2VJZDogYXVkaW9Tb3VyY2UgPyB7ZXhhY3Q6IGF1ZGlvU291cmNlfSA6IHVuZGVmaW5lZH0sXG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0XHRjb25zb2xlLmxvZyhjb25zdHJhaW50cyk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5jYXB0dXJlVXNlck1lZGlhKFxuXHRcdFx0XHRjb25zdHJhaW50cyxcblx0XHRcdFx0d2Via2l0UmVjb3JkZXIuY2JPblN1Y2Nlc3MsXG5cdFx0XHRcdHdlYmtpdFJlY29yZGVyLmdvdERldmljZXMsXG5cdFx0XHRcdHdlYmtpdFJlY29yZGVyLm9uRXJyb3IsXG5cdFx0XHQpO1xuXHRcdH0pO1xuXHRcdHdlYmtpdFJlY29yZGVyLiRzdG9wQnV0dG9uLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5tZWRpYVJlY29yZGVyLnN0b3AoKTtcblx0XHR9KTtcblxuXHRcdHdlYmtpdFJlY29yZGVyLiRzZWxlY3RBdWRpb0lucHV0LmRyb3Bkb3duKCk7XG5cblx0XHRpZiAod2luZG93LmxvY2F0aW9uLnByb3RvY29sICE9PSAnaHR0cHM6JyAmJiB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUgIT09ICdsb2NhbGhvc3QnKSB7XG5cdFx0XHQkKCcjb25seS1odHRwcy1maWVsZCcpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdH1cblx0XHRpZiAod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignTVNJRSAnKSA+IDApIHtcblx0XHRcdCQoJyNvbmx5LWh0dHBzLWZpZWxkJykuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0fVxuXHR9LFxuXHRjYXB0dXJlVXNlck1lZGlhKG1lZGlhQ29uc3RyYWludHMsIHN1Y2Nlc3NDYWxsYmFjaywgZ290RGV2aWNlc0NhbGxCYWNrLCBlcnJvckNhbGxiYWNrKSB7XG5cdFx0bmF2aWdhdG9yXG5cdFx0XHQubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYShtZWRpYUNvbnN0cmFpbnRzKVxuXHRcdFx0LnRoZW4oc3VjY2Vzc0NhbGxiYWNrKVxuXHRcdFx0LnRoZW4oZ290RGV2aWNlc0NhbGxCYWNrKVxuXHRcdFx0LmNhdGNoKGVycm9yQ2FsbGJhY2spO1xuXHR9LFxuXHRnb3REZXZpY2VzKGRldmljZUluZm9zKSB7XG5cdFx0aWYgKHdlYmtpdFJlY29yZGVyLmF1ZGlvSW5wdXRNZW51LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkaXYnKS5sZW5ndGggPiAwKSByZXR1cm47XG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgIT09IGRldmljZUluZm9zLmxlbmd0aDsgaSArPSAxKSB7XG5cdFx0XHRjb25zdCBkZXZpY2VJbmZvID0gZGV2aWNlSW5mb3NbaV07XG5cdFx0XHRjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRcdG9wdGlvbi5jbGFzc05hbWUgPSAnaXRlbSc7XG5cdFx0XHRvcHRpb24uaWQgPSBkZXZpY2VJbmZvLmRldmljZUlkO1xuXHRcdFx0aWYgKGRldmljZUluZm8ua2luZCA9PT0gJ2F1ZGlvaW5wdXQnKSB7XG5cdFx0XHRcdG9wdGlvbi5pbm5lckhUTUwgPSBkZXZpY2VJbmZvLmxhYmVsIHx8XG5cdFx0XHRcdFx0YG1pY3JvcGhvbmUgJHt3ZWJraXRSZWNvcmRlci5hdWRpb0lucHV0TWVudS5sZW5ndGggKyAxfWA7XG5cdFx0XHRcdHdlYmtpdFJlY29yZGVyLmF1ZGlvSW5wdXRNZW51LmFwcGVuZENoaWxkKG9wdGlvbik7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdGlmICh3ZWJraXRSZWNvcmRlci5hdWRpb0lucHV0TWVudS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGl2JykubGVuZ3RoID4gMCkge1xuXHRcdFx0d2Via2l0UmVjb3JkZXIuJHNlbGVjdEF1ZGlvSW5wdXQucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0fVxuXHR9LFxuXHRjYk9uU3VjY2VzcyhzdHJlYW0pIHtcblx0XHR0cnkge1xuXHRcdFx0d2Via2l0UmVjb3JkZXIubWVkaWFSZWNvcmRlciA9IG5ldyBNZWRpYVN0cmVhbVJlY29yZGVyKHN0cmVhbSk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5tZWRpYVJlY29yZGVyLnN0cmVhbSA9IHN0cmVhbTtcblx0XHRcdHdlYmtpdFJlY29yZGVyLm1lZGlhUmVjb3JkZXIucmVjb3JkZXJUeXBlID0gU3RlcmVvQXVkaW9SZWNvcmRlcjtcblx0XHRcdHdlYmtpdFJlY29yZGVyLm1lZGlhUmVjb3JkZXIubWltZVR5cGUgPSAnYXVkaW8vd2F2Jztcblx0XHRcdHdlYmtpdFJlY29yZGVyLm1lZGlhUmVjb3JkZXIuYXVkaW9DaGFubmVscyA9IDE7XG5cblx0XHRcdC8vIHdlYmtpdFJlY29yZGVyLm1lZGlhUmVjb3JkZXIgPSBuZXcgTWVkaWFSZWNvcmRlcihzdHJlYW0pO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIubWVkaWFSZWNvcmRlci5vbnN0b3AgPSB3ZWJraXRSZWNvcmRlci5jYk9uU3RvcE1lZGlhUmVjb3JkZXI7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5tZWRpYVJlY29yZGVyLm9uZGF0YWF2YWlsYWJsZSA9IHdlYmtpdFJlY29yZGVyLmNiT25EYXRhQXZhaWxhYmxlO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIubWVkaWFSZWNvcmRlci5zdGFydCgzMDAwMDApO1xuXHRcdFx0Y29uc29sZS5sb2coJ3JlY29yZGVyIHN0YXJ0ZWQnKTtcblx0XHRcdHdlYmtpdFJlY29yZGVyLiRyZWNvcmRMYWJlbC5hZGRDbGFzcygncmVkJyk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci4kc3RvcEJ1dHRvbi5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcblx0XHRcdHdlYmtpdFJlY29yZGVyLiRyZWNvcmRCdXR0b24uYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0XHRyZXR1cm4gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKCk7XG5cdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0Y29uc29sZS5lcnJvcignTWVkaWFTdHJlYW1SZWNvcmRlciBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoaXMgYnJvd3Nlci5cXG5cXG4nICtcblx0XHRcdFx0J1RyeSBGaXJlZm94IDI5IG9yIGxhdGVyLCBvciBDaHJvbWUgNDcgb3IgbGF0ZXIsIHdpdGggRW5hYmxlIGV4cGVyaW1lbnRhbCBXZWIgUGxhdGZvcm0gZmVhdHVyZXMgZW5hYmxlZCBmcm9tIGNocm9tZTovL2ZsYWdzLicpO1xuXHRcdFx0Y29uc29sZS5lcnJvcignRXhjZXB0aW9uIHdoaWxlIGNyZWF0aW5nIE1lZGlhUmVjb3JkZXI6JywgZSk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci4kcmVjb3JkQnV0dG9uLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdH1cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH0sXG5cdGNiT25FcnJvcihlcnIpIHtcblx0XHRjb25zb2xlLmxvZyhgVGhlIGZvbGxvd2luZyBlcnJvciBvY2N1cmVkOiAke2Vycn1gKTtcblx0fSxcblx0Y2JPblN0b3BNZWRpYVJlY29yZGVyKCkge1xuXHRcdGNvbnNvbGUubG9nKCdkYXRhIGF2YWlsYWJsZSBhZnRlciBNZWRpYVN0cmVhbVJlY29yZGVyLnN0b3AoKSBjYWxsZWQuJyk7XG5cdFx0c291bmRGaWxlTW9kaWZ5LmJsb2IgPSBuZXcgQmxvYih3ZWJraXRSZWNvcmRlci5jaHVua3MpO1xuXHRcdGNvbnNvbGUubG9nKCdyZWNvcmRlciBzdG9wcGVkJyk7XG5cdFx0Y29uc3QgZmlsZVVSTCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc291bmRGaWxlTW9kaWZ5LmJsb2IpO1xuXHRcdHNuZFBsYXllci5VcGRhdGVTb3VyY2UoZmlsZVVSTCk7XG5cdFx0Y29uc3QgYmxvYkZpbGUgPSBuZXcgRmlsZShbd2Via2l0UmVjb3JkZXIuY2h1bmtzWzBdXSwgJ2Jsb2InKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSsnLndhdicpO1xuXHRcdFBieEFwaS5GaWxlc1VwbG9hZEZpbGUoYmxvYkZpbGUsIHNvdW5kRmlsZU1vZGlmeS5jYlVwbG9hZFJlc3VtYWJsZSk7XG5cdFx0d2Via2l0UmVjb3JkZXIuJHJlY29yZExhYmVsLnJlbW92ZUNsYXNzKCdyZWQnKTtcblx0XHR3ZWJraXRSZWNvcmRlci4kc3RvcEJ1dHRvbi5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblx0XHR3ZWJraXRSZWNvcmRlci4kcmVjb3JkQnV0dG9uLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdHNvdW5kRmlsZU1vZGlmeS4kc291bmRGaWxlSW5wdXQudmFsKCcnKTtcblx0fSxcblx0Y2JPbkRhdGFBdmFpbGFibGUoZSkge1xuXHRcdHdlYmtpdFJlY29yZGVyLmNodW5rcy5wdXNoKGUpO1xuXHR9LFxufTtcblxuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG5cdHdlYmtpdFJlY29yZGVyLmluaXRpYWxpemUoKTtcbn0pO1xuIl19
"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalTranslate,  PbxApi */

/**
 * Worker object responsible for checking the status of merging requests.
 *
 * @module mergingCheckWorker
 */
var mergingCheckWorker = {
  /**
   * Time in milliseconds before fetching new status of merging request.
   * @type {number}
   */
  timeOut: 3000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * Number of error counts encountered during merging request.
   * @type {number}
   */
  errorCounts: 0,

  /**
   * File ID of the merging request.
   * @type {string}
   */
  fileID: null,

  /**
   * File path of the merging request.
   * @type {string}
   */
  filePath: '',

  /**
   * Initializes the merging check worker.
   * @param {string} fileID - The ID of the merging request.
   * @param {string} filePath - The file path of the merging request.
   */
  initialize: function initialize(fileID, filePath) {
    mergingCheckWorker.fileID = fileID;
    mergingCheckWorker.filePath = filePath;
    mergingCheckWorker.restartWorker(fileID);
  },

  /**
   * Restarts the merging check worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(mergingCheckWorker.timeoutHandle);
    mergingCheckWorker.worker();
  },

  /**
   * Performs the merging check operation.
   */
  worker: function worker() {
    PbxApi.FilesGetStatusUploadFile(mergingCheckWorker.fileID, mergingCheckWorker.cbAfterResponse);
    mergingCheckWorker.timeoutHandle = window.setTimeout(mergingCheckWorker.worker, mergingCheckWorker.timeOut);
  },

  /**
   * Callback function called after receiving the merging response.
   * @param {Object} response - The merging response.
   */
  cbAfterResponse: function cbAfterResponse(response) {
    if (mergingCheckWorker.errorCounts > 10) {
      // Show error message if the error count exceeds the threshold
      UserMessage.showMultiString(globalTranslate.sf_UploadError);
      soundFileModify.$submitButton.removeClass('loading');
      soundFileModify.$formObj.removeClass('loading');
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    }

    if (response === undefined || Object.keys(response).length === 0) {
      // Increment error count if the response is undefined or empty
      mergingCheckWorker.errorCounts += 1;
      return;
    }

    if (response.d_status === 'UPLOAD_COMPLETE') {
      // Start converting the audio file if the merging is complete
      var category = soundFileModify.$formObj.form('get value', 'category');
      PbxApi.SystemConvertAudioFile(mergingCheckWorker.filePath, category, soundFileModify.cbAfterConvertFile);
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    } else if (response.d_status !== undefined) {
      // Reset error count if the response status is defined
      mergingCheckWorker.errorCounts = 0;
    } else {
      // Increment error count for other cases
      mergingCheckWorker.errorCounts += 1;
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Tb3VuZEZpbGVzL3NvdW5kLWZpbGUtbW9kaWZ5LXVwbG9hZC13b3JrZXIuanMiXSwibmFtZXMiOlsibWVyZ2luZ0NoZWNrV29ya2VyIiwidGltZU91dCIsInRpbWVPdXRIYW5kbGUiLCJlcnJvckNvdW50cyIsImZpbGVJRCIsImZpbGVQYXRoIiwiaW5pdGlhbGl6ZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiUGJ4QXBpIiwiRmlsZXNHZXRTdGF0dXNVcGxvYWRGaWxlIiwiY2JBZnRlclJlc3BvbnNlIiwic2V0VGltZW91dCIsInJlc3BvbnNlIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJnbG9iYWxUcmFuc2xhdGUiLCJzZl9VcGxvYWRFcnJvciIsInNvdW5kRmlsZU1vZGlmeSIsIiRzdWJtaXRCdXR0b24iLCJyZW1vdmVDbGFzcyIsIiRmb3JtT2JqIiwidW5kZWZpbmVkIiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsImRfc3RhdHVzIiwiY2F0ZWdvcnkiLCJmb3JtIiwiU3lzdGVtQ29udmVydEF1ZGlvRmlsZSIsImNiQWZ0ZXJDb252ZXJ0RmlsZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNBOztBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxrQkFBa0IsR0FBRztBQUV2QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxPQUFPLEVBQUUsSUFOYzs7QUFRdkI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFLENBWlE7O0FBY3ZCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFdBQVcsRUFBRSxDQWxCVTs7QUFvQnZCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLE1BQU0sRUFBRSxJQXhCZTs7QUEwQnZCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFFBQVEsRUFBRSxFQTlCYTs7QUFpQ3ZCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsVUF0Q3VCLHNCQXNDWkYsTUF0Q1ksRUFzQ0pDLFFBdENJLEVBc0NNO0FBQ3pCTCxJQUFBQSxrQkFBa0IsQ0FBQ0ksTUFBbkIsR0FBNEJBLE1BQTVCO0FBQ0FKLElBQUFBLGtCQUFrQixDQUFDSyxRQUFuQixHQUE4QkEsUUFBOUI7QUFDQUwsSUFBQUEsa0JBQWtCLENBQUNPLGFBQW5CLENBQWlDSCxNQUFqQztBQUNILEdBMUNzQjs7QUE0Q3ZCO0FBQ0o7QUFDQTtBQUNJRyxFQUFBQSxhQS9DdUIsMkJBK0NQO0FBQ1pDLElBQUFBLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQlQsa0JBQWtCLENBQUNVLGFBQXZDO0FBQ0FWLElBQUFBLGtCQUFrQixDQUFDVyxNQUFuQjtBQUNILEdBbERzQjs7QUFvRHZCO0FBQ0o7QUFDQTtBQUNJQSxFQUFBQSxNQXZEdUIsb0JBdURkO0FBQ0xDLElBQUFBLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NiLGtCQUFrQixDQUFDSSxNQUFuRCxFQUEyREosa0JBQWtCLENBQUNjLGVBQTlFO0FBQ0FkLElBQUFBLGtCQUFrQixDQUFDVSxhQUFuQixHQUFtQ0YsTUFBTSxDQUFDTyxVQUFQLENBQy9CZixrQkFBa0IsQ0FBQ1csTUFEWSxFQUUvQlgsa0JBQWtCLENBQUNDLE9BRlksQ0FBbkM7QUFJSCxHQTdEc0I7O0FBK0R2QjtBQUNKO0FBQ0E7QUFDQTtBQUNJYSxFQUFBQSxlQW5FdUIsMkJBbUVQRSxRQW5FTyxFQW1FRztBQUN0QixRQUFJaEIsa0JBQWtCLENBQUNHLFdBQW5CLEdBQWlDLEVBQXJDLEVBQXlDO0FBQ3JDO0FBQ0FjLE1BQUFBLFdBQVcsQ0FBQ0MsZUFBWixDQUE0QkMsZUFBZSxDQUFDQyxjQUE1QztBQUNBQyxNQUFBQSxlQUFlLENBQUNDLGFBQWhCLENBQThCQyxXQUE5QixDQUEwQyxTQUExQztBQUNBRixNQUFBQSxlQUFlLENBQUNHLFFBQWhCLENBQXlCRCxXQUF6QixDQUFxQyxTQUFyQztBQUNBZixNQUFBQSxNQUFNLENBQUNDLFlBQVAsQ0FBb0JULGtCQUFrQixDQUFDVSxhQUF2QztBQUNIOztBQUNELFFBQUlNLFFBQVEsS0FBS1MsU0FBYixJQUEwQkMsTUFBTSxDQUFDQyxJQUFQLENBQVlYLFFBQVosRUFBc0JZLE1BQXRCLEtBQWlDLENBQS9ELEVBQWtFO0FBQzlEO0FBQ0E1QixNQUFBQSxrQkFBa0IsQ0FBQ0csV0FBbkIsSUFBa0MsQ0FBbEM7QUFDQTtBQUNIOztBQUNELFFBQUlhLFFBQVEsQ0FBQ2EsUUFBVCxLQUFzQixpQkFBMUIsRUFBNkM7QUFDekM7QUFDQSxVQUFNQyxRQUFRLEdBQUdULGVBQWUsQ0FBQ0csUUFBaEIsQ0FBeUJPLElBQXpCLENBQThCLFdBQTlCLEVBQTJDLFVBQTNDLENBQWpCO0FBQ0FuQixNQUFBQSxNQUFNLENBQUNvQixzQkFBUCxDQUE4QmhDLGtCQUFrQixDQUFDSyxRQUFqRCxFQUEyRHlCLFFBQTNELEVBQXFFVCxlQUFlLENBQUNZLGtCQUFyRjtBQUNBekIsTUFBQUEsTUFBTSxDQUFDQyxZQUFQLENBQW9CVCxrQkFBa0IsQ0FBQ1UsYUFBdkM7QUFDSCxLQUxELE1BS08sSUFBSU0sUUFBUSxDQUFDYSxRQUFULEtBQXNCSixTQUExQixFQUFxQztBQUN4QztBQUNBekIsTUFBQUEsa0JBQWtCLENBQUNHLFdBQW5CLEdBQWlDLENBQWpDO0FBQ0gsS0FITSxNQUdBO0FBQ0g7QUFDQUgsTUFBQUEsa0JBQWtCLENBQUNHLFdBQW5CLElBQWtDLENBQWxDO0FBQ0g7QUFDSjtBQTVGc0IsQ0FBM0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuLyogZ2xvYmFsIGdsb2JhbFRyYW5zbGF0ZSwgIFBieEFwaSAqL1xuXG5cbi8qKlxuICogV29ya2VyIG9iamVjdCByZXNwb25zaWJsZSBmb3IgY2hlY2tpbmcgdGhlIHN0YXR1cyBvZiBtZXJnaW5nIHJlcXVlc3RzLlxuICpcbiAqIEBtb2R1bGUgbWVyZ2luZ0NoZWNrV29ya2VyXG4gKi9cbmNvbnN0IG1lcmdpbmdDaGVja1dvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgc3RhdHVzIG9mIG1lcmdpbmcgcmVxdWVzdC5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXQ6IDMwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciB0aGUgc3RhdHVzIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG5cbiAgICAvKipcbiAgICAgKiBOdW1iZXIgb2YgZXJyb3IgY291bnRzIGVuY291bnRlcmVkIGR1cmluZyBtZXJnaW5nIHJlcXVlc3QuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBlcnJvckNvdW50czogMCxcblxuICAgIC8qKlxuICAgICAqIEZpbGUgSUQgb2YgdGhlIG1lcmdpbmcgcmVxdWVzdC5cbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIGZpbGVJRDogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIEZpbGUgcGF0aCBvZiB0aGUgbWVyZ2luZyByZXF1ZXN0LlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgZmlsZVBhdGg6ICcnLFxuXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgbWVyZ2luZyBjaGVjayB3b3JrZXIuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbGVJRCAtIFRoZSBJRCBvZiB0aGUgbWVyZ2luZyByZXF1ZXN0LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aCAtIFRoZSBmaWxlIHBhdGggb2YgdGhlIG1lcmdpbmcgcmVxdWVzdC5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKGZpbGVJRCwgZmlsZVBhdGgpIHtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVJRCA9IGZpbGVJRDtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVQYXRoID0gZmlsZVBhdGg7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5yZXN0YXJ0V29ya2VyKGZpbGVJRCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSBtZXJnaW5nIGNoZWNrIHdvcmtlci5cbiAgICAgKi9cbiAgICByZXN0YXJ0V29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KG1lcmdpbmdDaGVja1dvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtcyB0aGUgbWVyZ2luZyBjaGVjayBvcGVyYXRpb24uXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICBQYnhBcGkuRmlsZXNHZXRTdGF0dXNVcGxvYWRGaWxlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlSUQsIG1lcmdpbmdDaGVja1dvcmtlci5jYkFmdGVyUmVzcG9uc2UpO1xuICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcixcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci50aW1lT3V0LFxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBjYWxsZWQgYWZ0ZXIgcmVjZWl2aW5nIHRoZSBtZXJnaW5nIHJlc3BvbnNlLlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSAtIFRoZSBtZXJnaW5nIHJlc3BvbnNlLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZXNwb25zZShyZXNwb25zZSkge1xuICAgICAgICBpZiAobWVyZ2luZ0NoZWNrV29ya2VyLmVycm9yQ291bnRzID4gMTApIHtcbiAgICAgICAgICAgIC8vIFNob3cgZXJyb3IgbWVzc2FnZSBpZiB0aGUgZXJyb3IgY291bnQgZXhjZWVkcyB0aGUgdGhyZXNob2xkXG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoZ2xvYmFsVHJhbnNsYXRlLnNmX1VwbG9hZEVycm9yKTtcbiAgICAgICAgICAgIHNvdW5kRmlsZU1vZGlmeS4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICBzb3VuZEZpbGVNb2RpZnkuJGZvcm1PYmoucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQobWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IE9iamVjdC5rZXlzKHJlc3BvbnNlKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIC8vIEluY3JlbWVudCBlcnJvciBjb3VudCBpZiB0aGUgcmVzcG9uc2UgaXMgdW5kZWZpbmVkIG9yIGVtcHR5XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgKz0gMTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzcG9uc2UuZF9zdGF0dXMgPT09ICdVUExPQURfQ09NUExFVEUnKSB7XG4gICAgICAgICAgICAvLyBTdGFydCBjb252ZXJ0aW5nIHRoZSBhdWRpbyBmaWxlIGlmIHRoZSBtZXJnaW5nIGlzIGNvbXBsZXRlXG4gICAgICAgICAgICBjb25zdCBjYXRlZ29yeSA9IHNvdW5kRmlsZU1vZGlmeS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCAnY2F0ZWdvcnknKTtcbiAgICAgICAgICAgIFBieEFwaS5TeXN0ZW1Db252ZXJ0QXVkaW9GaWxlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCwgY2F0ZWdvcnksIHNvdW5kRmlsZU1vZGlmeS5jYkFmdGVyQ29udmVydEZpbGUpO1xuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZF9zdGF0dXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgLy8gUmVzZXQgZXJyb3IgY291bnQgaWYgdGhlIHJlc3BvbnNlIHN0YXR1cyBpcyBkZWZpbmVkXG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gSW5jcmVtZW50IGVycm9yIGNvdW50IGZvciBvdGhlciBjYXNlc1xuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmVycm9yQ291bnRzICs9IDE7XG4gICAgICAgIH1cbiAgICB9LFxufTtcbiJdfQ==
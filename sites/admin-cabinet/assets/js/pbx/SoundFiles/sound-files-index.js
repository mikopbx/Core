"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalTranslate, SemanticLocalization, PbxApi, globalRootUrl, IndexSoundPlayer*/

/**
 * Object representing sound files table.
 *
 * @module soundFiles
 */
var soundFiles = {
  $audioFilesList: $('#custom-sound-files-table, #moh-sound-files-table'),
  $tabMenuItems: $('#sound-files-menu .item'),

  /**
   * Initializes the sound files table.
   */
  initialize: function initialize() {
    // Initialize tab menu with history tracking
    soundFiles.$tabMenuItems.tab({
      history: true,
      historyType: 'hash'
    }); // Initialize DataTable for audio files list

    soundFiles.$audioFilesList.DataTable({
      lengthChange: false,
      paging: false,
      columns: [null, {
        orderable: false,
        searchable: false
      }, {
        orderable: false,
        searchable: false
      }],
      order: [0, 'asc'],
      initComplete: function initComplete() {
        // Initialize IndexSoundPlayer for each file row
        $('.file-row').each(function (index, row) {
          var id = $(row).attr('id');
          return new IndexSoundPlayer(id);
        });
      },
      language: SemanticLocalization.dataTableLocalisation
    });
    soundFiles.dataTable = soundFiles.$audioFilesList.DataTable();
    soundFiles.dataTable.on('draw', function () {
      // Reinitialize IndexSoundPlayer for each file row after DataTable redraw
      $('.file-row').each(function (index, row) {
        var id = $(row).attr('id');
        return new IndexSoundPlayer(id);
      });
    }); // Move the "Add New" button to the first eight-column div

    $('#add-new-custom-button').appendTo($('#custom-sound-files-table_wrapper div.eight.column:eq(0)'));
    $('#add-new-moh-button').appendTo($('#moh-sound-files-table_wrapper div.eight.column:eq(0)')); // Add error event listener to audio elements

    var toArray = Array.prototype.slice;
    toArray.apply(document.getElementsByTagName('audio')).forEach(function (audio) {
      audio.addEventListener('error', soundFiles.handleMediaError);
    }); // Add click event listener to delete links

    $('body').on('click', 'a.delete', function (e) {
      e.preventDefault();
      var fileName = $(e.target).closest('tr').attr('data-value');
      var fileId = $(e.target).closest('tr').attr('id');
      PbxApi.FilesRemoveAudioFile(fileName, fileId, soundFiles.cbAfterDelete);
    });
  },

  /**
   * Callback after successful file deletion.
   * @param {string} id - The ID of the deleted file.
   * @returns {boolean}
   */
  cbAfterDelete: function cbAfterDelete(id) {
    $('.message.ajax').remove();
    $.api({
      url: "".concat(globalRootUrl, "sound-files/delete/").concat(id),
      on: 'now',
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0;
      },
      onSuccess: function onSuccess(response) {
        if (response.success === true) {
          soundFiles.$audioFilesList.find("tr[id=".concat(id, "]")).remove();
          sessionStorage.removeItem("".concat(globalRootUrl, "sound-files/getSoundFiles/custom"));
          sessionStorage.removeItem("".concat(globalRootUrl, "sound-files/getSoundFiles/moh"));
        } else {
          UserMessage.showMultiString(response.message);
        }
      }
    });
  },

  /**
   * Handles media errors.
   * @param {Event} e - The error event.
   */
  handleMediaError: function handleMediaError(e) {
    switch (e.target.error.code) {
      case e.target.error.MEDIA_ERR_ABORTED:
        console.log('You aborted the media playback.');
        break;

      case e.target.error.MEDIA_ERR_NETWORK:
        console.log('A network error caused the media download to fail.');
        break;

      case e.target.error.MEDIA_ERR_DECODE:
        console.log('The media playback was aborted due to a corruption problem or because the media used features your browser did not support.');
        break;

      case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
        console.log('The media could not be loaded, either because the server or network failed or because the format is not supported.');
        break;

      default:
        console.log('An unknown media error occurred.');
    }

    var $row = $(e.target).closest('tr');
    $row.addClass('negative');
    $row.find('td.player').html(globalTranslate.sf_FileNotFound);
  }
}; // When the document is ready, initialize the sound files table

$(document).ready(function () {
  soundFiles.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Tb3VuZEZpbGVzL3NvdW5kLWZpbGVzLWluZGV4LmpzIl0sIm5hbWVzIjpbInNvdW5kRmlsZXMiLCIkYXVkaW9GaWxlc0xpc3QiLCIkIiwiJHRhYk1lbnVJdGVtcyIsImluaXRpYWxpemUiLCJ0YWIiLCJoaXN0b3J5IiwiaGlzdG9yeVR5cGUiLCJEYXRhVGFibGUiLCJsZW5ndGhDaGFuZ2UiLCJwYWdpbmciLCJjb2x1bW5zIiwib3JkZXJhYmxlIiwic2VhcmNoYWJsZSIsIm9yZGVyIiwiaW5pdENvbXBsZXRlIiwiZWFjaCIsImluZGV4Iiwicm93IiwiaWQiLCJhdHRyIiwiSW5kZXhTb3VuZFBsYXllciIsImxhbmd1YWdlIiwiU2VtYW50aWNMb2NhbGl6YXRpb24iLCJkYXRhVGFibGVMb2NhbGlzYXRpb24iLCJkYXRhVGFibGUiLCJvbiIsImFwcGVuZFRvIiwidG9BcnJheSIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJhcHBseSIsImRvY3VtZW50IiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJmb3JFYWNoIiwiYXVkaW8iLCJhZGRFdmVudExpc3RlbmVyIiwiaGFuZGxlTWVkaWFFcnJvciIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImZpbGVOYW1lIiwidGFyZ2V0IiwiY2xvc2VzdCIsImZpbGVJZCIsIlBieEFwaSIsIkZpbGVzUmVtb3ZlQXVkaW9GaWxlIiwiY2JBZnRlckRlbGV0ZSIsInJlbW92ZSIsImFwaSIsInVybCIsImdsb2JhbFJvb3RVcmwiLCJzdWNjZXNzVGVzdCIsInJlc3BvbnNlIiwidW5kZWZpbmVkIiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsIm9uU3VjY2VzcyIsInN1Y2Nlc3MiLCJmaW5kIiwic2Vzc2lvblN0b3JhZ2UiLCJyZW1vdmVJdGVtIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJtZXNzYWdlIiwiZXJyb3IiLCJjb2RlIiwiTUVESUFfRVJSX0FCT1JURUQiLCJjb25zb2xlIiwibG9nIiwiTUVESUFfRVJSX05FVFdPUksiLCJNRURJQV9FUlJfREVDT0RFIiwiTUVESUFfRVJSX1NSQ19OT1RfU1VQUE9SVEVEIiwiJHJvdyIsImFkZENsYXNzIiwiaHRtbCIsImdsb2JhbFRyYW5zbGF0ZSIsInNmX0ZpbGVOb3RGb3VuZCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLFVBQVUsR0FBRztBQUNmQyxFQUFBQSxlQUFlLEVBQUVDLENBQUMsQ0FBQyxtREFBRCxDQURIO0FBRWZDLEVBQUFBLGFBQWEsRUFBRUQsQ0FBQyxDQUFDLHlCQUFELENBRkQ7O0FBSWY7QUFDSjtBQUNBO0FBQ0lFLEVBQUFBLFVBUGUsd0JBT0Y7QUFDVDtBQUNBSixJQUFBQSxVQUFVLENBQUNHLGFBQVgsQ0FBeUJFLEdBQXpCLENBQTZCO0FBQ3pCQyxNQUFBQSxPQUFPLEVBQUUsSUFEZ0I7QUFFekJDLE1BQUFBLFdBQVcsRUFBRTtBQUZZLEtBQTdCLEVBRlMsQ0FPVDs7QUFDQVAsSUFBQUEsVUFBVSxDQUFDQyxlQUFYLENBQTJCTyxTQUEzQixDQUFxQztBQUNqQ0MsTUFBQUEsWUFBWSxFQUFFLEtBRG1CO0FBRWpDQyxNQUFBQSxNQUFNLEVBQUUsS0FGeUI7QUFHakNDLE1BQUFBLE9BQU8sRUFBRSxDQUNMLElBREssRUFFTDtBQUFDQyxRQUFBQSxTQUFTLEVBQUUsS0FBWjtBQUFtQkMsUUFBQUEsVUFBVSxFQUFFO0FBQS9CLE9BRkssRUFHTDtBQUFDRCxRQUFBQSxTQUFTLEVBQUUsS0FBWjtBQUFtQkMsUUFBQUEsVUFBVSxFQUFFO0FBQS9CLE9BSEssQ0FId0I7QUFRakNDLE1BQUFBLEtBQUssRUFBRSxDQUFDLENBQUQsRUFBSSxLQUFKLENBUjBCO0FBU2pDQyxNQUFBQSxZQVRpQywwQkFTbEI7QUFDWDtB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QUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxrQ0FBWjtBQWRSOztBQWdCQSxRQUFNSSxJQUFJLEdBQUd4RSxDQUFDLENBQUNxQyxDQUFDLENBQUNHLE1BQUgsQ0FBRCxDQUFZQyxPQUFaLENBQW9CLElBQXBCLENBQWI7QUFDQStCLElBQUFBLElBQUksQ0FBQ0MsUUFBTCxDQUFjLFVBQWQ7QUFDQUQsSUFBQUEsSUFBSSxDQUFDZCxJQUFMLENBQVUsV0FBVixFQUF1QmdCLElBQXZCLENBQTRCQyxlQUFlLENBQUNDLGVBQTVDO0FBQ0g7QUFuSGMsQ0FBbkIsQyxDQXNIQTs7QUFDQTVFLENBQUMsQ0FBQytCLFFBQUQsQ0FBRCxDQUFZOEMsS0FBWixDQUFrQixZQUFNO0FBQ3BCL0UsRUFBQUEsVUFBVSxDQUFDSSxVQUFYO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxUcmFuc2xhdGUsIFNlbWFudGljTG9jYWxpemF0aW9uLCBQYnhBcGksIGdsb2JhbFJvb3RVcmwsIEluZGV4U291bmRQbGF5ZXIqL1xuXG5cbi8qKlxuICogT2JqZWN0IHJlcHJlc2VudGluZyBzb3VuZCBmaWxlcyB0YWJsZS5cbiAqXG4gKiBAbW9kdWxlIHNvdW5kRmlsZXNcbiAqL1xuY29uc3Qgc291bmRGaWxlcyA9IHtcbiAgICAkYXVkaW9GaWxlc0xpc3Q6ICQoJyNjdXN0b20tc291bmQtZmlsZXMtdGFibGUsICNtb2gtc291bmQtZmlsZXMtdGFibGUnKSxcbiAgICAkdGFiTWVudUl0ZW1zOiAkKCcjc291bmQtZmlsZXMtbWVudSAuaXRlbScpLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIHNvdW5kIGZpbGVzIHRhYmxlLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIC8vIEluaXRpYWxpemUgdGFiIG1lbnUgd2l0aCBoaXN0b3J5IHRyYWNraW5nXG4gICAgICAgIHNvdW5kRmlsZXMuJHRhYk1lbnVJdGVtcy50YWIoe1xuICAgICAgICAgICAgaGlzdG9yeTogdHJ1ZSxcbiAgICAgICAgICAgIGhpc3RvcnlUeXBlOiAnaGFzaCcsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgRGF0YVRhYmxlIGZvciBhdWRpbyBmaWxlcyBsaXN0XG4gICAgICAgIHNvdW5kRmlsZXMuJGF1ZGlvRmlsZXNMaXN0LkRhdGFUYWJsZSh7XG4gICAgICAgICAgICBsZW5ndGhDaGFuZ2U6IGZhbHNlLFxuICAgICAgICAgICAgcGFnaW5nOiBmYWxzZSxcbiAgICAgICAgICAgIGNvbHVtbnM6IFtcbiAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgIHtvcmRlcmFibGU6IGZhbHNlLCBzZWFyY2hhYmxlOiBmYWxzZX0sXG4gICAgICAgICAgICAgICAge29yZGVyYWJsZTogZmFsc2UsIHNlYXJjaGFibGU6IGZhbHNlfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBvcmRlcjogWzAsICdhc2MnXSxcbiAgICAgICAgICAgIGluaXRDb21wbGV0ZSgpIHtcbiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEluZGV4U291bmRQbGF5ZXIgZm9yIGVhY2ggZmlsZSByb3dcbiAgICAgICAgICAgICAgICAkKCcuZmlsZS1yb3cnKS5lYWNoKChpbmRleCwgcm93KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gJChyb3cpLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSW5kZXhTb3VuZFBsYXllcihpZCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbGFuZ3VhZ2U6IFNlbWFudGljTG9jYWxpemF0aW9uLmRhdGFUYWJsZUxvY2FsaXNhdGlvbixcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc291bmRGaWxlcy5kYXRhVGFibGUgPSBzb3VuZEZpbGVzLiRhdWRpb0ZpbGVzTGlzdC5EYXRhVGFibGUoKTtcblxuICAgICAgICBzb3VuZEZpbGVzLmRhdGFUYWJsZS5vbignZHJhdycsICgpID0+IHtcbiAgICAgICAgICAgIC8vIFJlaW5pdGlhbGl6ZSBJbmRleFNvdW5kUGxheWVyIGZvciBlYWNoIGZpbGUgcm93IGFmdGVyIERhdGFUYWJsZSByZWRyYXdcbiAgICAgICAgICAgICQoJy5maWxlLXJvdycpLmVhY2goKGluZGV4LCByb3cpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9ICQocm93KS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSW5kZXhTb3VuZFBsYXllcihpZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTW92ZSB0aGUgXCJBZGQgTmV3XCIgYnV0dG9uIHRvIHRoZSBmaXJzdCBlaWdodC1jb2x1bW4gZGl2XG4gICAgICAgICQoJyNhZGQtbmV3LWN1c3RvbS1idXR0b24nKS5hcHBlbmRUbygkKCcjY3VzdG9tLXNvdW5kLWZpbGVzLXRhYmxlX3dyYXBwZXIgZGl2LmVpZ2h0LmNvbHVtbjplcSgwKScpKTtcbiAgICAgICAgJCgnI2FkZC1uZXctbW9oLWJ1dHRvbicpLmFwcGVuZFRvKCQoJyNtb2gtc291bmQtZmlsZXMtdGFibGVfd3JhcHBlciBkaXYuZWlnaHQuY29sdW1uOmVxKDApJykpO1xuXG5cbiAgICAgICAgLy8gQWRkIGVycm9yIGV2ZW50IGxpc3RlbmVyIHRvIGF1ZGlvIGVsZW1lbnRzXG4gICAgICAgIGNvbnN0IHRvQXJyYXkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7XG4gICAgICAgIHRvQXJyYXkuYXBwbHkoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2F1ZGlvJykpLmZvckVhY2goKGF1ZGlvKSA9PiB7XG4gICAgICAgICAgICBhdWRpby5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIHNvdW5kRmlsZXMuaGFuZGxlTWVkaWFFcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEFkZCBjbGljayBldmVudCBsaXN0ZW5lciB0byBkZWxldGUgbGlua3NcbiAgICAgICAgJCgnYm9keScpLm9uKCdjbGljaycsICdhLmRlbGV0ZScsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJ3RyJykuYXR0cignZGF0YS12YWx1ZScpO1xuICAgICAgICAgICAgY29uc3QgZmlsZUlkID0gJChlLnRhcmdldCkuY2xvc2VzdCgndHInKS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgUGJ4QXBpLkZpbGVzUmVtb3ZlQXVkaW9GaWxlKGZpbGVOYW1lLCBmaWxlSWQsIHNvdW5kRmlsZXMuY2JBZnRlckRlbGV0ZSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBhZnRlciBzdWNjZXNzZnVsIGZpbGUgZGVsZXRpb24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gVGhlIElEIG9mIHRoZSBkZWxldGVkIGZpbGUuXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgY2JBZnRlckRlbGV0ZShpZCkge1xuICAgICAgICAkKCcubWVzc2FnZS5hamF4JykucmVtb3ZlKCk7XG4gICAgICAgICQuYXBpKHtcbiAgICAgICAgICAgIHVybDogYCR7Z2xvYmFsUm9vdFVybH1zb3VuZC1maWxlcy9kZWxldGUvJHtpZH1gLFxuICAgICAgICAgICAgb246ICdub3cnLFxuICAgICAgICAgICAgc3VjY2Vzc1Rlc3QocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAvLyB0ZXN0IHdoZXRoZXIgYSBKU09OIHJlc3BvbnNlIGlzIHZhbGlkXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgJiYgT2JqZWN0LmtleXMocmVzcG9uc2UpLmxlbmd0aCA+IDA7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25TdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgc291bmRGaWxlcy4kYXVkaW9GaWxlc0xpc3QuZmluZChgdHJbaWQ9JHtpZH1dYCkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oYCR7Z2xvYmFsUm9vdFVybH1zb3VuZC1maWxlcy9nZXRTb3VuZEZpbGVzL2N1c3RvbWApO1xuICAgICAgICAgICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGAke2dsb2JhbFJvb3RVcmx9c291bmQtZmlsZXMvZ2V0U291bmRGaWxlcy9tb2hgKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgbWVkaWEgZXJyb3JzLlxuICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgLSBUaGUgZXJyb3IgZXZlbnQuXG4gICAgICovXG4gICAgaGFuZGxlTWVkaWFFcnJvcihlKSB7XG4gICAgICAgIHN3aXRjaCAoZS50YXJnZXQuZXJyb3IuY29kZSkge1xuICAgICAgICAgICAgY2FzZSBlLnRhcmdldC5lcnJvci5NRURJQV9FUlJfQUJPUlRFRDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnWW91IGFib3J0ZWQgdGhlIG1lZGlhIHBsYXliYWNrLicpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBlLnRhcmdldC5lcnJvci5NRURJQV9FUlJfTkVUV09SSzpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQSBuZXR3b3JrIGVycm9yIGNhdXNlZCB0aGUgbWVkaWEgZG93bmxvYWQgdG8gZmFpbC4nKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgZS50YXJnZXQuZXJyb3IuTUVESUFfRVJSX0RFQ09ERTpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVGhlIG1lZGlhIHBsYXliYWNrIHdhcyBhYm9ydGVkIGR1ZSB0byBhIGNvcnJ1cHRpb24gcHJvYmxlbSBvciBiZWNhdXNlIHRoZSBtZWRpYSB1c2VkIGZlYXR1cmVzIHlvdXIgYnJvd3NlciBkaWQgbm90IHN1cHBvcnQuJyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGUudGFyZ2V0LmVycm9yLk1FRElBX0VSUl9TUkNfTk9UX1NVUFBPUlRFRDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVGhlIG1lZGlhIGNvdWxkIG5vdCBiZSBsb2FkZWQsIGVpdGhlciBiZWNhdXNlIHRoZSBzZXJ2ZXIgb3IgbmV0d29yayBmYWlsZWQgb3IgYmVjYXVzZSB0aGUgZm9ybWF0IGlzIG5vdCBzdXBwb3J0ZWQuJyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdBbiB1bmtub3duIG1lZGlhIGVycm9yIG9jY3VycmVkLicpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0ICRyb3cgPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCd0cicpO1xuICAgICAgICAkcm93LmFkZENsYXNzKCduZWdhdGl2ZScpO1xuICAgICAgICAkcm93LmZpbmQoJ3RkLnBsYXllcicpLmh0bWwoZ2xvYmFsVHJhbnNsYXRlLnNmX0ZpbGVOb3RGb3VuZCk7XG4gICAgfSxcbn07XG5cbi8vIFdoZW4gdGhlIGRvY3VtZW50IGlzIHJlYWR5LCBpbml0aWFsaXplIHRoZSBzb3VuZCBmaWxlcyB0YWJsZVxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIHNvdW5kRmlsZXMuaW5pdGlhbGl6ZSgpO1xufSk7XG5cbiJdfQ==
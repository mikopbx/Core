"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalTranslate */

/**
 * The Form object is responsible for sending forms data to backend
 *
 * @module Form
 */
var Form = {
  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: '',

  /**
   * Validation rules for the form fields before submission.
   *
   * @type {object}
   */
  validateRules: {},

  /**
   * Dirty check field, for checking if something on the form was changed
   * @type {jQuery}
   */
  $dirrtyField: $('#dirrty'),
  url: '',
  cbBeforeSendForm: '',
  cbAfterSendForm: '',
  $submitButton: $('#submitbutton'),
  $dropdownSubmit: $('#dropdownSubmit'),
  $submitModeInput: $('input[name="submitMode"]'),
  processData: true,
  contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
  keyboardShortcuts: true,
  enableDirrity: true,
  afterSubmitIndexUrl: '',
  afterSubmitModifyUrl: '',
  oldFormValues: [],
  initialize: function initialize() {
    // Set up custom form validation rules
    Form.$formObj.form.settings.rules.notRegExp = Form.notRegExpValidateRule;
    Form.$formObj.form.settings.rules.specialCharactersExist = Form.specialCharactersExistValidateRule;

    if (Form.enableDirrity) {
      // Initialize dirrity if enabled
      Form.initializeDirrity();
    } // Handle click event on submit button


    Form.$submitButton.on('click', function (e) {
      e.preventDefault();
      if (Form.$submitButton.hasClass('loading')) return;
      if (Form.$submitButton.hasClass('disabled')) return; // Set up form validation and submit

      Form.$formObj.form({
        on: 'blur',
        fields: Form.validateRules,
        onSuccess: function onSuccess() {
          // Call submitForm() on successful validation
          Form.submitForm();
        },
        onFailure: function onFailure() {
          // Add error class to form on validation failure
          Form.$formObj.removeClass('error').addClass('error');
        }
      });
      Form.$formObj.form('validate form');
    }); // Handle dropdown submit

    if (Form.$dropdownSubmit.length > 0) {
      Form.$dropdownSubmit.dropdown({
        onChange: function onChange(value) {
          var translateKey = "bt_".concat(value);
          Form.$submitModeInput.val(value);
          Form.$submitButton.html("<i class=\"save icon\"></i> ".concat(globalTranslate[translateKey])).click();
        }
      });
    } // Prevent form submission on enter keypress


    Form.$formObj.on('submit', function (e) {
      e.preventDefault();
    });
  },

  /**
   * Initializes tracking of form changes.
   */
  initializeDirrity: function initializeDirrity() {
    Form.saveInitialValues();
    Form.setEvents();
    Form.$submitButton.addClass('disabled');
    Form.$dropdownSubmit.addClass('disabled');
  },

  /**
   * Saves the initial form values for comparison.
   */
  saveInitialValues: function saveInitialValues() {
    Form.oldFormValues = Form.$formObj.form('get values');
  },

  /**
   * Sets up event handlers for form objects.
   */
  setEvents: function setEvents() {
    Form.$formObj.find('input, select').change(function () {
      Form.checkValues();
    });
    Form.$formObj.find('input, textarea').on('keyup keydown blur', function () {
      Form.checkValues();
    });
    Form.$formObj.find('.ui.checkbox').on('click', function () {
      Form.checkValues();
    });
  },

  /**
   * Compares the old and new form values for changes.
   */
  checkValues: function checkValues() {
    var newFormValues = Form.$formObj.form('get values');

    if (JSON.stringify(Form.oldFormValues) === JSON.stringify(newFormValues)) {
      Form.$submitButton.addClass('disabled');
      Form.$dropdownSubmit.addClass('disabled');
    } else {
      Form.$submitButton.removeClass('disabled');
      Form.$dropdownSubmit.removeClass('disabled');
    }
  },

  /**
   *  Changes the value of '$dirrtyField' to trigger
   *  the 'change' form event and enable submit button.
   */
  dataChanged: function dataChanged() {
    if (Form.enableDirrity) {
      Form.$dirrtyField.val(Math.random());
      Form.$dirrtyField.trigger('change');
    }
  },

  /**
   * Submits the form to the server.
   */
  submitForm: function submitForm() {
    $.api({
      url: Form.url,
      on: 'now',
      method: 'POST',
      processData: Form.processData,
      contentType: Form.contentType,
      keyboardShortcuts: Form.keyboardShortcuts,

      /**
       * Executes before sending the request.
       * @param {object} settings - The API settings object.
       * @returns {object} - The modified API settings object.
       */
      beforeSend: function beforeSend(settings) {
        // Add 'loading' class to the submit button
        Form.$submitButton.addClass('loading'); // Call cbBeforeSendForm function and handle the result

        var cbBeforeSendResult = Form.cbBeforeSendForm(settings);

        if (cbBeforeSendResult === false) {
          // If cbBeforeSendForm returns false, remove 'loading' class and perform a 'shake' transition on the submit button
          Form.$submitButton.transition('shake').removeClass('loading');
        } else {
          // Iterate over cbBeforeSendResult data, trim string values, and exclude sensitive information from being modified
          $.each(cbBeforeSendResult.data, function (index, value) {
            if (index.indexOf('ecret') > -1 || index.indexOf('assword') > -1) return;
            if (typeof value === 'string') cbBeforeSendResult.data[index] = value.trim();
          });
        }

        return cbBeforeSendResult;
      },

      /**
       * Executes when the request is successful.
       * @param {object} response - The response object.
       */
      onSuccess: function onSuccess(response) {
        // Remove any existing AJAX messages
        $('.ui.message.ajax').remove(); // Iterate over response message and handle errors

        $.each(response.message, function (index, value) {
          if (index === 'error') {
            // If there is an error, perform a 'shake' transition on the submit button and add an error message after the form
            Form.$submitButton.transition('shake').removeClass('loading');
            Form.$formObj.after("<div class=\"ui ".concat(index, " message ajax\">").concat(value, "</div>"));
          }
        }); // Dispatch 'ConfigDataChanged' event

        var event = document.createEvent('Event');
        event.initEvent('ConfigDataChanged', false, true);
        window.dispatchEvent(event); // Call cbAfterSendForm function

        Form.cbAfterSendForm(response); // Check response conditions and perform necessary actions

        if (response.success && response.reload.length > 0 && Form.$submitModeInput.val() === 'SaveSettings') {
          // Redirect to the specified URL if conditions are met
          window.location = globalRootUrl + response.reload;
        } else if (response.success && Form.$submitModeInput.val() === 'SaveSettingsAndAddNew') {
          // Handle SaveSettingsAndAddNew scenario
          if (Form.afterSubmitModifyUrl.length > 1) {
            window.location = Form.afterSubmitModifyUrl;
          } else {
            var emptyUrl = window.location.href.split('modify');
            var action = 'modify';
            var prefixData = emptyUrl[1].split('/');

            if (prefixData.length > 0) {
              action = action + prefixData[0];
            }

            if (emptyUrl.length > 1) {
              window.location = "".concat(emptyUrl[0]).concat(action, "/");
            }
          }
        } else if (response.success && Form.$submitModeInput.val() === 'SaveSettingsAndExit') {
          // Handle SaveSettingsAndExit scenario
          if (Form.afterSubmitIndexUrl.length > 1) {
            window.location = Form.afterSubmitIndexUrl;
          } else {
            var _emptyUrl = window.location.href.split('modify');

            if (_emptyUrl.length > 1) {
              window.location = "".concat(_emptyUrl[0], "index/");
            }
          }
        } else if (response.success && response.reload.length > 0) {
          // Redirect to the specified URL if conditions are met
          window.location = globalRootUrl + response.reload;
        } else if (response.success && Form.enableDirrity) {
          // Initialize dirrity if conditions are met
          Form.initializeDirrity();
        } // Remove 'loading' class from the submit button


        Form.$submitButton.removeClass('loading');
      },

      /**
       * Executes when the request fails.
       * @param {object} response - The response object.
       */
      onFailure: function onFailure(response) {
        // Add the response message after the form and perform a 'shake' transition on the submit button
        Form.$formObj.after(response);
        Form.$submitButton.transition('shake').removeClass('loading');
      }
    });
  },

  /**
   * Checks if the value does not match the regex pattern.
   * @param {string} value - The value to validate.
   * @param {RegExp} regex - The regex pattern to match against.
   * @returns {boolean} - True if the value does not match the regex, false otherwise.
   */
  notRegExpValidateRule: function notRegExpValidateRule(value, regex) {
    return value.match(regex) !== null;
  },

  /**
   * Checks if the value contains special characters.
   * @param {string} value - The value to validate.
   * @returns {boolean} - True if the value contains special characters, false otherwise.
   */
  specialCharactersExistValidateRule: function specialCharactersExistValidateRule(value) {
    return value.match(/[()$^;#"><,.%№@!+=_]/) === null;
  }
}; // export default Form;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWluL2Zvcm0uanMiXSwibmFtZXMiOlsiRm9ybSIsIiRmb3JtT2JqIiwidmFsaWRhdGVSdWxlcyIsIiRkaXJydHlGaWVsZCIsIiQiLCJ1cmwiLCJjYkJlZm9yZVNlbmRGb3JtIiwiY2JBZnRlclNlbmRGb3JtIiwiJHN1Ym1pdEJ1dHRvbiIsIiRkcm9wZG93blN1Ym1pdCIsIiRzdWJtaXRNb2RlSW5wdXQiLCJwcm9jZXNzRGF0YSIsImNvbnRlbnRUeXBlIiwia2V5Ym9hcmRTaG9ydGN1dHMiLCJlbmFibGVEaXJyaXR5IiwiYWZ0ZXJTdWJtaXRJbmRleFVybCIsImFmdGVyU3VibWl0TW9kaWZ5VXJsIiwib2xkRm9ybVZhbHVlcyIsImluaXRpYWxpemUiLCJmb3JtIiwic2V0dGluZ3MiLCJydWxlcyIsIm5vdFJlZ0V4cCIsIm5vdFJlZ0V4cFZhbGlkYXRlUnVsZSIsInNwZWNpYWxDaGFyYWN0ZXJzRXhpc3QiLCJzcGVjaWFsQ2hhcmFjdGVyc0V4aXN0VmFsaWRhdGVSdWxlIiwiaW5pdGlhbGl6ZURpcnJpdHkiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImhhc0NsYXNzIiwiZmllbGRzIiwib25TdWNjZXNzIiwic3VibWl0Rm9ybSIsIm9uRmFpbHVyZSIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJsZW5ndGgiLCJkcm9wZG93biIsIm9uQ2hhbmdlIiwidmFsdWUiLCJ0cmFuc2xhdGVLZXkiLCJ2YWwiLCJodG1sIiwiZ2xvYmFsVHJhbnNsYXRlIiwiY2xpY2siLCJzYXZlSW5pdGlhbFZhbHVlcyIsInNldEV2ZW50cyIsImZpbmQiLCJjaGFuZ2UiLCJjaGVja1ZhbHVlcyIsIm5ld0Zvcm1WYWx1ZXMiLCJKU09OIiwic3RyaW5naWZ5IiwiZGF0YUNoYW5nZWQiLCJNYXRoIiwicmFuZG9tIiwidHJpZ2dlciIsImFwaSIsIm1ldGhvZCIsImJlZm9yZVNlbmQiLCJjYkJlZm9yZVNlbmRSZXN1bHQiLCJ0cmFuc2l0aW9uIiwiZWFjaCIsImRhdGEiLCJpbmRleCIsImluZGV4T2YiLCJ0cmltIiwicmVzcG9uc2UiLCJyZW1vdmUiLCJtZXNzYWdlIiwiYWZ0ZXIiLCJldmVudCIsImRvY3VtZW50IiwiY3JlYXRlRXZlbnQiLCJpbml0RXZlbnQiLCJ3aW5kb3ciLCJkaXNwYXRjaEV2ZW50Iiwic3VjY2VzcyIsInJlbG9hZCIsImxvY2F0aW9uIiwiZ2xvYmFsUm9vdFVybCIsImVtcHR5VXJsIiwiaHJlZiIsInNwbGl0IiwiYWN0aW9uIiwicHJlZml4RGF0YSIsInJlZ2V4IiwibWF0Y2giXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsSUFBSSxHQUFHO0FBRVQ7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsUUFBUSxFQUFFLEVBTkQ7O0FBUVQ7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxhQUFhLEVBQUUsRUFiTjs7QUFlVDtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxZQUFZLEVBQUVDLENBQUMsQ0FBQyxTQUFELENBbkJOO0FBcUJUQyxFQUFBQSxHQUFHLEVBQUUsRUFyQkk7QUFzQlRDLEVBQUFBLGdCQUFnQixFQUFFLEVBdEJUO0FBdUJUQyxFQUFBQSxlQUFlLEVBQUUsRUF2QlI7QUF3QlRDLEVBQUFBLGFBQWEsRUFBRUosQ0FBQyxDQUFDLGVBQUQsQ0F4QlA7QUF5QlRLLEVBQUFBLGVBQWUsRUFBRUwsQ0FBQyxDQUFDLGlCQUFELENBekJUO0FBMEJUTSxFQUFBQSxnQkFBZ0IsRUFBRU4sQ0FBQyxDQUFDLDBCQUFELENBMUJWO0FBMkJUTyxFQUFBQSxXQUFXLEVBQUUsSUEzQko7QUE0QlRDLEVBQUFBLFdBQVcsRUFBRSxrREE1Qko7QUE2QlRDLEVBQUFBLGlCQUFpQixFQUFFLElBN0JWO0FBOEJUQyxFQUFBQSxhQUFh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QUFDUSxhQUFMLENBQW1CMkIsV0FBbkIsQ0FBK0IsU0FBL0I7QUFDSCxPQW5HQzs7QUFxR0Y7QUFDWjtBQUNBO0FBQ0E7QUFDWUQsTUFBQUEsU0F6R0UscUJBeUdRa0MsUUF6R1IsRUF5R2tCO0FBQ2hCO0FBQ0FwRSxRQUFBQSxJQUFJLENBQUNDLFFBQUwsQ0FBY3NFLEtBQWQsQ0FBb0JILFFBQXBCO0FBQ0FwRSxRQUFBQSxJQUFJLENBQUNRLGFBQUwsQ0FDS3NELFVBREwsQ0FDZ0IsT0FEaEIsRUFFSzNCLFdBRkwsQ0FFaUIsU0FGakI7QUFHSDtBQS9HQyxLQUFOO0FBa0hILEdBclFROztBQXVRVDtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDSVosRUFBQUEscUJBN1FTLGlDQTZRYWlCLEtBN1FiLEVBNlFvQitDLEtBN1FwQixFQTZRMkI7QUFDaEMsV0FBTy9DLEtBQUssQ0FBQ2dELEtBQU4sQ0FBWUQsS0FBWixNQUF1QixJQUE5QjtBQUNILEdBL1FROztBQWlSVDtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0k5RCxFQUFBQSxrQ0F0UlMsOENBc1IwQmUsS0F0UjFCLEVBc1JpQztBQUN0QyxXQUFPQSxLQUFLLENBQUNnRCxLQUFOLENBQVksc0JBQVosTUFBd0MsSUFBL0M7QUFDSDtBQXhSUSxDQUFiLEMsQ0EyUkEiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgZ2xvYmFsVHJhbnNsYXRlICovXG5cbi8qKlxuICogVGhlIEZvcm0gb2JqZWN0IGlzIHJlc3BvbnNpYmxlIGZvciBzZW5kaW5nIGZvcm1zIGRhdGEgdG8gYmFja2VuZFxuICpcbiAqIEBtb2R1bGUgRm9ybVxuICovXG5jb25zdCBGb3JtID0ge1xuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGZvcm0uXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkZm9ybU9iajogJycsXG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0aW9uIHJ1bGVzIGZvciB0aGUgZm9ybSBmaWVsZHMgYmVmb3JlIHN1Ym1pc3Npb24uXG4gICAgICpcbiAgICAgKiBAdHlwZSB7b2JqZWN0fVxuICAgICAqL1xuICAgIHZhbGlkYXRlUnVsZXM6IHt9LFxuXG4gICAgLyoqXG4gICAgICogRGlydHkgY2hlY2sgZmllbGQsIGZvciBjaGVja2luZyBpZiBzb21ldGhpbmcgb24gdGhlIGZvcm0gd2FzIGNoYW5nZWRcbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRkaXJydHlGaWVsZDogJCgnI2RpcnJ0eScpLFxuXG4gICAgdXJsOiAnJyxcbiAgICBjYkJlZm9yZVNlbmRGb3JtOiAnJyxcbiAgICBjYkFmdGVyU2VuZEZvcm06ICcnLFxuICAgICRzdWJtaXRCdXR0b246ICQoJyNzdWJtaXRidXR0b24nKSxcbiAgICAkZHJvcGRvd25TdWJtaXQ6ICQoJyNkcm9wZG93blN1Ym1pdCcpLFxuICAgICRzdWJtaXRNb2RlSW5wdXQ6ICQoJ2lucHV0W25hbWU9XCJzdWJtaXRNb2RlXCJdJyksXG4gICAgcHJvY2Vzc0RhdGE6IHRydWUsXG4gICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgnLFxuICAgIGtleWJvYXJkU2hvcnRjdXRzOiB0cnVlLFxuICAgIGVuYWJsZURpcnJpdHk6IHRydWUsXG4gICAgYWZ0ZXJTdWJtaXRJbmRleFVybDogJycsXG4gICAgYWZ0ZXJTdWJtaXRNb2RpZnlVcmw6ICcnLFxuICAgIG9sZEZvcm1WYWx1ZXM6IFtdLFxuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIC8vIFNldCB1cCBjdXN0b20gZm9ybSB2YWxpZGF0aW9uIHJ1bGVzXG4gICAgICAgIEZvcm0uJGZvcm1PYmouZm9ybS5zZXR0aW5ncy5ydWxlcy5ub3RSZWdFeHAgPSBGb3JtLm5vdFJlZ0V4cFZhbGlkYXRlUnVsZTtcbiAgICAgICAgRm9ybS4kZm9ybU9iai5mb3JtLnNldHRpbmdzLnJ1bGVzLnNwZWNpYWxDaGFyYWN0ZXJzRXhpc3QgPSBGb3JtLnNwZWNpYWxDaGFyYWN0ZXJzRXhpc3RWYWxpZGF0ZVJ1bGU7XG5cbiAgICAgICAgaWYgKEZvcm0uZW5hYmxlRGlycml0eSkge1xuICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBkaXJyaXR5IGlmIGVuYWJsZWRcbiAgICAgICAgICAgIEZvcm0uaW5pdGlhbGl6ZURpcnJpdHkoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEhhbmRsZSBjbGljayBldmVudCBvbiBzdWJtaXQgYnV0dG9uXG4gICAgICAgIEZvcm0uJHN1Ym1pdEJ1dHRvbi5vbignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgaWYgKEZvcm0uJHN1Ym1pdEJ1dHRvbi5oYXNDbGFzcygnbG9hZGluZycpKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoRm9ybS4kc3VibWl0QnV0dG9uLmhhc0NsYXNzKCdkaXNhYmxlZCcpKSByZXR1cm47XG5cbiAgICAgICAgICAgIC8vIFNldCB1cCBmb3JtIHZhbGlkYXRpb24gYW5kIHN1Ym1pdFxuICAgICAgICAgICAgRm9ybS4kZm9ybU9ialxuICAgICAgICAgICAgICAgIC5mb3JtKHtcbiAgICAgICAgICAgICAgICAgICAgb246ICdibHVyJyxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRzOiBGb3JtLnZhbGlkYXRlUnVsZXMsXG4gICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbGwgc3VibWl0Rm9ybSgpIG9uIHN1Y2Nlc3NmdWwgdmFsaWRhdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgRm9ybS5zdWJtaXRGb3JtKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG9uRmFpbHVyZSgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFkZCBlcnJvciBjbGFzcyB0byBmb3JtIG9uIHZhbGlkYXRpb24gZmFpbHVyZVxuICAgICAgICAgICAgICAgICAgICAgICAgRm9ybS4kZm9ybU9iai5yZW1vdmVDbGFzcygnZXJyb3InKS5hZGRDbGFzcygnZXJyb3InKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIEZvcm0uJGZvcm1PYmouZm9ybSgndmFsaWRhdGUgZm9ybScpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBIYW5kbGUgZHJvcGRvd24gc3VibWl0XG4gICAgICAgIGlmIChGb3JtLiRkcm9wZG93blN1Ym1pdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBGb3JtLiRkcm9wZG93blN1Ym1pdC5kcm9wZG93bih7XG4gICAgICAgICAgICAgICAgb25DaGFuZ2U6ICh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFuc2xhdGVLZXkgPSBgYnRfJHt2YWx1ZX1gO1xuICAgICAgICAgICAgICAgICAgICBGb3JtLiRzdWJtaXRNb2RlSW5wdXQudmFsKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgRm9ybS4kc3VibWl0QnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICAuaHRtbChgPGkgY2xhc3M9XCJzYXZlIGljb25cIj48L2k+ICR7Z2xvYmFsVHJhbnNsYXRlW3RyYW5zbGF0ZUtleV19YClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jbGljaygpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFByZXZlbnQgZm9ybSBzdWJtaXNzaW9uIG9uIGVudGVyIGtleXByZXNzXG4gICAgICAgIEZvcm0uJGZvcm1PYmoub24oJ3N1Ym1pdCcsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0cmFja2luZyBvZiBmb3JtIGNoYW5nZXMuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZURpcnJpdHkoKSB7XG4gICAgICAgIEZvcm0uc2F2ZUluaXRpYWxWYWx1ZXMoKTtcbiAgICAgICAgRm9ybS5zZXRFdmVudHMoKTtcbiAgICAgICAgRm9ybS4kc3VibWl0QnV0dG9uLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICBGb3JtLiRkcm9wZG93blN1Ym1pdC5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU2F2ZXMgdGhlIGluaXRpYWwgZm9ybSB2YWx1ZXMgZm9yIGNvbXBhcmlzb24uXG4gICAgICovXG4gICAgc2F2ZUluaXRpYWxWYWx1ZXMoKSB7XG4gICAgICAgIEZvcm0ub2xkRm9ybVZhbHVlcyA9IEZvcm0uJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlcycpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTZXRzIHVwIGV2ZW50IGhhbmRsZXJzIGZvciBmb3JtIG9iamVjdHMuXG4gICAgICovXG4gICAgc2V0RXZlbnRzKCkge1xuICAgICAgICBGb3JtLiRmb3JtT2JqLmZpbmQoJ2lucHV0LCBzZWxlY3QnKS5jaGFuZ2UoKCkgPT4ge1xuICAgICAgICAgICAgRm9ybS5jaGVja1ZhbHVlcygpO1xuICAgICAgICB9KTtcbiAgICAgICAgRm9ybS4kZm9ybU9iai5maW5kKCdpbnB1dCwgdGV4dGFyZWEnKS5vbigna2V5dXAga2V5ZG93biBibHVyJywgKCkgPT4ge1xuICAgICAgICAgICAgRm9ybS5jaGVja1ZhbHVlcygpO1xuICAgICAgICB9KTtcbiAgICAgICAgRm9ybS4kZm9ybU9iai5maW5kKCcudWkuY2hlY2tib3gnKS5vbignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICBGb3JtLmNoZWNrVmFsdWVzKCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDb21wYXJlcyB0aGUgb2xkIGFuZCBuZXcgZm9ybSB2YWx1ZXMgZm9yIGNoYW5nZXMuXG4gICAgICovXG4gICAgY2hlY2tWYWx1ZXMoKSB7XG4gICAgICAgIGNvbnN0IG5ld0Zvcm1WYWx1ZXMgPSBGb3JtLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcbiAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KEZvcm0ub2xkRm9ybVZhbHVlcykgPT09IEpTT04uc3RyaW5naWZ5KG5ld0Zvcm1WYWx1ZXMpKSB7XG4gICAgICAgICAgICBGb3JtLiRzdWJtaXRCdXR0b24uYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICBGb3JtLiRkcm9wZG93blN1Ym1pdC5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEZvcm0uJHN1Ym1pdEJ1dHRvbi5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgIEZvcm0uJGRyb3Bkb3duU3VibWl0LnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqICBDaGFuZ2VzIHRoZSB2YWx1ZSBvZiAnJGRpcnJ0eUZpZWxkJyB0byB0cmlnZ2VyXG4gICAgICogIHRoZSAnY2hhbmdlJyBmb3JtIGV2ZW50IGFuZCBlbmFibGUgc3VibWl0IGJ1dHRvbi5cbiAgICAgKi9cbiAgICBkYXRhQ2hhbmdlZCgpe1xuICAgICAgICBpZiAoRm9ybS5lbmFibGVEaXJyaXR5KSB7XG4gICAgICAgICAgICBGb3JtLiRkaXJydHlGaWVsZC52YWwoTWF0aC5yYW5kb20oKSk7XG4gICAgICAgICAgICBGb3JtLiRkaXJydHlGaWVsZC50cmlnZ2VyKCdjaGFuZ2UnKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTdWJtaXRzIHRoZSBmb3JtIHRvIHRoZSBzZXJ2ZXIuXG4gICAgICovXG4gICAgc3VibWl0Rm9ybSgpIHtcbiAgICAgICAgJC5hcGkoe1xuICAgICAgICAgICAgdXJsOiBGb3JtLnVybCxcbiAgICAgICAgICAgIG9uOiAnbm93JyxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgcHJvY2Vzc0RhdGE6IEZvcm0ucHJvY2Vzc0RhdGEsXG4gICAgICAgICAgICBjb250ZW50VHlwZTogRm9ybS5jb250ZW50VHlwZSxcbiAgICAgICAgICAgIGtleWJvYXJkU2hvcnRjdXRzOiBGb3JtLmtleWJvYXJkU2hvcnRjdXRzLFxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEV4ZWN1dGVzIGJlZm9yZSBzZW5kaW5nIHRoZSByZXF1ZXN0LlxuICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gVGhlIEFQSSBzZXR0aW5ncyBvYmplY3QuXG4gICAgICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSAtIFRoZSBtb2RpZmllZCBBUEkgc2V0dGluZ3Mgb2JqZWN0LlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBiZWZvcmVTZW5kKHNldHRpbmdzKSB7XG4gICAgICAgICAgICAgICAgLy8gQWRkICdsb2FkaW5nJyBjbGFzcyB0byB0aGUgc3VibWl0IGJ1dHRvblxuICAgICAgICAgICAgICAgIEZvcm0uJHN1Ym1pdEJ1dHRvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXG4gICAgICAgICAgICAgICAgLy8gQ2FsbCBjYkJlZm9yZVNlbmRGb3JtIGZ1bmN0aW9uIGFuZCBoYW5kbGUgdGhlIHJlc3VsdFxuICAgICAgICAgICAgICAgIGNvbnN0IGNiQmVmb3JlU2VuZFJlc3VsdCA9IEZvcm0uY2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncyk7XG4gICAgICAgICAgICAgICAgaWYgKGNiQmVmb3JlU2VuZFJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gSWYgY2JCZWZvcmVTZW5kRm9ybSByZXR1cm5zIGZhbHNlLCByZW1vdmUgJ2xvYWRpbmcnIGNsYXNzIGFuZCBwZXJmb3JtIGEgJ3NoYWtlJyB0cmFuc2l0aW9uIG9uIHRoZSBzdWJtaXQgYnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIEZvcm0uJHN1Ym1pdEJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgLnRyYW5zaXRpb24oJ3NoYWtlJylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEl0ZXJhdGUgb3ZlciBjYkJlZm9yZVNlbmRSZXN1bHQgZGF0YSwgdHJpbSBzdHJpbmcgdmFsdWVzLCBhbmQgZXhjbHVkZSBzZW5zaXRpdmUgaW5mb3JtYXRpb24gZnJvbSBiZWluZyBtb2RpZmllZFxuICAgICAgICAgICAgICAgICAgICAkLmVhY2goY2JCZWZvcmVTZW5kUmVzdWx0LmRhdGEsIChpbmRleCwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleC5pbmRleE9mKCdlY3JldCcpID4gLTEgfHwgaW5kZXguaW5kZXhPZignYXNzd29yZCcpID4gLTEpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSBjYkJlZm9yZVNlbmRSZXN1bHQuZGF0YVtpbmRleF0gPSB2YWx1ZS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gY2JCZWZvcmVTZW5kUmVzdWx0O1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBFeGVjdXRlcyB3aGVuIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuXG4gICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0LlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBvblN1Y2Nlc3MocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYW55IGV4aXN0aW5nIEFKQVggbWVzc2FnZXNcbiAgICAgICAgICAgICAgICAkKCcudWkubWVzc2FnZS5hamF4JykucmVtb3ZlKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBJdGVyYXRlIG92ZXIgcmVzcG9uc2UgbWVzc2FnZSBhbmQgaGFuZGxlIGVycm9yc1xuICAgICAgICAgICAgICAgICQuZWFjaChyZXNwb25zZS5tZXNzYWdlLCAoaW5kZXgsIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gJ2Vycm9yJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgYW4gZXJyb3IsIHBlcmZvcm0gYSAnc2hha2UnIHRyYW5zaXRpb24gb24gdGhlIHN1Ym1pdCBidXR0b24gYW5kIGFkZCBhbiBlcnJvciBtZXNzYWdlIGFmdGVyIHRoZSBmb3JtXG4gICAgICAgICAgICAgICAgICAgICAgICBGb3JtLiRzdWJtaXRCdXR0b24udHJhbnNpdGlvbignc2hha2UnKS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgRm9ybS4kZm9ybU9iai5hZnRlcihgPGRpdiBjbGFzcz1cInVpICR7aW5kZXh9IG1lc3NhZ2UgYWpheFwiPiR7dmFsdWV9PC9kaXY+YCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBEaXNwYXRjaCAnQ29uZmlnRGF0YUNoYW5nZWQnIGV2ZW50XG4gICAgICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKTtcbiAgICAgICAgICAgICAgICBldmVudC5pbml0RXZlbnQoJ0NvbmZpZ0RhdGFDaGFuZ2VkJywgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcblxuICAgICAgICAgICAgICAgIC8vIENhbGwgY2JBZnRlclNlbmRGb3JtIGZ1bmN0aW9uXG4gICAgICAgICAgICAgICAgRm9ybS5jYkFmdGVyU2VuZEZvcm0ocmVzcG9uc2UpO1xuXG4gICAgICAgICAgICAgICAgLy8gQ2hlY2sgcmVzcG9uc2UgY29uZGl0aW9ucyBhbmQgcGVyZm9ybSBuZWNlc3NhcnkgYWN0aW9uc1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdWNjZXNzXG4gICAgICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLnJlbG9hZC5sZW5ndGggPiAwXG4gICAgICAgICAgICAgICAgICAgICYmIEZvcm0uJHN1Ym1pdE1vZGVJbnB1dC52YWwoKSA9PT0gJ1NhdmVTZXR0aW5ncycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVkaXJlY3QgdG8gdGhlIHNwZWNpZmllZCBVUkwgaWYgY29uZGl0aW9ucyBhcmUgbWV0XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IGdsb2JhbFJvb3RVcmwgKyByZXNwb25zZS5yZWxvYWQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdWNjZXNzICYmIEZvcm0uJHN1Ym1pdE1vZGVJbnB1dC52YWwoKSA9PT0gJ1NhdmVTZXR0aW5nc0FuZEFkZE5ldycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIFNhdmVTZXR0aW5nc0FuZEFkZE5ldyBzY2VuYXJpb1xuICAgICAgICAgICAgICAgICAgICBpZiAoRm9ybS5hZnRlclN1Ym1pdE1vZGlmeVVybC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSBGb3JtLmFmdGVyU3VibWl0TW9kaWZ5VXJsO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW1wdHlVcmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zcGxpdCgnbW9kaWZ5Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aW9uID0gJ21vZGlmeSc7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJlZml4RGF0YSA9IGVtcHR5VXJsWzFdLnNwbGl0KCcvJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlZml4RGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gYWN0aW9uICsgcHJlZml4RGF0YVswXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbXB0eVVybC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7ZW1wdHlVcmxbMF19JHthY3Rpb259L2A7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgJiYgRm9ybS4kc3VibWl0TW9kZUlucHV0LnZhbCgpID09PSAnU2F2ZVNldHRpbmdzQW5kRXhpdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIFNhdmVTZXR0aW5nc0FuZEV4aXQgc2NlbmFyaW9cbiAgICAgICAgICAgICAgICAgICAgaWYgKEZvcm0uYWZ0ZXJTdWJtaXRJbmRleFVybC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSBGb3JtLmFmdGVyU3VibWl0SW5kZXhVcmw7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbXB0eVVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnNwbGl0KCdtb2RpZnknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbXB0eVVybC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7ZW1wdHlVcmxbMF19aW5kZXgvYDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3VjY2VzcyAmJiByZXNwb25zZS5yZWxvYWQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBSZWRpcmVjdCB0byB0aGUgc3BlY2lmaWVkIFVSTCBpZiBjb25kaXRpb25zIGFyZSBtZXRcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gZ2xvYmFsUm9vdFVybCArIHJlc3BvbnNlLnJlbG9hZDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgJiYgRm9ybS5lbmFibGVEaXJyaXR5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEluaXRpYWxpemUgZGlycml0eSBpZiBjb25kaXRpb25zIGFyZSBtZXRcbiAgICAgICAgICAgICAgICAgICAgRm9ybS5pbml0aWFsaXplRGlycml0eSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIFJlbW92ZSAnbG9hZGluZycgY2xhc3MgZnJvbSB0aGUgc3VibWl0IGJ1dHRvblxuICAgICAgICAgICAgICAgIEZvcm0uJHN1Ym1pdEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBFeGVjdXRlcyB3aGVuIHRoZSByZXF1ZXN0IGZhaWxzLlxuICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIG9iamVjdC5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgb25GYWlsdXJlKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgLy8gQWRkIHRoZSByZXNwb25zZSBtZXNzYWdlIGFmdGVyIHRoZSBmb3JtIGFuZCBwZXJmb3JtIGEgJ3NoYWtlJyB0cmFuc2l0aW9uIG9uIHRoZSBzdWJtaXQgYnV0dG9uXG4gICAgICAgICAgICAgICAgRm9ybS4kZm9ybU9iai5hZnRlcihyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgRm9ybS4kc3VibWl0QnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIC50cmFuc2l0aW9uKCdzaGFrZScpXG4gICAgICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUgcmVnZXggcGF0dGVybi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgLSBUaGUgdmFsdWUgdG8gdmFsaWRhdGUuXG4gICAgICogQHBhcmFtIHtSZWdFeHB9IHJlZ2V4IC0gVGhlIHJlZ2V4IHBhdHRlcm4gdG8gbWF0Y2ggYWdhaW5zdC5cbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gLSBUcnVlIGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUgcmVnZXgsIGZhbHNlIG90aGVyd2lzZS5cbiAgICAgKi9cbiAgICBub3RSZWdFeHBWYWxpZGF0ZVJ1bGUodmFsdWUsIHJlZ2V4KSB7XG4gICAgICAgIHJldHVybiB2YWx1ZS5tYXRjaChyZWdleCkgIT09IG51bGw7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiB0aGUgdmFsdWUgY29udGFpbnMgc3BlY2lhbCBjaGFyYWN0ZXJzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byB2YWxpZGF0ZS5cbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gLSBUcnVlIGlmIHRoZSB2YWx1ZSBjb250YWlucyBzcGVjaWFsIGNoYXJhY3RlcnMsIGZhbHNlIG90aGVyd2lzZS5cbiAgICAgKi9cbiAgICBzcGVjaWFsQ2hhcmFjdGVyc0V4aXN0VmFsaWRhdGVSdWxlKHZhbHVlKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZS5tYXRjaCgvWygpJF47I1wiPjwsLiXihJZAISs9X10vKSA9PT0gbnVsbDtcbiAgICB9XG59O1xuXG4vLyBleHBvcnQgZGVmYXVsdCBGb3JtO1xuIl19
"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl,globalTranslate, Extensions, Form */

/**
 * Object for managing incoming routes table
 *
 * @module incomingRoutes
 */
var incomingRoutes = {
  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#default-rule-form'),
  $actionDropdown: $('#action'),

  /**
   * Validation rules for the form fields before submission.
   *
   * @type {object}
   */
  validateRules: {
    extension: {
      identifier: 'extension',
      rules: [{
        type: 'extensionRule',
        prompt: globalTranslate.ir_ValidateForwardingToBeFilled
      }]
    }
  },

  /**
   * Initialize the object
   */
  initialize: function initialize() {
    // Initialize table drag-and-drop with the appropriate callbacks
    $('#routingTable').tableDnD({
      onDrop: incomingRoutes.cbOnDrop,
      // Callback on dropping an item
      onDragClass: 'hoveringRow',
      // CSS class while dragging
      dragHandle: '.dragHandle' // Handle for dragging

    }); // Setup the dropdown with callback on change

    incomingRoutes.$actionDropdown.dropdown({
      onChange: incomingRoutes.toggleDisabledFieldClass
    }); // Apply initial class change based on dropdown selection

    incomingRoutes.toggleDisabledFieldClass(); // Initialize the form

    incomingRoutes.initializeForm(); // Setup the dropdown for forwarding select with options

    $('.forwarding-select').dropdown(Extensions.getDropdownSettingsForRouting()); // Add double click listener to table cells

    $('.rule-row td').on('dblclick', function (e) {
      // When cell is double clicked, navigate to corresponding modify page
      var id = $(e.target).closest('tr').attr('id');
      window.location = "".concat(globalRootUrl, "incoming-routes/modify/").concat(id);
    });
  },

  /**
   * Callback to execute after dropping an element
   */
  cbOnDrop: function cbOnDrop() {
    var priorityWasChanged = false;
    var priorityData = {};
    $('.rule-row').each(function (index, obj) {
      var ruleId = $(obj).attr('id');
      var oldPriority = parseInt($(obj).attr('data-value'), 10);
      var newPriority = obj.rowIndex;

      if (oldPriority !== newPriority) {
        priorityWasChanged = true;
        priorityData[ruleId] = newPriority;
      }
    });

    if (priorityWasChanged) {
      $.api({
        on: 'now',
        url: "".concat(globalRootUrl, "incoming-routes/changePriority"),
        method: 'POST',
        data: priorityData
      });
    }
  },

  /**
   * Toggle class for disabled field based on dropdown selection
   */
  toggleDisabledFieldClass: function toggleDisabledFieldClass() {
    if (incomingRoutes.$formObj.form('get value', 'action') === 'extension') {
      $('#extension-group').show();
    } else {
      $('#extension-group').hide();
      $('#extension').dropdown('clear');
    }
  },

  /**
   * Callback function to be called before the form is sent
   * @param {Object} settings - The current settings of the form
   * @returns {Object} - The updated settings of the form
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = incomingRoutes.$formObj.form('get values');
    return result;
  },

  /**
   * Callback function to be called after the form has been sent.
   * @param {Object} response - The response from the server after the form is sent
   */
  cbAfterSendForm: function cbAfterSendForm(response) {},

  /**
   * Initialize the form with custom settings
   */
  initializeForm: function initializeForm() {
    Form.$formObj = incomingRoutes.$formObj;
    Form.url = "".concat(globalRootUrl, "incoming-routes/save"); // Form submission URL

    Form.validateRules = incomingRoutes.validateRules; // Form validation rules

    Form.cbBeforeSendForm = incomingRoutes.cbBeforeSendForm; // Callback before form is sent

    Form.cbAfterSendForm = incomingRoutes.cbAfterSendForm; // Callback after form is sent

    Form.initialize();
  }
};
/**
 * Form validation rule for checking if the 'extension' option is chosen and a number is selected.
 *
 * @param {string} value - The value to be checked
 * @returns {boolean} - Returns false if 'extension' is selected but no number is provided. Otherwise, returns true.
 */

$.fn.form.settings.rules.extensionRule = function (value) {
  // If 'extension' is selected and no number is provided (-1 or empty string), return false.
  if ($('#action').val() === 'extension' && (value === -1 || value === '')) {
    return false;
  } // If conditions aren't met, return true.


  return true;
};
/**
 *  Initialize incoming routes on document ready
 */


$(document).ready(function () {
  incomingRoutes.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9JbmNvbWluZ1JvdXRlcy9pbmNvbWluZy1yb3V0ZS1pbmRleC5qcyJdLCJuYW1lcyI6WyJpbmNvbWluZ1JvdXRlcyIsIiRmb3JtT2JqIiwiJCIsIiRhY3Rpb25Ecm9wZG93biIsInZhbGlkYXRlUnVsZXMiLCJleHRlbnNpb24iLCJpZGVudGlmaWVyIiwicnVsZXMiLCJ0eXBlIiwicHJvbXB0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiaXJfVmFsaWRhdGVGb3J3YXJkaW5nVG9CZUZpbGxlZCIsImluaXRpYWxpemUiLCJ0YWJsZURuRCIsIm9uRHJvcCIsImNiT25Ecm9wIiwib25EcmFnQ2xhc3MiLCJkcmFnSGFuZGxlIiwiZHJvcGRvd24iLCJvbkNoYW5nZSIsInRvZ2dsZURpc2FibGVkRmllbGRDbGFzcyIsImluaXRpYWxpemVGb3JtIiwiRXh0ZW5zaW9ucyIsImdldERyb3Bkb3duU2V0dGluZ3NGb3JSb3V0aW5nIiwib24iLCJlIiwiaWQiLCJ0YXJnZXQiLCJjbG9zZXN0IiwiYXR0ciIsIndpbmRvdyIsImxvY2F0aW9uIiwiZ2xvYmFsUm9vdFVybCIsInByaW9yaXR5V2FzQ2hhbmdlZCIsInByaW9yaXR5RGF0YSIsImVhY2giLCJpbmRleCIsIm9iaiIsInJ1bGVJZCIsIm9sZFByaW9yaXR5IiwicGFyc2VJbnQiLCJuZXdQcmlvcml0eSIsInJvd0luZGV4IiwiYXBpIiwidXJsIiwibWV0aG9kIiwiZGF0YSIsImZvcm0iLCJzaG93IiwiaGlkZSIsImNiQmVmb3JlU2VuZEZvcm0iLCJzZXR0aW5ncyIsInJlc3VsdCIsImNiQWZ0ZXJTZW5kRm9ybSIsInJlc3BvbnNlIiwiRm9ybSIsImZuIiwiZXh0ZW5zaW9uUnVsZSIsInZhbHVlIiwidmFsIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QUdzQzs7QUFDbkRtRCxJQUFBQSxJQUFJLENBQUNMLGdCQUFMLEdBQXdCbEQsY0FBYyxDQUFDa0QsZ0JBQXZDLENBSmEsQ0FJNEM7O0FBQ3pESyxJQUFBQSxJQUFJLENBQUNGLGVBQUwsR0FBdUJyRCxjQUFjLENBQUNxRCxlQUF0QyxDQUxhLENBSzBDOztBQUN2REUsSUFBQUEsSUFBSSxDQUFDM0MsVUFBTDtBQUNIO0FBN0hrQixDQUF2QjtBQWdJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBQ0FWLENBQUMsQ0FBQ3NELEVBQUYsQ0FBS1QsSUFBTCxDQUFVSSxRQUFWLENBQW1CNUMsS0FBbkIsQ0FBeUJrRCxhQUF6QixHQUF5QyxVQUFVQyxLQUFWLEVBQWlCO0FBQ3REO0FBQ0EsTUFBS3hELENBQUMsQ0FBQyxTQUFELENBQUQsQ0FBYXlELEdBQWIsT0FBdUIsV0FBeEIsS0FDQ0QsS0FBSyxLQUFLLENBQUMsQ0FBWCxJQUFnQkEsS0FBSyxLQUFLLEVBRDNCLENBQUosRUFDb0M7QUFDaEMsV0FBTyxLQUFQO0FBQ0gsR0FMcUQsQ0FPdEQ7OztBQUNBLFNBQU8sSUFBUDtBQUNILENBVEQ7QUFZQTtBQUNBO0FBQ0E7OztBQUNBeEQsQ0FBQyxDQUFDMEQsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQjdELEVBQUFBLGNBQWMsQ0FBQ1ksVUFBZjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCxnbG9iYWxUcmFuc2xhdGUsIEV4dGVuc2lvbnMsIEZvcm0gKi9cblxuXG4vKipcbiAqIE9iamVjdCBmb3IgbWFuYWdpbmcgaW5jb21pbmcgcm91dGVzIHRhYmxlXG4gKlxuICogQG1vZHVsZSBpbmNvbWluZ1JvdXRlc1xuICovXG5jb25zdCBpbmNvbWluZ1JvdXRlcyA9IHtcbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjZGVmYXVsdC1ydWxlLWZvcm0nKSxcblxuICAgICRhY3Rpb25Ecm9wZG93bjogJCgnI2FjdGlvbicpLFxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGlvbiBydWxlcyBmb3IgdGhlIGZvcm0gZmllbGRzIGJlZm9yZSBzdWJtaXNzaW9uLlxuICAgICAqXG4gICAgICogQHR5cGUge29iamVjdH1cbiAgICAgKi9cbiAgICB2YWxpZGF0ZVJ1bGVzOiB7XG4gICAgICAgIGV4dGVuc2lvbjoge1xuICAgICAgICAgICAgaWRlbnRpZmllcjogJ2V4dGVuc2lvbicsXG4gICAgICAgICAgICBydWxlczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2V4dGVuc2lvblJ1bGUnLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5pcl9WYWxpZGF0ZUZvcndhcmRpbmdUb0JlRmlsbGVkLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplIHRoZSBvYmplY3RcbiAgICAgKi9cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICAvLyBJbml0aWFsaXplIHRhYmxlIGRyYWctYW5kLWRyb3Agd2l0aCB0aGUgYXBwcm9wcmlhdGUgY2FsbGJhY2tzXG4gICAgICAgICQoJyNyb3V0aW5nVGFibGUnKS50YWJsZURuRCh7XG4gICAgICAgICAgICBvbkRyb3A6IGluY29taW5nUm91dGVzLmNiT25Ecm9wLCAvLyBDYWxsYmFjayBvbiBkcm9wcGluZyBhbiBpdGVtXG4gICAgICAgICAgICBvbkRyYWdDbGFzczogJ2hvdmVyaW5nUm93JywgLy8gQ1NTIGNsYXNzIHdoaWxlIGRyYWdnaW5nXG4gICAgICAgICAgICBkcmFnSGFuZGxlOiAnLmRyYWdIYW5kbGUnLCAgLy8gSGFuZGxlIGZvciBkcmFnZ2luZ1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTZXR1cCB0aGUgZHJvcGRvd24gd2l0aCBjYWxsYmFjayBvbiBjaGFuZ2VcbiAgICAgICAgaW5jb21pbmdSb3V0ZXMuJGFjdGlvbkRyb3Bkb3duLmRyb3Bkb3duKHtcbiAgICAgICAgICAgIG9uQ2hhbmdlOiBpbmNvbWluZ1JvdXRlcy50b2dnbGVEaXNhYmxlZEZpZWxkQ2xhc3NcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQXBwbHkgaW5pdGlhbCBjbGFzcyBjaGFuZ2UgYmFzZWQgb24gZHJvcGRvd24gc2VsZWN0aW9uXG4gICAgICAgIGluY29taW5nUm91dGVzLnRvZ2dsZURpc2FibGVkRmllbGRDbGFzcygpO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgdGhlIGZvcm1cbiAgICAgICAgaW5jb21pbmdSb3V0ZXMuaW5pdGlhbGl6ZUZvcm0oKTtcblxuICAgICAgICAvLyBTZXR1cCB0aGUgZHJvcGRvd24gZm9yIGZvcndhcmRpbmcgc2VsZWN0IHdpdGggb3B0aW9uc1xuICAgICAgICAkKCcuZm9yd2FyZGluZy1zZWxlY3QnKS5kcm9wZG93bihFeHRlbnNpb25zLmdldERyb3Bkb3duU2V0dGluZ3NGb3JSb3V0aW5nKCkpO1xuXG4gICAgICAgIC8vIEFkZCBkb3VibGUgY2xpY2sgbGlzdGVuZXIgdG8gdGFibGUgY2VsbHNcbiAgICAgICAgJCgnLnJ1bGUtcm93IHRkJykub24oJ2RibGNsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgIC8vIFdoZW4gY2VsbCBpcyBkb3VibGUgY2xpY2tlZCwgbmF2aWdhdGUgdG8gY29ycmVzcG9uZGluZyBtb2RpZnkgcGFnZVxuICAgICAgICAgICAgY29uc3QgaWQgPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCd0cicpLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfWluY29taW5nLXJvdXRlcy9tb2RpZnkvJHtpZH1gO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgdG8gZXhlY3V0ZSBhZnRlciBkcm9wcGluZyBhbiBlbGVtZW50XG4gICAgICovXG4gICAgY2JPbkRyb3AoKSB7XG4gICAgICAgIGxldCBwcmlvcml0eVdhc0NoYW5nZWQgPSBmYWxzZTtcbiAgICAgICAgY29uc3QgcHJpb3JpdHlEYXRhID0ge307XG4gICAgICAgICQoJy5ydWxlLXJvdycpLmVhY2goKGluZGV4LCBvYmopID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJ1bGVJZCA9ICQob2JqKS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgY29uc3Qgb2xkUHJpb3JpdHkgPSBwYXJzZUludCgkKG9iaikuYXR0cignZGF0YS12YWx1ZScpLCAxMCk7XG4gICAgICAgICAgICBjb25zdCBuZXdQcmlvcml0eSA9IG9iai5yb3dJbmRleDtcbiAgICAgICAgICAgIGlmIChvbGRQcmlvcml0eSAhPT0gbmV3UHJpb3JpdHkpIHtcbiAgICAgICAgICAgICAgICBwcmlvcml0eVdhc0NoYW5nZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHByaW9yaXR5RGF0YVtydWxlSWRdID0gbmV3UHJpb3JpdHk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAocHJpb3JpdHlXYXNDaGFuZ2VkKSB7XG4gICAgICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICAgICAgb246ICdub3cnLFxuICAgICAgICAgICAgICAgIHVybDogYCR7Z2xvYmFsUm9vdFVybH1pbmNvbWluZy1yb3V0ZXMvY2hhbmdlUHJpb3JpdHlgLFxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgICAgIGRhdGE6IHByaW9yaXR5RGF0YSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFRvZ2dsZSBjbGFzcyBmb3IgZGlzYWJsZWQgZmllbGQgYmFzZWQgb24gZHJvcGRvd24gc2VsZWN0aW9uXG4gICAgICovXG4gICAgdG9nZ2xlRGlzYWJsZWRGaWVsZENsYXNzKCkge1xuICAgICAgICBpZiAoaW5jb21pbmdSb3V0ZXMuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlJywgJ2FjdGlvbicpID09PSAnZXh0ZW5zaW9uJykge1xuICAgICAgICAgICAgJCgnI2V4dGVuc2lvbi1ncm91cCcpLnNob3coKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICQoJyNleHRlbnNpb24tZ3JvdXAnKS5oaWRlKCk7XG4gICAgICAgICAgICAkKCcjZXh0ZW5zaW9uJykuZHJvcGRvd24oJ2NsZWFyJyk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIGJlZm9yZSB0aGUgZm9ybSBpcyBzZW50XG4gICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gVGhlIGN1cnJlbnQgc2V0dGluZ3Mgb2YgdGhlIGZvcm1cbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIFRoZSB1cGRhdGVkIHNldHRpbmdzIG9mIHRoZSBmb3JtXG4gICAgICovXG4gICAgY2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncykge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBzZXR0aW5ncztcbiAgICAgICAgcmVzdWx0LmRhdGEgPSBpbmNvbWluZ1JvdXRlcy4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBhZnRlciB0aGUgZm9ybSBoYXMgYmVlbiBzZW50LlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgYWZ0ZXIgdGhlIGZvcm0gaXMgc2VudFxuICAgICAqL1xuICAgIGNiQWZ0ZXJTZW5kRm9ybShyZXNwb25zZSkge1xuXG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgdGhlIGZvcm0gd2l0aCBjdXN0b20gc2V0dGluZ3NcbiAgICAgKi9cbiAgICBpbml0aWFsaXplRm9ybSgpIHtcbiAgICAgICAgRm9ybS4kZm9ybU9iaiA9IGluY29taW5nUm91dGVzLiRmb3JtT2JqO1xuICAgICAgICBGb3JtLnVybCA9IGAke2dsb2JhbFJvb3RVcmx9aW5jb21pbmctcm91dGVzL3NhdmVgOyAvLyBGb3JtIHN1Ym1pc3Npb24gVVJMXG4gICAgICAgIEZvcm0udmFsaWRhdGVSdWxlcyA9IGluY29taW5nUm91dGVzLnZhbGlkYXRlUnVsZXM7IC8vIEZvcm0gdmFsaWRhdGlvbiBydWxlc1xuICAgICAgICBGb3JtLmNiQmVmb3JlU2VuZEZvcm0gPSBpbmNvbWluZ1JvdXRlcy5jYkJlZm9yZVNlbmRGb3JtOyAvLyBDYWxsYmFjayBiZWZvcmUgZm9ybSBpcyBzZW50XG4gICAgICAgIEZvcm0uY2JBZnRlclNlbmRGb3JtID0gaW5jb21pbmdSb3V0ZXMuY2JBZnRlclNlbmRGb3JtOyAvLyBDYWxsYmFjayBhZnRlciBmb3JtIGlzIHNlbnRcbiAgICAgICAgRm9ybS5pbml0aWFsaXplKCk7XG4gICAgfSxcbn07XG5cbi8qKlxuICogRm9ybSB2YWxpZGF0aW9uIHJ1bGUgZm9yIGNoZWNraW5nIGlmIHRoZSAnZXh0ZW5zaW9uJyBvcHRpb24gaXMgY2hvc2VuIGFuZCBhIG51bWJlciBpcyBzZWxlY3RlZC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgLSBUaGUgdmFsdWUgdG8gYmUgY2hlY2tlZFxuICogQHJldHVybnMge2Jvb2xlYW59IC0gUmV0dXJucyBmYWxzZSBpZiAnZXh0ZW5zaW9uJyBpcyBzZWxlY3RlZCBidXQgbm8gbnVtYmVyIGlzIHByb3ZpZGVkLiBPdGhlcndpc2UsIHJldHVybnMgdHJ1ZS5cbiAqL1xuJC5mbi5mb3JtLnNldHRpbmdzLnJ1bGVzLmV4dGVuc2lvblJ1bGUgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAvLyBJZiAnZXh0ZW5zaW9uJyBpcyBzZWxlY3RlZCBhbmQgbm8gbnVtYmVyIGlzIHByb3ZpZGVkICgtMSBvciBlbXB0eSBzdHJpbmcpLCByZXR1cm4gZmFsc2UuXG4gICAgaWYgKCgkKCcjYWN0aW9uJykudmFsKCkgPT09ICdleHRlbnNpb24nKSAmJlxuICAgICAgICAodmFsdWUgPT09IC0xIHx8IHZhbHVlID09PSAnJykpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIElmIGNvbmRpdGlvbnMgYXJlbid0IG1ldCwgcmV0dXJuIHRydWUuXG4gICAgcmV0dXJuIHRydWU7XG59O1xuXG5cbi8qKlxuICogIEluaXRpYWxpemUgaW5jb21pbmcgcm91dGVzIG9uIGRvY3VtZW50IHJlYWR5XG4gKi9cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBpbmNvbWluZ1JvdXRlcy5pbml0aWFsaXplKCk7XG59KTtcbiJdfQ==
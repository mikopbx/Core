"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global ace, PbxApi */
var updateLogViewWorker = {
  timeOut: 3000,
  timeOutHandle: '',
  errorCounts: 0,
  initialize: function initialize() {
    updateLogViewWorker.restartWorker();
  },
  restartWorker: function restartWorker() {
    window.clearTimeout(updateLogViewWorker.timeoutHandle);
    updateLogViewWorker.worker();
  },
  worker: function worker() {
    systemDiagnosticLogs.updateLogFromServer();
    updateLogViewWorker.timeoutHandle = window.setTimeout(updateLogViewWorker.worker, updateLogViewWorker.timeOut);
  },
  stop: function stop() {
    window.clearTimeout(updateLogViewWorker.timeoutHandle);
  }
};
var systemDiagnosticLogs = {
  $showBtn: $('#show-last-log'),
  $downloadBtn: $('#download-file'),
  $showAutoBtn: $('#show-last-log-auto'),
  $logContent: $('#log-content-readonly'),
  viewer: '',
  $fileSelectDropDown: $('#system-diagnostic-form .filenames-select'),
  logsItems: [],
  defaultLogItem: null,
  $dimmer: $('#get-logs-dimmer'),
  $formObj: $('#system-diagnostic-form'),
  $fileName: $('#system-diagnostic-form .filename'),
  initialize: function initialize() {
    var aceHeight = window.innerHeight - 250;
    systemDiagnosticLogs.$dimmer.closest('div').css('min-height', "".concat(aceHeight, "px"));
    systemDiagnosticLogs.$fileSelectDropDown.dropdown({
      values: systemDiagnosticLogs.logsItems,
      onChange: systemDiagnosticLogs.cbOnChangeFile,
      ignoreCase: true,
      fullTextSearch: true,
      forceSelection: false
    });
    systemDiagnosticLogs.initializeAce();
    PbxApi.SyslogGetLogsList(systemDiagnosticLogs.cbFormatDropdownResults);
    systemDiagnosticLogs.$showBtn.on('click', function (e) {
      e.preventDefault();
      systemDiagnosticLogs.updateLogFromServer();
    });
    systemDiagnosticLogs.$downloadBtn.on('click', function (e) {
      e.preventDefault();
      var data = systemDiagnosticLogs.$formObj.form('get values');
      PbxApi.SyslogDownloadLogFile(data.filename, systemDiagnosticLogs.cbDownloadFile);
    });
    systemDiagnosticLogs.$showAutoBtn.on('click', function (e) {
      e.preventDefault();
      var $reloadIcon = systemDiagnosticLogs.$showAutoBtn.find('i.refresh');

      if ($reloadIcon.hasClass('loading')) {
        $reloadIcon.removeClass('loading');
        updateLogViewWorker.stop();
      } else {
        $reloadIcon.addClass('loading');
        updateLogViewWorker.initialize();
      }
    });
    $('input').keyup(function (event) {
      if (event.keyCode === 13) {
        systemDiagnosticLogs.updateLogFromServer();
      }
    });
  },
  initializeAce: function initializeAce() {
    systemDiagnosticLogs.viewer = ace.edit('log-content-readonly');

    var julia = ace.require('ace/mode/julia');

    if (julia !== undefined) {
      var IniMode = julia.Mode;
      systemDiagnosticLogs.viewer.session.setMode(new IniMode());
    }

    systemDiagnosticLogs.viewer.setTheme('ace/theme/monokai');
    systemDiagnosticLogs.viewer.renderer.setShowGutter(false);
    systemDiagnosticLogs.viewer.setOptions({
      showLineNumbers: false,
      showPrintMargin: false,
      readOnly: true
    });
    $(window).load(function () {
      var aceHeight = window.innerHeight - systemDiagnosticLogs.$logContent.offset().top - 50;
      $('.log-content-readonly').css('min-height', "".concat(aceHeight, "px"));
      systemDiagnosticLogs.viewer.resize();
    });
  },

  /**
   * Makes formatted menu structure
   */
  cbFormatDropdownResults: function cbFormatDropdownResults(response) {
    if (response === false) {
      return;
    }

    var defVal = '';

    if (systemDiagnosticLogs.logsItems.length === 0 && $("#filename").val() !== '') {
      defVal = $("#filename").val().trim();
    }

    systemDiagnosticLogs.logsItems = [];
    var files = response.files;
    $.each(files, function (index, item) {
      if (defVal !== '') {
        item["default"] = defVal === item.path;
      }

      systemDiagnosticLogs.logsItems.push({
        name: "".concat(index, " (").concat(item.size, ")"),
        value: item.path,
        selected: item["default"]
      });
    });
    systemDiagnosticLogs.$fileSelectDropDown.dropdown('change values', systemDiagnosticLogs.logsItems);
  },

  /**
   * Callback after change log file in select
   * @param value
   */
  cbOnChangeFile: function cbOnChangeFile(value) {
    if (value.length === 0) {
      return;
    }

    systemDiagnosticLogs.$formObj.form('set value', 'filename', value);
    systemDiagnosticLogs.updateLogFromServer();
  },

  /**
   * Asks log file content from server
   */
  updateLogFromServer: function updateLogFromServer() {
    var params = systemDiagnosticLogs.$formObj.form('get values');
    PbxApi.SyslogGetLogFromFile(params, systemDiagnosticLogs.cbUpdateLogText);
  },

  /**
   * Updates log view
   * @param data
   */
  cbUpdateLogText: function cbUpdateLogText(data) {
    systemDiagnosticLogs.viewer.getSession().setValue(data.content);
    var row = systemDiagnosticLogs.viewer.session.getLength() - 1;
    var column = systemDiagnosticLogs.viewer.session.getLine(row).length; // or simply Infinity

    systemDiagnosticLogs.viewer.gotoLine(row + 1, column);
    systemDiagnosticLogs.$dimmer.removeClass('active');
  },

  /**
   * After push button download file
   * @param response
   */
  cbDownloadFile: function cbDownloadFile(response) {
    if (response !== false) {
      window.location = response.filename;
    }
  }
};
$(document).ready(function () {
  systemDiagnosticLogs.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TeXN0ZW1EaWFnbm9zdGljL3N5c3RlbS1kaWFnbm9zdGljLWluZGV4LXNob3dsb2dzLmpzIl0sIm5hbWVzIjpbInVwZGF0ZUxvZ1ZpZXdXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImVycm9yQ291bnRzIiwiaW5pdGlhbGl6ZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwic3lzdGVtRGlhZ25vc3RpY0xvZ3MiLCJ1cGRhdGVMb2dGcm9tU2VydmVyIiwic2V0VGltZW91dCIsInN0b3AiLCIkc2hvd0J0biIsIiQiLCIkZG93bmxvYWRCdG4iLCIkc2hvd0F1dG9CdG4iLCIkbG9nQ29udGVudCIsInZpZXdlciIsIiRmaWxlU2VsZWN0RHJvcERvd24iLCJsb2dzSXRlbXMiLCJkZWZhdWx0TG9nSXRlbSIsIiRkaW1tZXIiLCIkZm9ybU9iaiIsIiRmaWxlTmFtZSIsImFjZUhlaWdodCIsImlubmVySGVpZ2h0IiwiY2xvc2VzdCIsImNzcyIsImRyb3Bkb3duIiwidmFsdWVzIiwib25DaGFuZ2UiLCJjYk9uQ2hhbmdlRmlsZSIsImlnbm9yZUNhc2UiLCJmdWxsVGV4dFNlYXJjaCIsImZvcmNlU2VsZWN0aW9uIiwiaW5pdGlhbGl6ZUFjZSIsIlBieEFwaSIsIlN5c2xvZ0dldExvZ3NMaXN0IiwiY2JGb3JtYXREcm9wZG93blJlc3VsdHMiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImRhdGEiLCJmb3JtIiwiU3lzbG9nRG93bmxvYWRMb2dGaWxlIiwiZmlsZW5hbWUiLCJjYkRvd25sb2FkRmlsZSIsIiRyZWxvYWRJY29uIiwiZmluZCIsImhhc0NsYXNzIiwicmVtb3ZlQ2xhc3MiLCJhZGRDbGFzcyIsImtleXVwIiwiZXZlbnQiLCJrZXlDb2RlIiwiYWNlIiwiZWRpdCIsImp1bGlhIiwicmVxdWlyZSIsInVuZGVmaW5lZCIsIkluaU1vZGUiLCJNb2RlIiwic2Vzc2lvbiIsInNldE1vZGUiLCJzZXRUaGVtZSIsInJlbmRlcmVyIiwic2V0U2hvd0d1dHRlciIsInNldE9wdGlvbnMiLCJzaG93TGluZU51bWJlcnMiLCJzaG93UHJpbnRNYXJnaW4iLCJyZWFkT25seSIsImxvYWQiLCJvZmZzZXQiLCJ0b3AiLCJyZXNpemUiLCJyZXNwb25zZSIsImRlZlZhbCIsImxlbmd0aCIsInZhbCIsInRyaW0iLCJmaWxlcyIsImVhY2giLCJpbmRleCIsIml0ZW0iLCJwYXRoIiwicHVzaCIsIm5hbWUiLCJzaXplIiwidmFsdWUiLCJzZWxlY3RlZCIsInBhcmFtcyIsIlN5c2xvZ0dldExvZ0Zyb21GaWxlIiwiY2JVcGRhdGVMb2dUZXh0IiwiZ2V0U2Vzc2lvbiIsInNldFZhbHVlIiwiY29udGVudCIsInJvdyIsImdldExlbmd0aCIsImNvbHVtbiIsImdldExpbmUiLCJnb3RvTGluZSIsImxvY2F0aW9uIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNBO0FBR0EsSUFBTUEsbUJBQW1CLEdBQUc7QUFDM0JDLEVBQUFBLE9BQU8sRUFBRSxJQURrQjtBQUUzQkMsRUFBQUEsYUFBYSxFQUFFLEVBRlk7QUFHM0JDLEVBQUFBLFdBQVcsRUFBRSxDQUhjO0FBSTNCQyxFQUFBQSxVQUoyQix3QkFJZDtBQUNaSixJQUFBQSxtQkFBbUIsQ0FBQ0ssYUFBcEI7QUFDQSxHQU4wQjtBQU8zQkEsRUFBQUEsYUFQMkIsMkJBT1g7QUFDZkMsSUFBQUEsTUFBTSxDQUFDQyxZQUFQLENBQW9CUCxtQkFBbUIsQ0FBQ1EsYUFBeEM7QUFDQVIsSUFBQUEsbUJBQW1CLENBQUNTLE1BQXBCO0FBQ0EsR0FWMEI7QUFXM0JBLEVBQUFBLE1BWDJCLG9CQVdsQjtBQUNSQyxJQUFBQSxvQkFBb0IsQ0FBQ0MsbUJBQXJCO0FBQ0FYLElBQUFB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QixDQUFDUyxNQUFyQixDQUE0QjRFLFVBQTVCLEdBQXlDQyxRQUF6QyxDQUFrRHBELElBQUksQ0FBQ3FELE9BQXZEO0FBQ0EsUUFBTUMsR0FBRyxHQUFHeEYsb0JBQW9CLENBQUNTLE1BQXJCLENBQTRCNkMsT0FBNUIsQ0FBb0NtQyxTQUFwQyxLQUFrRCxDQUE5RDtBQUNBLFFBQU1DLE1BQU0sR0FBRzFGLG9CQUFvQixDQUFDUyxNQUFyQixDQUE0QjZDLE9BQTVCLENBQW9DcUMsT0FBcEMsQ0FBNENILEdBQTVDLEVBQWlEbkIsTUFBaEUsQ0FIcUIsQ0FHbUQ7O0FBQ3hFckUsSUFBQUEsb0JBQW9CLENBQUNTLE1BQXJCLENBQTRCbUYsUUFBNUIsQ0FBcUNKLEdBQUcsR0FBRyxDQUEzQyxFQUE4Q0UsTUFBOUM7QUFDQTFGLElBQUFBLG9CQUFvQixDQUFDYSxPQUFyQixDQUE2QjZCLFdBQTdCLENBQXlDLFFBQXpDO0FBQ0EsR0FySTJCOztBQXNJNUI7QUFDRDtBQUNBO0FBQ0E7QUFDQ0osRUFBQUEsY0ExSTRCLDBCQTBJYjZCLFFBMUlhLEVBMElKO0FBQ3ZCLFFBQUlBLFFBQVEsS0FBRyxLQUFmLEVBQXFCO0FBQ3BCdkUsTUFBQUEsTUFBTSxDQUFDaUcsUUFBUCxHQUFrQjFCLFFBQVEsQ0FBQzlCLFFBQTNCO0FBQ0E7QUFDRDtBQTlJMkIsQ0FBN0I7QUFpSkFoQyxDQUFDLENBQUN5RixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCL0YsRUFBQUEsb0JBQW9CLENBQUNOLFVBQXJCO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMCBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuLyogZ2xvYmFsIGFjZSwgUGJ4QXBpICovXG5cblxuY29uc3QgdXBkYXRlTG9nVmlld1dvcmtlciA9IHtcblx0dGltZU91dDogMzAwMCxcblx0dGltZU91dEhhbmRsZTogJycsXG5cdGVycm9yQ291bnRzOiAwLFxuXHRpbml0aWFsaXplKCkge1xuXHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuXHR9LFxuXHRyZXN0YXJ0V29ya2VyKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQodXBkYXRlTG9nVmlld1dvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLndvcmtlcigpO1xuXHR9LFxuXHR3b3JrZXIoKSB7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuXHRcdFx0dXBkYXRlTG9nVmlld1dvcmtlci53b3JrZXIsXG5cdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLnRpbWVPdXQsXG5cdFx0KTtcblx0fSxcblx0c3RvcCgpIHtcblx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZGF0ZUxvZ1ZpZXdXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdH1cbn07XG5cbmNvbnN0IHN5c3RlbURpYWdub3N0aWNMb2dzID0ge1xuXHQkc2hvd0J0bjogJCgnI3Nob3ctbGFzdC1sb2cnKSxcblx0JGRvd25sb2FkQnRuOiAkKCcjZG93bmxvYWQtZmlsZScpLFxuXHQkc2hvd0F1dG9CdG46ICQoJyNzaG93LWxhc3QtbG9nLWF1dG8nKSxcblx0JGxvZ0NvbnRlbnQ6ICQoJyNsb2ctY29udGVudC1yZWFkb25seScpLFxuXHR2aWV3ZXI6ICcnLFxuXHQkZmlsZVNlbGVjdERyb3BEb3duOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybSAuZmlsZW5hbWVzLXNlbGVjdCcpLFxuXHRsb2dzSXRlbXM6IFtdLFxuXHRkZWZhdWx0TG9nSXRlbTogbnVsbCxcblx0JGRpbW1lcjogJCgnI2dldC1sb2dzLWRpbW1lcicpLFxuXHQkZm9ybU9iajogJCgnI3N5c3RlbS1kaWFnbm9zdGljLWZvcm0nKSxcblx0JGZpbGVOYW1lOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybSAuZmlsZW5hbWUnKSxcblx0aW5pdGlhbGl6ZSgpIHtcblx0XHRjb25zdCBhY2VIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQtMjUwO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRkaW1tZXIuY2xvc2VzdCgnZGl2JykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZpbGVTZWxlY3REcm9wRG93bi5kcm9wZG93bihcblx0XHRcdHtcblx0XHRcdFx0dmFsdWVzOiBzeXN0ZW1EaWFnbm9zdGljTG9ncy5sb2dzSXRlbXMsXG5cdFx0XHRcdG9uQ2hhbmdlOiBzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYk9uQ2hhbmdlRmlsZSxcblx0XHRcdFx0aWdub3JlQ2FzZTogdHJ1ZSxcblx0XHRcdFx0ZnVsbFRleHRTZWFyY2g6IHRydWUsXG5cdFx0XHRcdGZvcmNlU2VsZWN0aW9uOiBmYWxzZSxcblx0XHRcdH1cblx0XHQpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLmluaXRpYWxpemVBY2UoKTtcblx0XHRQYnhBcGkuU3lzbG9nR2V0TG9nc0xpc3Qoc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JGb3JtYXREcm9wZG93blJlc3VsdHMpO1xuXG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJHNob3dCdG4ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKTtcblx0XHR9KTtcblxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRkb3dubG9hZEJ0bi5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0Y29uc3QgZGF0YSA9IHN5c3RlbURpYWdub3N0aWNMb2dzLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcblx0XHRcdFBieEFwaS5TeXNsb2dEb3dubG9hZExvZ0ZpbGUoZGF0YS5maWxlbmFtZSwgc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JEb3dubG9hZEZpbGUpO1xuXHRcdH0pO1xuXG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJHNob3dBdXRvQnRuLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRjb25zdCAkcmVsb2FkSWNvbiA9IHN5c3RlbURpYWdub3N0aWNMb2dzLiRzaG93QXV0b0J0bi5maW5kKCdpLnJlZnJlc2gnKTtcblx0XHRcdGlmICgkcmVsb2FkSWNvbi5oYXNDbGFzcygnbG9hZGluZycpKXtcblx0XHRcdFx0JHJlbG9hZEljb24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0dXBkYXRlTG9nVmlld1dvcmtlci5zdG9wKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQkcmVsb2FkSWNvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLmluaXRpYWxpemUoKTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHQkKCdpbnB1dCcpLmtleXVwKChldmVudCk9PiB7XG5cdFx0XHRpZiAoZXZlbnQua2V5Q29kZSA9PT0gMTMpIHtcblx0XHRcdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9LFxuXHRpbml0aWFsaXplQWNlKCkge1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlciA9IGFjZS5lZGl0KCdsb2ctY29udGVudC1yZWFkb25seScpO1xuXG5cdFx0Y29uc3QganVsaWEgPSBhY2UucmVxdWlyZSgnYWNlL21vZGUvanVsaWEnKTtcblx0XHRpZiAoanVsaWEhPT11bmRlZmluZWQpe1xuXHRcdFx0Y29uc3QgSW5pTW9kZSA9IGp1bGlhLk1vZGU7XG5cdFx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2Vzc2lvbi5zZXRNb2RlKG5ldyBJbmlNb2RlKCkpO1xuXHRcdH1cblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2V0VGhlbWUoJ2FjZS90aGVtZS9tb25va2FpJyk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnJlbmRlcmVyLnNldFNob3dHdXR0ZXIoZmFsc2UpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXRPcHRpb25zKHtcblx0XHRcdHNob3dMaW5lTnVtYmVyczpmYWxzZSxcblx0XHRcdHNob3dQcmludE1hcmdpbjogZmFsc2UsXG5cdFx0XHRyZWFkT25seTogdHJ1ZSxcblx0XHR9KTtcblx0XHQkKHdpbmRvdykubG9hZChmdW5jdGlvbigpIHtcblx0XHRcdGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodC1zeXN0ZW1EaWFnbm9zdGljTG9ncy4kbG9nQ29udGVudC5vZmZzZXQoKS50b3AtNTA7XG5cdFx0XHQkKCcubG9nLWNvbnRlbnQtcmVhZG9ubHknKS5jc3MoJ21pbi1oZWlnaHQnLCBgJHthY2VIZWlnaHR9cHhgKTtcblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5yZXNpemUoKTtcblx0XHR9KTtcblx0fSxcblx0LyoqXG5cdCAqIE1ha2VzIGZvcm1hdHRlZCBtZW51IHN0cnVjdHVyZVxuXHQgKi9cblx0Y2JGb3JtYXREcm9wZG93blJlc3VsdHMocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2UgPT09ZmFsc2Upe1xuXHRcdFx0cmV0dXJuIDtcblx0XHR9XG5cblx0XHRsZXQgZGVmVmFsID0gJyc7XG5cdFx0aWYoc3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zLmxlbmd0aCA9PT0gMCAmJiAkKFwiI2ZpbGVuYW1lXCIpLnZhbCgpICE9PSAnJyl7XG5cdFx0XHRkZWZWYWwgPSAkKFwiI2ZpbGVuYW1lXCIpLnZhbCgpLnRyaW0oKTtcblx0XHR9XG5cblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy5sb2dzSXRlbXMgPSBbXTtcblx0XHRjb25zdCBmaWxlcyA9IHJlc3BvbnNlLmZpbGVzO1xuXHRcdCQuZWFjaChmaWxlcywgKGluZGV4LCBpdGVtKSA9PiB7XG5cblx0XHRcdGlmKGRlZlZhbCAhPT0gJycpe1xuXHRcdFx0XHRpdGVtLmRlZmF1bHQgPSAoZGVmVmFsID09PSBpdGVtLnBhdGgpO1xuXHRcdFx0fVxuXG5cdFx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy5sb2dzSXRlbXMucHVzaCh7XG5cdFx0XHRcdG5hbWU6IGAke2luZGV4fSAoJHtpdGVtLnNpemV9KWAsXG5cdFx0XHRcdHZhbHVlOiBpdGVtLnBhdGgsXG5cdFx0XHRcdHNlbGVjdGVkOiBpdGVtLmRlZmF1bHRcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRmaWxlU2VsZWN0RHJvcERvd24uZHJvcGRvd24oJ2NoYW5nZSB2YWx1ZXMnLCBzeXN0ZW1EaWFnbm9zdGljTG9ncy5sb2dzSXRlbXMpO1xuXHR9LFxuXHQvKipcblx0ICogQ2FsbGJhY2sgYWZ0ZXIgY2hhbmdlIGxvZyBmaWxlIGluIHNlbGVjdFxuXHQgKiBAcGFyYW0gdmFsdWVcblx0ICovXG5cdGNiT25DaGFuZ2VGaWxlKHZhbHVlKSB7XG5cdFx0aWYgKHZhbHVlLmxlbmd0aD09PTApe1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZm9ybU9iai5mb3JtKCdzZXQgdmFsdWUnLCAnZmlsZW5hbWUnLCB2YWx1ZSk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHR9LFxuXHQvKipcblx0ICogQXNrcyBsb2cgZmlsZSBjb250ZW50IGZyb20gc2VydmVyXG5cdCAqL1xuXHR1cGRhdGVMb2dGcm9tU2VydmVyKCl7XG5cdFx0Y29uc3QgcGFyYW1zID0gc3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlcycpO1xuXHRcdFBieEFwaS5TeXNsb2dHZXRMb2dGcm9tRmlsZShwYXJhbXMsIHN5c3RlbURpYWdub3N0aWNMb2dzLmNiVXBkYXRlTG9nVGV4dCk7XG5cdH0sXG5cdC8qKlxuXHQgKiBVcGRhdGVzIGxvZyB2aWV3XG5cdCAqIEBwYXJhbSBkYXRhXG5cdCAqL1xuXHRjYlVwZGF0ZUxvZ1RleHQoZGF0YSkge1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUoZGF0YS5jb250ZW50KTtcblx0XHRjb25zdCByb3cgPSBzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2Vzc2lvbi5nZXRMZW5ndGgoKSAtIDE7XG5cdFx0Y29uc3QgY29sdW1uID0gc3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnNlc3Npb24uZ2V0TGluZShyb3cpLmxlbmd0aDsgLy8gb3Igc2ltcGx5IEluZmluaXR5XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLmdvdG9MaW5lKHJvdyArIDEsIGNvbHVtbik7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGRpbW1lci5yZW1vdmVDbGFzcygnYWN0aXZlJyk7XG5cdH0sXG5cdC8qKlxuXHQgKiBBZnRlciBwdXNoIGJ1dHRvbiBkb3dubG9hZCBmaWxlXG5cdCAqIEBwYXJhbSByZXNwb25zZVxuXHQgKi9cblx0Y2JEb3dubG9hZEZpbGUocmVzcG9uc2Upe1xuXHRcdGlmIChyZXNwb25zZSE9PWZhbHNlKXtcblx0XHRcdHdpbmRvdy5sb2NhdGlvbiA9IHJlc3BvbnNlLmZpbGVuYW1lO1xuXHRcdH1cblx0fSxcbn07XG5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcblx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuaW5pdGlhbGl6ZSgpO1xufSk7XG5cbiJdfQ==
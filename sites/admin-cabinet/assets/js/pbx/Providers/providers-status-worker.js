"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/** global: DebuggerInfo, sessionStorage, PbxApi */

/**
 * Object representing the provider status loop worker.
 *
 * @module providersStatusLoopWorker
 */
var providersStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status request.
   * @type {number}
   */
  timeOut: 3000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * Object to store provider statuses.
   * @type {Object}
   */
  providerStatuses: {},

  /**
   * Initializes the provider status loop worker.
   */
  initialize: function initialize() {
    DebuggerInfo.initialize();
    var previousStatuses = sessionStorage.getItem('ProviderStatuses');

    if (previousStatuses !== null) {
      providersStatusLoopWorker.providerStatuses = JSON.parse(previousStatuses);
    }

    providersStatusLoopWorker.restartWorker();
  },

  /**
   * Restarts the status worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(providersStatusLoopWorker.timeoutHandle);
    providersStatusLoopWorker.worker();
  },

  /**
   * Executes the status worker.
   */
  worker: function worker() {
    window.clearTimeout(providersStatusLoopWorker.timeoutHandle);
    PbxApi.GetSipProvidersStatuses(providersStatusLoopWorker.cbRefreshProvidersStatus);
    PbxApi.GetIaxProvidersStatuses(providersStatusLoopWorker.cbRefreshProvidersStatus);
  },

  /**
   * Callback function to accumulate provider statuses.
   * @param {Array} response - Response containing provider statuses.
   */
  cbRefreshProvidersStatus: function cbRefreshProvidersStatus(response) {
    providersStatusLoopWorker.timeoutHandle = window.setTimeout(providersStatusLoopWorker.worker, providersStatusLoopWorker.timeOut);
    if (response.length === 0 || response === false) return;
    $.each(response, function (key, value) {
      if (value.state !== undefined) {
        providersStatusLoopWorker.providerStatuses[value.id] = value.state.toUpperCase();
      }
    });
    sessionStorage.setItem('ProviderStatuses', JSON.stringify(providersStatusLoopWorker.providerStatuses));
    providersStatusLoopWorker.refreshVisualisation();
  },

  /**
   * Refreshes the visualization of provider statuses.
   */
  refreshVisualisation: function refreshVisualisation() {
    // Iterate over the response data and create HTML table rows for each provider status
    // to shows it on debug slider by double press esc button
    var htmlTable = '<table class="ui very compact table">';
    $.each(providersStatusLoopWorker.providerStatuses, function (key, value) {
      htmlTable += '<tr>';
      htmlTable += "<td>".concat(key, "</td>");
      htmlTable += "<td>".concat(value, "</td>");
      htmlTable += '</tr>';
    });
    htmlTable += '</table>';
    DebuggerInfo.UpdateContent(htmlTable); // Define label styles for different statuses

    var green = '<div class="ui green empty circular label" style="width: 1px;height: 1px;"></div>';
    var grey = '<div class="ui grey empty circular label" style="width: 1px;height: 1px;"></div>';
    var yellow = '<div class="ui yellow empty circular label" style="width: 1px;height: 1px;"></div>'; // Update provider status and failure information in the UI

    $('tr.provider-row').each(function (index, obj) {
      var uniqid = $(obj).attr('id');

      if (providersStatusLoopWorker.providerStatuses[uniqid] !== undefined) {
        switch (providersStatusLoopWorker.providerStatuses[uniqid]) {
          case 'REGISTERED':
            $(obj).find('.provider-status').html(green);
            $(obj).find('.failure').text('');
            break;

          case 'OK':
            $(obj).find('.provider-status').html(yellow);
            $(obj).find('.failure').text('');
            break;

          case 'OFF':
            $(obj).find('.provider-status').html(grey);
            $(obj).find('.failure').text('');
            break;

          default:
            $(obj).find('.provider-status').html(grey);
            $(obj).find('.failure').text(providersStatusLoopWorker.providerStatuses[uniqid]);
            break;
        }
      } else {
        $(obj).find('.provider-status').html(grey);
      }
    });
  }
};
/**
 *  Initialize providers status worker on document ready
 */

$(document).ready(function () {
  providersStatusLoopWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Qcm92aWRlcnMvcHJvdmlkZXJzLXN0YXR1cy13b3JrZXIuanMiXSwibmFtZXMiOlsicHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwicHJvdmlkZXJTdGF0dXNlcyIsImluaXRpYWxpemUiLCJEZWJ1Z2dlckluZm8iLCJwcmV2aW91c1N0YXR1c2VzIiwic2Vzc2lvblN0b3JhZ2UiLCJnZXRJdGVtIiwiSlNPTiIsInBhcnNlIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJQYnhBcGkiLCJHZXRTaXBQcm92aWRlcnNTdGF0dXNlcyIsImNiUmVmcmVzaFByb3ZpZGVyc1N0YXR1cyIsIkdldElheFByb3ZpZGVyc1N0YXR1c2VzIiwicmVzcG9uc2UiLCJzZXRUaW1lb3V0IiwibGVuZ3RoIiwiJCIsImVhY2giLCJrZXkiLCJ2YWx1ZSIsInN0YXRlIiwidW5kZWZpbmVkIiwiaWQiLCJ0b1VwcGVyQ2FzZSIsInNldEl0ZW0iLCJzdHJpbmdpZnkiLCJyZWZyZXNoVmlzdWFsaXNhdGlvbiIsImh0bWxUYWJsZSIsIlVwZGF0ZUNvbnRlbnQiLCJncmVlbiIsImdyZXkiLCJ5ZWxsb3ciLCJpbmRleCIsIm9iaiIsInVuaXFpZCIsImF0dHIiLCJmaW5kIiwiaHRtbCIsInRleHQiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHlCQUF5QixHQUFHO0FBRTlCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLE9BQU8sRUFBRSxJQU5xQjs7QUFROUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEs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LENBQU9HLElBQVAsQ0FBWSxrQkFBWixFQUFnQ0MsSUFBaEMsQ0FBcUNQLElBQXJDO0FBQ0FkLFlBQUFBLENBQUMsQ0FBQ2lCLEdBQUQsQ0FBRCxDQUFPRyxJQUFQLENBQVksVUFBWixFQUF3QkUsSUFBeEIsQ0FBNkI3Qyx5QkFBeUIsQ0FBQ0csZ0JBQTFCLENBQTJDc0MsTUFBM0MsQ0FBN0I7QUFDQTtBQWhCUjtBQWtCSCxPQW5CRCxNQW1CTztBQUNIbEIsUUFBQUEsQ0FBQyxDQUFDaUIsR0FBRCxDQUFELENBQU9HLElBQVAsQ0FBWSxrQkFBWixFQUFnQ0MsSUFBaEMsQ0FBcUNQLElBQXJDO0FBQ0g7QUFDSixLQXhCRDtBQXlCSDtBQW5INkIsQ0FBbEM7QUFzSEE7QUFDQTtBQUNBOztBQUNBZCxDQUFDLENBQUN1QixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCL0MsRUFBQUEseUJBQXlCLENBQUNJLFVBQTFCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qKiBnbG9iYWw6IERlYnVnZ2VySW5mbywgc2Vzc2lvblN0b3JhZ2UsIFBieEFwaSAqL1xuXG4vKipcbiAqIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIHByb3ZpZGVyIHN0YXR1cyBsb29wIHdvcmtlci5cbiAqXG4gKiBAbW9kdWxlIHByb3ZpZGVyc1N0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgcHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgc3RhdHVzIHJlcXVlc3QuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0OiAzMDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3IgdGhlIHN0YXR1cyB3b3JrZXIuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0SGFuZGxlOiAwLFxuXG4gICAgLyoqXG4gICAgICogT2JqZWN0IHRvIHN0b3JlIHByb3ZpZGVyIHN0YXR1c2VzLlxuICAgICAqIEB0eXBlIHtPYmplY3R9XG4gICAgICovXG4gICAgcHJvdmlkZXJTdGF0dXNlczoge30sXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgcHJvdmlkZXIgc3RhdHVzIGxvb3Agd29ya2VyLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIERlYnVnZ2VySW5mby5pbml0aWFsaXplKCk7XG5cbiAgICAgICAgY29uc3QgcHJldmlvdXNTdGF0dXNlcyA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oJ1Byb3ZpZGVyU3RhdHVzZXMnKTtcbiAgICAgICAgaWYgKHByZXZpb3VzU3RhdHVzZXMgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHByb3ZpZGVyc1N0YXR1c0xvb3BXb3JrZXIucHJvdmlkZXJTdGF0dXNlcyA9IEpTT04ucGFyc2UocHJldmlvdXNTdGF0dXNlcyk7XG4gICAgICAgIH1cbiAgICAgICAgcHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSBzdGF0dXMgd29ya2VyLlxuICAgICAqL1xuICAgIHJlc3RhcnRXb3JrZXIoKSB7XG4gICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQocHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgcHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci53b3JrZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRXhlY3V0ZXMgdGhlIHN0YXR1cyB3b3JrZXIuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHByb3ZpZGVyc1N0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIFBieEFwaS5HZXRTaXBQcm92aWRlcnNTdGF0dXNlcyhwcm92aWRlcnNTdGF0dXNMb29wV29ya2VyLmNiUmVmcmVzaFByb3ZpZGVyc1N0YXR1cyk7XG4gICAgICAgIFBieEFwaS5HZXRJYXhQcm92aWRlcnNTdGF0dXNlcyhwcm92aWRlcnNTdGF0dXNMb29wV29ya2VyLmNiUmVmcmVzaFByb3ZpZGVyc1N0YXR1cyk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIGFjY3VtdWxhdGUgcHJvdmlkZXIgc3RhdHVzZXMuXG4gICAgICogQHBhcmFtIHtBcnJheX0gcmVzcG9uc2UgLSBSZXNwb25zZSBjb250YWluaW5nIHByb3ZpZGVyIHN0YXR1c2VzLlxuICAgICAqL1xuICAgIGNiUmVmcmVzaFByb3ZpZGVyc1N0YXR1cyhyZXNwb25zZSkge1xuICAgICAgICBwcm92aWRlcnNTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUgPVxuICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQocHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci53b3JrZXIsIHByb3ZpZGVyc1N0YXR1c0xvb3BXb3JrZXIudGltZU91dCk7XG4gICAgICAgIGlmIChyZXNwb25zZS5sZW5ndGggPT09IDAgfHwgcmVzcG9uc2UgPT09IGZhbHNlKSByZXR1cm47XG4gICAgICAgICQuZWFjaChyZXNwb25zZSwgKGtleSwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS5zdGF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci5wcm92aWRlclN0YXR1c2VzW3ZhbHVlLmlkXSA9IHZhbHVlLnN0YXRlLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdQcm92aWRlclN0YXR1c2VzJywgSlNPTi5zdHJpbmdpZnkocHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci5wcm92aWRlclN0YXR1c2VzKSk7XG4gICAgICAgIHByb3ZpZGVyc1N0YXR1c0xvb3BXb3JrZXIucmVmcmVzaFZpc3VhbGlzYXRpb24oKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVmcmVzaGVzIHRoZSB2aXN1YWxpemF0aW9uIG9mIHByb3ZpZGVyIHN0YXR1c2VzLlxuICAgICAqL1xuICAgIHJlZnJlc2hWaXN1YWxpc2F0aW9uKCkge1xuXG4gICAgICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgcmVzcG9uc2UgZGF0YSBhbmQgY3JlYXRlIEhUTUwgdGFibGUgcm93cyBmb3IgZWFjaCBwcm92aWRlciBzdGF0dXNcbiAgICAgICAgLy8gdG8gc2hvd3MgaXQgb24gZGVidWcgc2xpZGVyIGJ5IGRvdWJsZSBwcmVzcyBlc2MgYnV0dG9uXG4gICAgICAgIGxldCBodG1sVGFibGUgPSAnPHRhYmxlIGNsYXNzPVwidWkgdmVyeSBjb21wYWN0IHRhYmxlXCI+JztcbiAgICAgICAgJC5lYWNoKHByb3ZpZGVyc1N0YXR1c0xvb3BXb3JrZXIucHJvdmlkZXJTdGF0dXNlcywgKGtleSwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgIGh0bWxUYWJsZSArPSAnPHRyPic7XG4gICAgICAgICAgICBodG1sVGFibGUgKz0gYDx0ZD4ke2tleX08L3RkPmA7XG4gICAgICAgICAgICBodG1sVGFibGUgKz0gYDx0ZD4ke3ZhbHVlfTwvdGQ+YDtcbiAgICAgICAgICAgIGh0bWxUYWJsZSArPSAnPC90cj4nO1xuICAgICAgICB9KTtcbiAgICAgICAgaHRtbFRhYmxlICs9ICc8L3RhYmxlPic7XG4gICAgICAgIERlYnVnZ2VySW5mby5VcGRhdGVDb250ZW50KGh0bWxUYWJsZSk7XG5cbiAgICAgICAgLy8gRGVmaW5lIGxhYmVsIHN0eWxlcyBmb3IgZGlmZmVyZW50IHN0YXR1c2VzXG4gICAgICAgIGNvbnN0IGdyZWVuID0gJzxkaXYgY2xhc3M9XCJ1aSBncmVlbiBlbXB0eSBjaXJjdWxhciBsYWJlbFwiIHN0eWxlPVwid2lkdGg6IDFweDtoZWlnaHQ6IDFweDtcIj48L2Rpdj4nO1xuICAgICAgICBjb25zdCBncmV5ID0gJzxkaXYgY2xhc3M9XCJ1aSBncmV5IGVtcHR5IGNpcmN1bGFyIGxhYmVsXCIgc3R5bGU9XCJ3aWR0aDogMXB4O2hlaWdodDogMXB4O1wiPjwvZGl2Pic7XG4gICAgICAgIGNvbnN0IHllbGxvdyA9ICc8ZGl2IGNsYXNzPVwidWkgeWVsbG93IGVtcHR5IGNpcmN1bGFyIGxhYmVsXCIgc3R5bGU9XCJ3aWR0aDogMXB4O2hlaWdodDogMXB4O1wiPjwvZGl2Pic7XG5cbiAgICAgICAgLy8gVXBkYXRlIHByb3ZpZGVyIHN0YXR1cyBhbmQgZmFpbHVyZSBpbmZvcm1hdGlvbiBpbiB0aGUgVUlcbiAgICAgICAgJCgndHIucHJvdmlkZXItcm93JykuZWFjaCgoaW5kZXgsIG9iaikgPT4ge1xuICAgICAgICAgICAgY29uc3QgdW5pcWlkID0gJChvYmopLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICBpZiAocHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci5wcm92aWRlclN0YXR1c2VzW3VuaXFpZF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci5wcm92aWRlclN0YXR1c2VzW3VuaXFpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkVHSVNURVJFRCc6XG4gICAgICAgICAgICAgICAgICAgICAgICAkKG9iaikuZmluZCgnLnByb3ZpZGVyLXN0YXR1cycpLmh0bWwoZ3JlZW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChvYmopLmZpbmQoJy5mYWlsdXJlJykudGV4dCgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnT0snOlxuICAgICAgICAgICAgICAgICAgICAgICAgJChvYmopLmZpbmQoJy5wcm92aWRlci1zdGF0dXMnKS5odG1sKHllbGxvdyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKG9iaikuZmluZCgnLmZhaWx1cmUnKS50ZXh0KCcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdPRkYnOlxuICAgICAgICAgICAgICAgICAgICAgICAgJChvYmopLmZpbmQoJy5wcm92aWRlci1zdGF0dXMnKS5odG1sKGdyZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChvYmopLmZpbmQoJy5mYWlsdXJlJykudGV4dCgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgICQob2JqKS5maW5kKCcucHJvdmlkZXItc3RhdHVzJykuaHRtbChncmV5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQob2JqKS5maW5kKCcuZmFpbHVyZScpLnRleHQocHJvdmlkZXJzU3RhdHVzTG9vcFdvcmtlci5wcm92aWRlclN0YXR1c2VzW3VuaXFpZF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAkKG9iaikuZmluZCgnLnByb3ZpZGVyLXN0YXR1cycpLmh0bWwoZ3JleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sXG59O1xuXG4vKipcbiAqICBJbml0aWFsaXplIHByb3ZpZGVycyBzdGF0dXMgd29ya2VyIG9uIGRvY3VtZW50IHJlYWR5XG4gKi9cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBwcm92aWRlcnNTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemUoKTtcbn0pOyJdfQ==